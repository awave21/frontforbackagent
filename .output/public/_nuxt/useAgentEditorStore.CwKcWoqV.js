import{c1 as Ze,L as k,k as l,bg as j,c4 as et,z as tt,f as re}from"./entry.B2IFVgKF.js";import{u as at}from"./useAgents.CrbTyjJz.js";import{u as me,a as st,g as y}from"./useApiFetch.DTQFO30A.js";import{u as Ae}from"./useAuth.Vyp_2ZYp.js";import{g as rt}from"./authSessionManager.DTJsKR5D.js";import{w as de}from"./index.CXSSBYp8.js";const Ee={qa:[{name:"question",label:"–í–æ–ø—Ä–æ—Å",type:"text",required:!0,searchable:!0},{name:"answer",label:"–û—Ç–≤–µ—Ç",type:"text",required:!0,searchable:!1}],service_catalog:[{name:"name",label:"–ù–∞–∑–≤–∞–Ω–∏–µ",type:"text",required:!0,searchable:!0},{name:"description",label:"–û–ø–∏—Å–∞–Ω–∏–µ",type:"text",required:!1,searchable:!0},{name:"price",label:"–¶–µ–Ω–∞",type:"number",required:!1,searchable:!1},{name:"is_active",label:"–ê–∫—Ç–∏–≤–Ω–∞",type:"bool",required:!1,searchable:!1}],product_catalog:[{name:"name",label:"–ù–∞–∑–≤–∞–Ω–∏–µ",type:"text",required:!0,searchable:!0},{name:"description",label:"–û–ø–∏—Å–∞–Ω–∏–µ",type:"text",required:!1,searchable:!0},{name:"price",label:"–¶–µ–Ω–∞",type:"number",required:!1,searchable:!1},{name:"in_stock",label:"–í –Ω–∞–ª–∏—á–∏–∏",type:"bool",required:!1,searchable:!1}],company_info:[{name:"topic",label:"–¢–µ–º–∞",type:"text",required:!0,searchable:!0},{name:"info",label:"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",type:"text",required:!0,searchable:!0}],custom:[{name:"field1",label:"–ü–æ–ª–µ 1",type:"text",required:!0,searchable:!0},{name:"field2",label:"–ü–æ–ª–µ 2",type:"text",required:!1,searchable:!1}]},ot=u=>{const v=me(),{token:p}=Ae(),d=l([]),h=l(null),f=l([]),$=l(!1),E=l(!1),D=l(null),J=k(()=>d.value.map(s=>s.tool_name)),O=s=>Ee[s]||Ee.custom,N=async()=>{var s;$.value=!0,D.value=null;try{console.log(`üìÇ Fetching directories for agent ${u}...`);const o=await v(`/agents/${u}/directories`,{headers:{Authorization:`Bearer ${p.value}`}});d.value=o||[],console.log(`‚úÖ Loaded ${d.value.length} directories`)}catch(o){const r=(o==null?void 0:o.status)||(o==null?void 0:o.statusCode)||((s=o==null?void 0:o.response)==null?void 0:s.status);r===404?(console.warn("‚ö†Ô∏è  Directories API not implemented on backend (404)"),D.value="–§—É–Ω–∫—Ü–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞",d.value=[]):(D.value=y(o,"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏"),console.error("Failed to fetch directories:",o),r>=500&&(d.value=[]))}finally{$.value=!1}},w=async s=>{var o;try{const r={...s,columns:s.columns||O(s.template),response_mode:s.response_mode||"function_result",search_type:s.search_type||"fuzzy"};console.log("üìù Creating directory:",r.name),console.log("üì§ Request payload:",JSON.stringify(r,null,2));const n=await v(`/agents/${u}/directories`,{method:"POST",headers:{Authorization:`Bearer ${p.value}`,"Content-Type":"application/json"},body:r});if(!n||!n.id)throw console.error("‚ùå Server returned empty or invalid response"),new Error("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç");return console.log("‚úÖ Directory created:",n.id),d.value.push(n),n}catch(r){const n=(r==null?void 0:r.status)||(r==null?void 0:r.statusCode)||((o=r==null?void 0:r.response)==null?void 0:o.status);throw console.error("‚ùå Failed to create directory:",r),n===409?new Error("–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"):new Error(y(r,"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫"))}},m=async(s,o)=>{var r;try{const n=await v(`/agents/${u}/directories/${s}`,{method:"PUT",headers:{Authorization:`Bearer ${p.value}`,"Content-Type":"application/json"},body:o}),c=d.value.findIndex(_=>_.id===s);return c!==-1&&(d.value[c]=n),((r=h.value)==null?void 0:r.id)===s&&(h.value=n),n}catch(n){throw new Error(y(n,"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫"))}},F=async s=>{var o;try{await v(`/agents/${u}/directories/${s}`,{method:"DELETE",headers:{Authorization:`Bearer ${p.value}`}}),d.value=d.value.filter(r=>r.id!==s),((o=h.value)==null?void 0:o.id)===s&&(h.value=null)}catch(r){throw new Error(y(r,"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫"))}},x=async(s,o)=>{try{await v(`/agents/${u}/directories/${s}/toggle`,{method:"PATCH",headers:{Authorization:`Bearer ${p.value}`,"Content-Type":"application/json"},body:{is_enabled:o}});const r=d.value.findIndex(n=>n.id===s);r!==-1&&(d.value[r].is_enabled=o)}catch(r){throw new Error(y(r,"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞"))}},a=async(s,o)=>{E.value=!0;try{const r=new URLSearchParams;r.append("limit","100"),o&&r.append("search",o);const n=await v(`/agents/${u}/directories/${s}/items?${r}`,{headers:{Authorization:`Bearer ${p.value}`}});f.value=n.items}catch(r){console.error("Failed to fetch items:",r),f.value=[]}finally{E.value=!1}};return{directories:d,currentDirectory:h,items:f,isLoading:$,isLoadingItems:E,error:D,existingToolNames:J,fetchDirectories:N,createDirectory:w,updateDirectory:m,deleteDirectory:F,toggleDirectory:x,fetchItems:a,createItem:async(s,o)=>{var r;try{const n=await v(`/agents/${u}/directories/${s}/items`,{method:"POST",headers:{Authorization:`Bearer ${p.value}`,"Content-Type":"application/json"},body:{data:o}});f.value.push(n);const c=d.value.findIndex(_=>_.id===s);return c!==-1&&d.value[c].items_count++,((r=h.value)==null?void 0:r.id)===s&&h.value.items_count++,n}catch(n){throw new Error(y(n,"–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"))}},updateItem:async(s,o,r)=>{try{const n=await v(`/agents/${u}/directories/${s}/items/${o}`,{method:"PUT",headers:{Authorization:`Bearer ${p.value}`,"Content-Type":"application/json"},body:{data:r}});return f.value=f.value.map(c=>c.id===o?n:c),n}catch(n){throw new Error(y(n,"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"))}},deleteItem:async(s,o)=>{var r;try{await v(`/agents/${u}/directories/${s}/items/${o}`,{method:"DELETE",headers:{Authorization:`Bearer ${p.value}`}}),f.value=f.value.filter(c=>c.id!==o);const n=d.value.findIndex(c=>c.id===s);n!==-1&&d.value[n].items_count--,((r=h.value)==null?void 0:r.id)===s&&h.value.items_count--}catch(n){throw new Error(y(n,"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å"))}},deleteItems:async(s,o)=>{var r;try{await v(`/agents/${u}/directories/${s}/items`,{method:"DELETE",headers:{Authorization:`Bearer ${p.value}`,"Content-Type":"application/json"},body:{ids:o}}),f.value=f.value.filter(c=>!o.includes(c.id));const n=d.value.findIndex(c=>c.id===s);n!==-1&&(d.value[n].items_count-=o.length),((r=h.value)==null?void 0:r.id)===s&&(h.value.items_count-=o.length)}catch(n){throw new Error(y(n,"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏"))}},importCsv:async(s,o,r,n)=>{try{const c=new FormData;c.append("file",o),c.append("mapping",JSON.stringify(r)),c.append("has_header",String(n.hasHeader)),c.append("replace_all",String(n.replaceAll));const _=await v(`/agents/${u}/directories/${s}/import`,{method:"POST",headers:{Authorization:`Bearer ${p.value}`},body:c});return await a(s),await N(),_}catch(c){throw new Error(y(c,"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª"))}},exportCsv:async s=>{try{const{public:{apiBase:o}}=Ze(),r=rt();if(!r)throw new Error("–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");const n=await fetch(`${o}/agents/${u}/directories/${s}/export?format=csv`,{method:"GET",credentials:"include",headers:{Authorization:`Bearer ${r}`,Accept:"text/csv"}});if(!n.ok)throw new Error(st(n.status,"–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫"));const c=await n.blob(),_=URL.createObjectURL(c),q=d.value.find(H=>H.id===s),R=`${(q==null?void 0:q.slug)||(q==null?void 0:q.name)||"export"}.csv`,A=document.createElement("a");A.href=_,A.download=R,document.body.appendChild(A),A.click(),document.body.removeChild(A),URL.revokeObjectURL(_)}catch(o){throw console.error("‚ùå Export CSV error:",o),new Error(y(o,"–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫"))}},setCurrentDirectory:s=>{h.value=s,s?a(s.id):f.value=[]},getTemplateColumns:O}},nt=u=>{const v=me(),p=l([]),d=l(null),h=l(!1),f=l(!1),$=l(!1),E=l(null),D=async()=>{const w=u();if(w)try{h.value=!0,E.value=null;const m=await v(`/agents/${w}/system-prompt/history`,{query:{limit:30}});p.value=m.items,d.value=m.next_cursor}catch(m){if((m==null?void 0:m.statusCode)===404||(m==null?void 0:m.status)===404){p.value=[],d.value=null;return}throw E.value=m.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–º–ø—Ç–∞",m}finally{h.value=!1}},J=async()=>{const w=u();if(!(!w||d.value===null))try{f.value=!0;const m=await v(`/agents/${w}/system-prompt/history`,{query:{limit:30,cursor:d.value}});p.value.push(...m.items),d.value=m.next_cursor}catch(m){throw E.value=m.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë",m}finally{f.value=!1}},O=async w=>{const m=u();return m?await v(`/agents/${m}/system-prompt/history/${w}`):null},N=async w=>{const m=u();if(!m)return null;try{$.value=!0;const F=await v(`/agents/${m}/system-prompt/history/${w}/activate`,{method:"POST"});for(const x of p.value)x.is_active=x.id===w;return F}finally{$.value=!1}};return{versions:j(p),nextCursor:j(d),isLoading:j(h),isLoadingMore:j(f),isActivating:j($),error:j(E),fetchHistory:D,fetchMore:J,fetchVersionDetail:O,activateVersion:N}},Te="agent-chat-sessions",pe=typeof window<"u",lt=()=>{if(!pe)return{};try{const u=window.localStorage.getItem(Te);return u?JSON.parse(u):{}}catch(u){return console.error("Failed to parse stored agent sessions:",u),{}}},ut=u=>{if(pe)try{window.localStorage.setItem(Te,JSON.stringify(u))}catch(v){console.error("Failed to persist agent sessions:",v)}},it=()=>{const u=l(pe?lt():{}),v=f=>{u.value=f,ut(f)};return{getSessionId:f=>u.value[f]??null,setSessionId:(f,$)=>{v({...u.value,[f]:$})},clearSessionId:f=>{if(!u.value[f])return;const{[f]:$,...E}=u.value;v(E)}}},qe=()=>({name:"",system_prompt:"",model:"",timezone:"Europe/Moscow",status:"draft",llm_params:{temperature:.7,max_tokens:1e3}}),fe=u=>{var v,p;return{name:u.name,system_prompt:u.system_prompt,model:u.model,timezone:u.timezone??"Europe/Moscow",status:u.status,llm_params:{temperature:((v=u.llm_params)==null?void 0:v.temperature)??.7,max_tokens:((p=u.llm_params)==null?void 0:p.max_tokens)??1e3}}},ht=et("agentEditor",()=>{const{token:u}=Ae(),v=me(),{success:p,error:d}=tt(),{getAgent:h,updateAgent:f,deleteAgent:$,fetchSqnsStatus:E,enableSqns:D,disableSqns:J,fetchSqnsResources:O,fetchSqnsServices:N}=at(),{getSessionId:w,setSessionId:m,clearSessionId:F}=it(),x=l(null),a=l(null),g=l(qe()),b=l(!1),P=l(!1),U=l(!1),G=l(!1),Q=l(null),oe=l(!1),s=l(!1),o=l(null),r=l(!1),n=l([]),c=l([]),_=l(!1),q=l(!1),R=l(null),A=l(!1),H=l(!1),V=l(null),X=l(!1),T=l(null),z=l(!1),L=l(null),Z=l([]),ee=l([]),B=l(null),K=l(!1),M=l(!1),S=l([]),Y=l(""),W=l(!1),C=l(null),te=l(!1),he="agent-chat-messages",Le=()=>{a.value=null,g.value=qe(),b.value=!1,P.value=!1,U.value=!1,G.value=!1,Q.value=null,oe.value=!1,s.value=!1,o.value=null,r.value=!1,n.value=[],c.value=[],_.value=!1,q.value=!1,R.value=null,A.value=!1,H.value=!1,X.value=!1,V.value=null,z.value=!1,T.value=null,L.value=null,Z.value=[],ee.value=[],B.value=null,K.value=!1,M.value=!1,S.value=[],Y.value="",W.value=!1,C.value=null,te.value=!1},ye=e=>{x.value!==e&&(x.value=e,Le(),V.value=ot(e),T.value=nt(()=>e))},Ce=async e=>{if(e&&(x.value!==e&&ye(e),!(b.value||P.value)))try{P.value=!0,Q.value=null;const t=await h(e);a.value=t,g.value=fe(t),b.value=!0}catch(t){Q.value=y(t,"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≥–µ–Ω—Ç–∞")}finally{P.value=!1}},xe=async()=>{if(!a.value)return!1;try{U.value=!0;const e=await f(a.value.id,g.value);return a.value=e,g.value=fe(e),p("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã","–ê–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω"),z.value&&T.value&&T.value.fetchHistory(),!0}catch(e){return d("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è",y(e,"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è")),!1}finally{U.value=!1}},ge=async()=>{if(!a.value||!b.value||g.value.system_prompt===a.value.system_prompt)return!1;try{s.value=!0;const e=await f(a.value.id,{system_prompt:g.value.system_prompt});return a.value=e,o.value=new Date,z.value&&T.value&&T.value.fetchHistory(),!0}catch(e){return console.error("Auto-save failed:",e),!1}finally{s.value=!1}},I=async e=>{if(!a.value||!b.value)return!1;try{s.value=!0;const t=await f(a.value.id,e);return a.value=t,Object.assign(g.value,e),o.value=new Date,e.system_prompt&&z.value&&T.value&&T.value.fetchHistory(),!0}catch(t){return console.error("Auto-save failed:",t),!1}finally{s.value=!1}},ke=async()=>{if(!a.value)return!1;try{return G.value=!0,await $(a.value.id),!0}catch(e){return d("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è",y(e,"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∞–≥–µ–Ω—Ç–∞")),!1}finally{G.value=!1}},De=()=>{a.value&&(g.value=fe(a.value))},ze=()=>{var e;g.value.system_prompt=((e=a.value)==null?void 0:e.system_prompt)||""},ne=async()=>{if(a.value)try{_.value=!0;const[e,t]=await Promise.all([v("/tools",{headers:{Authorization:`Bearer ${u.value}`}}),v(`/agents/${a.value.id}/tools`,{headers:{Authorization:`Bearer ${u.value}`}})]);n.value=e,c.value=t,q.value=!0}catch(e){console.error("Failed to fetch tools:",e)}finally{_.value=!1}},Fe=async()=>{q.value||_.value||await ne()},Be=async e=>{if(!a.value)return;const t=c.value.some(i=>i.tool_id===e.id);try{t?await v(`/agents/${a.value.id}/tools/${e.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${u.value}`}}):await v(`/agents/${a.value.id}/tools/${e.id}`,{method:"POST",headers:{Authorization:`Bearer ${u.value}`,"Content-Type":"application/json"},body:{permission_scope:"read",timeout_ms:15e3}}),await ne()}catch(i){console.error("Failed to toggle tool:",i)}},we=async()=>{if(a.value){A.value=!0;try{const t=(await v(`/agents/${a.value.id}/channels/active`,{method:"GET",headers:{Authorization:`Bearer ${u.value}`}})).find(i=>i.type==="telegram");R.value=t?{id:t.id,bot_token:t.telegram_bot_token,webhook_enabled:t.telegram_webhook_enabled,webhook_endpoint:t.telegram_webhook_endpoint}:null,H.value=!0}catch(e){console.error("Failed to fetch channels:",e),R.value=null}finally{A.value=!1}}},Oe=async()=>{H.value||A.value||await we()},Ne=async()=>{!V.value||X.value||(await V.value.fetchDirectories(),X.value=!0)},ae=async()=>{if(a.value)try{B.value=null;const e=await E(a.value.id);L.value=e,K.value=!0}catch(e){if((e==null?void 0:e.statusCode)===404){K.value=!0;return}B.value=y(e,"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—É—Å SQNS")}},Pe=async()=>{K.value||await ae()},Re=async()=>{var e;if(!(M.value||!a.value||!((e=L.value)!=null&&e.sqnsEnabled)))try{const[t,i]=await Promise.all([O(a.value.id),N(a.value.id)]);Z.value=t,ee.value=i,M.value=!0}catch(t){if((t==null?void 0:t.statusCode)===400||(t==null?void 0:t.statusCode)===404)return;B.value=y(t,"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ SQNS")}},He=async e=>{if(!a.value)return!1;try{return await D(a.value.id,{host:"crmexchange.1denta.ru",email:e.email,password:e.password,defaultResourceId:e.defaultResourceId}),M.value=!1,await ae(),!0}catch(t){return B.value=y(t,"–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é SQNS"),!1}},Me=async()=>{if(!a.value)return!1;try{return await J(a.value.id),M.value=!1,Z.value=[],ee.value=[],await ae(),!0}catch(e){return B.value=y(e,"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é SQNS"),!1}},Ie=async()=>{if(!(!T.value||z.value))try{await T.value.fetchHistory(),z.value=!0}catch{z.value=!1}},je=()=>{if(typeof window>"u"||!a.value)return;const e=localStorage.getItem(`${he}-${a.value.id}`);if(e)try{S.value=JSON.parse(e)}catch(t){console.error("Failed to parse stored messages:",t),S.value=[]}},_e=()=>{typeof window>"u"||!a.value||localStorage.setItem(`${he}-${a.value.id}`,JSON.stringify(S.value))},Je=()=>{te.value||!a.value||(je(),C.value=w(a.value.id),te.value=!0)},Ue=async()=>{if(!Y.value.trim()||W.value||!a.value)return!1;const e=Y.value.trim();Y.value="",S.value.push({role:"user",content:e});try{W.value=!0;const t={agent_id:a.value.id,input_message:e};C.value&&(t.session_id=C.value);const i=await v("/runs",{method:"POST",headers:{"Content-Type":"application/json"},body:t});if(i){i.session_id&&a.value&&(m(a.value.id,i.session_id),C.value=i.session_id);const ue=i.prompt_tokens!==null&&i.prompt_tokens!==void 0||i.completion_tokens!==null&&i.completion_tokens!==void 0||i.total_tokens!==null&&i.total_tokens!==void 0?{prompt:i.prompt_tokens??null,completion:i.completion_tokens??null,total:i.total_tokens??null}:void 0,ie=i.tools_called&&i.tools_called.length>0?i.tools_called:void 0;if(i.status==="succeeded"&&i.output_message){let ce=i.output_message;const ve=ce.match(/AgentRunResult\(output=['"]([\s\S]*)['"]\)/);ve&&ve[1]&&(ce=ve[1]),S.value.push({role:"agent",content:ce,tokens:ue,tools_called:ie})}else i.status==="failed"&&i.error_message?(S.value.push({role:"agent",content:`–û—à–∏–±–∫–∞: ${i.error_message}`,tokens:ue,tools_called:ie}),d("–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞",y({message:i.error_message},"–ê–≥–µ–Ω—Ç –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å"))):S.value.push({role:"agent",content:"–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞.",tokens:ue,tools_called:ie})}else S.value.push({role:"agent",content:"–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞.",tokens:void 0,tools_called:void 0})}catch(t){console.error("Chat error:",t),t.statusCode===400&&C.value&&a.value&&(F(a.value.id),C.value=null),S.value.push({role:"agent",content:"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–≤—è–∑–∏ —Å –∞–≥–µ–Ω—Ç–æ–º.",tokens:void 0,tools_called:void 0})}finally{W.value=!1}return!0},Ge=async()=>{if(a.value){if(C.value)try{await v(`/runs/session/${C.value}`,{method:"DELETE",headers:{Authorization:`Bearer ${u.value}`}})}catch(e){console.error("Failed to clear session on backend:",e)}S.value=[],_e(),F(a.value.id),C.value=null}},Se=e=>{const t=n.value.find(i=>i.id===e);return(t==null?void 0:t.name)||"–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç"},be=e=>{const t=n.value.find(i=>i.id===e);return(t==null?void 0:t.description)||""},le=k(()=>{var i;const e=((i=L.value)==null?void 0:i.sqnsTools)??[],t={sqns_list_resources:"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏",sqns_list_services:"–£—Å–ª—É–≥–∏",sqns_find_client:"–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞",sqns_list_slots:"–ü–æ–∏—Å–∫ —Å–ª–æ—Ç–æ–≤"};return e.map(se=>({...se,displayName:t[se.name]||se.name}))}),$e=k(()=>{var e;return((e=L.value)==null?void 0:e.sqnsEnabled)??!1}),Qe=k(()=>{var e,t;return(e=L.value)!=null&&e.sqnsEnabled?((t=L.value)==null?void 0:t.sqnsStatus)==="error"?"–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞":"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞":"SQNS –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω"}),Ve=k(()=>{var e;return((e=L.value)==null?void 0:e.sqnsHost)??"–Ω–µ —É–∫–∞–∑–∞–Ω"}),Ke=k(()=>{var e;return((e=L.value)==null?void 0:e.sqnsError)??""}),Ye=k(()=>{var i;const e=(i=L.value)==null?void 0:i.sqnsLastSyncAt;if(!e)return"–Ω–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π";const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString("ru-RU",{dateStyle:"medium",timeStyle:"short"})}),We=k(()=>{const e=[];return $e.value&&le.value.length&&e.push(...le.value.map(t=>({name:t.name,description:t.description}))),c.value.length&&e.push(...c.value.map(t=>({name:Se(t.tool_id),description:be(t.tool_id)}))),e}),Xe=k(()=>{const e=S.value.length;return e>0?`–∫–æ–Ω—Ç–µ–∫—Å—Ç: ${e} —Å–æ–æ–±—â–µ–Ω–∏–π`:""});return typeof window<"u"&&(re(S,()=>{_e()},{deep:!0}),de(()=>g.value.system_prompt,async(e,t)=>{!a.value||!b.value||e!==t&&e!==a.value.system_prompt&&r.value&&await ge()},{debounce:5e3}),re(()=>g.value.model,async(e,t)=>{!a.value||!b.value||e!==t&&e!==a.value.model&&await I({model:e})}),de(()=>g.value.name,async(e,t)=>{!a.value||!b.value||e!==t&&e!==a.value.name&&await I({name:e})},{debounce:2e3}),re(()=>g.value.status,async(e,t)=>{!a.value||!b.value||e!==t&&e!==a.value.status&&await I({status:e})}),re(()=>g.value.timezone,async(e,t)=>{!a.value||!b.value||e!==t&&e!==(a.value.timezone??"Europe/Moscow")&&await I({timezone:e})}),de(()=>g.value.llm_params,async(e,t)=>{!a.value||!b.value||JSON.stringify(e)!==JSON.stringify(t)&&JSON.stringify(e)!==JSON.stringify(a.value.llm_params)&&await I({llm_params:e})},{debounce:1e3,deep:!0})),{agentId:x,agent:a,form:g,isLoaded:b,isLoading:P,isSaving:U,isDeleting:G,error:Q,isPromptFullscreen:oe,isAutoSaving:s,lastAutoSavedAt:o,isPromptFocused:r,availableTools:n,boundTools:c,isLoadingTools:_,toolsLoaded:q,telegramChannel:R,isLoadingChannels:A,channelsLoaded:H,directoriesComposable:V,directoriesLoaded:X,promptHistory:T,promptHistoryLoaded:z,sqnsStatus:L,sqnsResources:Z,sqnsServices:ee,sqnsError:B,sqnsStatusLoaded:K,sqnsHintsLoaded:M,messages:S,userInput:Y,isTyping:W,currentSessionId:C,chatLoaded:te,sqnsToolsList:le,isSqnsEnabled:$e,sqnsStatusLabel:Qe,sqnsHostLabel:Ve,sqnsErrorMessage:Ke,formattedSqnsSyncAt:Ye,promptSidebarTools:We,chatContextLabel:Xe,setAgentId:ye,ensureAgentLoaded:Ce,saveAgent:xe,autoSavePrompt:ge,autoSaveField:I,removeAgent:ke,resetForm:De,resetPrompt:ze,fetchToolsData:ne,ensureToolsLoaded:Fe,toggleTool:Be,fetchChannels:we,ensureChannelsLoaded:Oe,ensureDirectoriesLoaded:Ne,loadSqnsStatusForAgent:ae,ensureSqnsStatusLoaded:Pe,ensureSqnsHints:Re,enableSqnsIntegration:He,disableSqnsIntegration:Me,ensurePromptHistoryLoaded:Ie,ensureChatLoaded:Je,sendMessage:Ue,clearChat:Ge,getToolName:Se,getToolDescription:be}});export{ht as u};
