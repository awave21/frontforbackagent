const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./entry.BA9w_SP9.js","./entry.BR0cvPVP.css"])))=>i.map(i=>d[i]);
import{b$ as E,ca as F,cf as J,cg as j,B as C,L as U,bd as y,k as S}from"./entry.BA9w_SP9.js";const B=r=>{try{const a=r.split(".");if(a.length!==3)return!0;const i=a[1].replace(/-/g,"+").replace(/_/g,"/"),t=atob(i),l=JSON.parse(t);if(!l.exp)return!0;const u=l.exp*1e3;return Date.now()>=u-3e4}catch{return!0}};let A=null;const O=async()=>{if(typeof window>"u")return!1;const r=localStorage.getItem("auth_refresh_token");if(!r)return console.warn("‚ö†Ô∏è  No refresh token available for token refresh"),!1;if(window.__refreshTokenPromise)return console.log("üîÑ Refresh already in progress (from useAuth), waiting for result..."),window.__refreshTokenPromise;console.warn("‚ö†Ô∏è  refreshAccessToken called from useApiFetch - consider using useAuth().refreshAccessToken() instead");const{public:{apiBase:a}}=E(),n=(async()=>{var i;try{const t=await fetch(`${a}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:r})});if(t.status===409){if(console.log("‚ö†Ô∏è  Received 409 Conflict - token is being processed, waiting..."),await new Promise(u=>setTimeout(u,1e3)),window.__refreshTokenPromise)return window.__refreshTokenPromise;throw new Error(`Refresh failed with status ${t.status}`)}if(!t.ok){const u=await t.text().catch(()=>"");let c={};try{c=u?JSON.parse(u):{}}catch{}throw console.error(`‚ùå Refresh failed with status ${t.status}:`,{status:t.status,statusText:t.statusText,error:c}),{status:t.status,statusCode:t.status,message:`Refresh failed with status ${t.status}`,data:c}}const l=await t.json();return localStorage.setItem("auth_token",l.token),l.refresh_token?(localStorage.setItem("auth_refresh_token",l.refresh_token),console.log("‚úÖ Refresh token updated in storage")):console.warn("‚ö†Ô∏è  Server did not return refresh_token in response"),console.log("‚úÖ Access token refreshed successfully"),!0}catch(t){console.error("‚ùå Failed to refresh access token:",t);const l=(t==null?void 0:t.status)||(t==null?void 0:t.statusCode)||((i=t==null?void 0:t.response)==null?void 0:i.status);return l===401||l===403?(console.warn("üî¥ Refresh token invalid or expired, clearing auth data"),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant")):console.warn(l===409?"‚ö†Ô∏è  409 Conflict during refresh":l===500?"‚ö†Ô∏è  Server error during token refresh, keeping current tokens":"‚ö†Ô∏è  Unknown error during token refresh, keeping current tokens"),!1}})();return window.__refreshTokenPromise=n,n.finally(()=>{window.__refreshTokenPromise===n&&(window.__refreshTokenPromise=null)}),n},D=()=>{var n;const{public:{apiBase:r}}=E();if(!A&&typeof window<"u")try{A=((n=F().$router)==null?void 0:n.push)||(()=>window.location.href="/")}catch{A=()=>window.location.href="/"}const a=J.create({baseURL:r,async onRequest({request:i,options:t}){if(typeof window<"u"){const l=typeof i=="string"?i:i.url;if(l.includes("/auth/login")||l.includes("/auth/register"))return;let c=localStorage.getItem("auth_token");if(c){if(B(c))if(await O())c=localStorage.getItem("auth_token");else return;if(c){const v=t.headers||{};t.headers={...v,Authorization:`Bearer ${c}`}}}}},async onResponseError({request:i,response:t,options:l}){var R;const u=l,c=typeof i=="string"?i:i.url,v=c.includes("/auth/login")||c.includes("/auth/register");if(t.status===401&&typeof window<"u"&&!v){if(u!=null&&u._retry?console.warn("üî¥ Request retried and still unauthorized, redirecting to login"):u._retry=!0,localStorage.getItem("auth_refresh_token")&&!(u!=null&&u._forceLogout)&&(console.log("üîê Received 401, attempting to refresh token..."),await O())){const k=localStorage.getItem("auth_token");if(k){const T=l.headers||{};return l.headers={...T,Authorization:`Bearer ${k}`},console.log("‚úÖ Token refreshed, retrying original request"),await a(i,l)}}console.warn("üî¥ Authentication token expired or invalid, redirecting to login"),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),A?A("/",{replace:!0}):window.location.href="/"}const P=c.includes("/auth/");if(t.status===409&&typeof window<"u"&&P&&(console.log("‚ö†Ô∏è  Received 409 Conflict on auth request - token refresh in progress, waiting..."),localStorage.getItem("auth_refresh_token")&&window.__refreshTokenPromise)){console.log("‚è≥ Waiting for active refresh to complete..."),await window.__refreshTokenPromise;const d=localStorage.getItem("auth_token");if(d){const k=l.headers||{};return l.headers={...k,Authorization:`Bearer ${d}`},u!=null&&u._retry||(u._retry=!0),console.log("‚úÖ Refresh completed, retrying original request"),await a(i,l)}}if(t.status===403&&typeof window<"u"){if(!c.includes("/auth/"))try{const{useToast:d}=await j(async()=>{const{useToast:T}=await import("./entry.BA9w_SP9.js").then(o=>o.ch);return{useToast:T}},__vite__mapDeps([0,1]),import.meta.url);d().error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤","–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")}catch(d){console.error("Failed to show 403 error toast:",d)}console.warn("üîí Access forbidden (403):",{url:c,message:"Insufficient permissions"})}if(t.status===429&&typeof window<"u"){const _=((R=t.headers)==null?void 0:R.get("retry-after"))||"60";console.warn(`Rate limit exceeded. Retry after ${_} seconds`)}if([502,503,504].includes(t.status)&&typeof window<"u"){const _=t.status===502?"Bad Gateway":t.status===503?"Service Unavailable":"Gateway Timeout";console.error(`‚ùå ${_} (${t.status}):`,{url:i,status:t.status,statusText:t.statusText,message:"Backend server is not responding. Please try again later."})}typeof window<"u"&&t.status>=500&&console.error(`‚ùå Server error (${t.status}):`,{url:i,status:t.status,statusText:t.statusText})}});return a},b=r=>{var n;const a=(r==null?void 0:r.status)||(r==null?void 0:r.statusCode)||((n=r==null?void 0:r.response)==null?void 0:n.status)||0;return a===403?{error:"forbidden",message:"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤. –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è."}:a===502?{error:"bad_gateway",message:"–°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."}:a===503?{error:"service_unavailable",message:"–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."}:a===504?{error:"gateway_timeout",message:"–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."}:!r.response&&!r.data&&r.message&&(r.message.includes("fetch")||r.message.includes("network")||r.message.includes("Failed to fetch"))?{error:"network_error",message:"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."}:r.data&&typeof r.data=="object"?{error:r.data.error||"unknown_error",message:r.data.message||r.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞",details:r.data.details,retry_after:r.data.retry_after}:{error:"unknown_error",message:r.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞"}},$=r=>{try{const a=r.split(".");if(a.length!==3)return null;const i=a[1].replace(/-/g,"+").replace(/_/g,"/"),t=atob(i);return JSON.parse(t)}catch(a){return console.error("Failed to decode JWT token:",a),null}},N=r=>{const a=$(r);if(!a||!a.exp)return!0;const n=a.exp*1e3;return Date.now()>=n-3e4},x=r=>!(!r||r.split(".").length!==3||N(r)),L=()=>{const r=D(),a=S(null),n=S(null),i=S(null),t=S(null),l=S(!1),u=S(null);let c=null;typeof window<"u"&&window.__refreshTokenPromise&&(c=window.__refreshTokenPromise);const v=async o=>{try{l.value=!0,u.value=null;const e=await r("/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:o});if(a.value=e.token,e.refresh_token&&(n.value=e.refresh_token,localStorage.setItem("auth_refresh_token",e.refresh_token)),e.user){const f={...e.user,scopes:Array.isArray(e.user.scopes)?e.user.scopes:[]};i.value=f,localStorage.setItem("auth_user",JSON.stringify(f))}return e.tenant&&(t.value=e.tenant,localStorage.setItem("auth_tenant",JSON.stringify(e.tenant))),localStorage.setItem("auth_token",e.token),console.log("Register response structure:",{has_token:!!e.token,has_refresh_token:!!e.refresh_token,has_user:!!e.user,has_tenant:!!e.tenant}),e.token&&await _(),e}catch(e){const f=b(e);let g=f.message;if(f.details){const s=Object.entries(f.details).map(([m,h])=>`${m}: ${h.join(", ")}`).join("; ");g=`${g}. ${s}`}throw u.value=g,e.apiError=f,e}finally{l.value=!1}},P=async o=>{try{l.value=!0,u.value=null;const e=await r("/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:o});if(a.value=e.token,e.refresh_token&&(n.value=e.refresh_token,localStorage.setItem("auth_refresh_token",e.refresh_token)),e.user){const f={...e.user,scopes:Array.isArray(e.user.scopes)?e.user.scopes:[]};i.value=f,localStorage.setItem("auth_user",JSON.stringify(f))}return e.tenant&&(t.value=e.tenant,localStorage.setItem("auth_tenant",JSON.stringify(e.tenant))),localStorage.setItem("auth_token",e.token),console.log("Login response structure:",{has_token:!!e.token,has_refresh_token:!!e.refresh_token,has_user:!!e.user,has_tenant:!!e.tenant}),e.token&&await _(),e}catch(e){const f=b(e);let g=f.message;if(f.details){const s=Object.entries(f.details).map(([m,h])=>`${m}: ${h.join(", ")}`).join("; ");g=`${g}. ${s}`}throw u.value=g,e.apiError=f,e}finally{l.value=!1}},R=async o=>{try{l.value=!0,u.value=null;const e=await r("/auth/token",{method:"POST",headers:{"x-api-key":o,"Content-Type":"application/json"},body:{api_key:o}});return a.value=e.token,e.refresh_token&&(n.value=e.refresh_token,localStorage.setItem("auth_refresh_token",e.refresh_token)),localStorage.setItem("auth_token",e.token),console.log("API Key token response structure:",{has_token:!!e.token,has_refresh_token:!!e.refresh_token,full_response:e}),e}catch(e){const f=b(e);throw u.value=f.message,e.apiError=f,e}finally{l.value=!1}},_=async()=>{if(!a.value){const o=localStorage.getItem("auth_token");if(!o||!x(o))return null;a.value=o}if(!a.value)return null;try{const o=await r("/auth/me",{method:"GET"});if(o.user){const e={...o.user,scopes:Array.isArray(o.user.scopes)?o.user.scopes:[]};i.value=e,localStorage.setItem("auth_user",JSON.stringify(e))}return o.tenant&&(t.value=o.tenant,localStorage.setItem("auth_tenant",JSON.stringify(o.tenant))),o}catch(o){const e=b(o);return console.error("Failed to fetch current user:",e),null}},d=async(o=0)=>n.value?c?(console.log("üîÑ Refresh already in progress, waiting for result..."),c):typeof window<"u"&&window.__refreshTokenPromise?(console.log("üîÑ Refresh already in progress (from useApiFetch), waiting for result..."),c=window.__refreshTokenPromise,c):(c=(async()=>{var e,f,g;try{l.value=!0,u.value=null;const s=n.value;if(!s)return console.warn("‚ö†Ô∏è  Refresh token lost during refresh attempt"),!1;console.log(`üîÑ Attempting to refresh token (attempt ${o+1})...`);const{public:{apiBase:m}}=E(),h=await fetch(`${m}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:s})});if(h.status===409)if(console.log("‚ö†Ô∏è  Received 409 Conflict - token is being processed by another request"),o<3){const p=Math.min(1e3*Math.pow(2,o),5e3);return console.log(`‚è≥ Waiting ${p}ms before retry...`),await new Promise(I=>setTimeout(I,p)),c=null,d(o+1)}else throw console.error("‚ùå Max retries reached for 409 Conflict"),new Error(`Refresh failed with status ${h.status} after ${o+1} retries`);if(!h.ok){const p=await h.text().catch(()=>"");let I={};try{I=p?JSON.parse(p):{}}catch{}throw console.error(`‚ùå Refresh failed with status ${h.status}:`,{status:h.status,statusText:h.statusText,error:I}),{status:h.status,statusCode:h.status,message:`Refresh failed with status ${h.status}`,data:I}}const w=await h.json();return w.refresh_token?(n.value=w.refresh_token,localStorage.setItem("auth_refresh_token",w.refresh_token),console.log("‚úÖ Refresh token updated in storage")):console.warn("‚ö†Ô∏è  Server did not return refresh_token in response"),a.value=w.token,localStorage.setItem("auth_token",w.token),console.log("‚úÖ Access token refreshed successfully"),!0}catch(s){console.error("‚ùå Failed to refresh token:",{error:s,message:s==null?void 0:s.message,status:(s==null?void 0:s.status)||(s==null?void 0:s.statusCode)});const m=(s==null?void 0:s.status)||(s==null?void 0:s.statusCode)||((e=s==null?void 0:s.response)==null?void 0:e.status)||((f=s==null?void 0:s.message)!=null&&f.includes("status")?parseInt(((g=s.message.match(/\d+/))==null?void 0:g[0])||"0"):0);return m===401||m===403?(console.warn("üî¥ Refresh token invalid or expired, logging out"),k()):m===409?console.warn("‚ö†Ô∏è  409 Conflict during refresh, will retry if possible"):m===500?(console.warn("‚ö†Ô∏è  Server error during token refresh (500), keeping current session"),console.warn("   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç—É, –Ω–æ —Å–µ—Å—Å–∏—è –º–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞")):console.warn("‚ö†Ô∏è  Error during token refresh, keeping current session"),!1}finally{l.value=!1,c=null,typeof window<"u"&&window.__refreshTokenPromise===c&&(window.__refreshTokenPromise=null)}})(),typeof window<"u"&&(window.__refreshTokenPromise=c),c):(console.warn("‚ö†Ô∏è  No refresh token available"),!1),k=()=>{a.value=null,n.value=null,i.value=null,t.value=null,localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),window.location.href="/",u.value=null},T=async()=>{const o=localStorage.getItem("auth_token"),e=localStorage.getItem("auth_refresh_token"),f=localStorage.getItem("auth_user"),g=localStorage.getItem("auth_tenant");if(e&&(n.value=e),o&&x(o)){a.value=o;const s=$(o);if(s&&s.exp){const m=s.exp*1e3,h=Date.now(),w=m-h,p=5*60*1e3;w<p&&n.value&&(console.log("Access token expires soon, refreshing..."),await d())}}else if(o)if(n.value){if(console.log("Access token expired, attempting refresh..."),!await d()){console.warn("Failed to refresh token, clearing auth data"),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),a.value=null,n.value=null,i.value=null,t.value=null;return}}else{console.warn("Token expired or invalid, no refresh token available, clearing auth data"),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),a.value=null,n.value=null,i.value=null,t.value=null;return}if(f)try{const s=JSON.parse(f);Array.isArray(s.scopes)||(s.scopes=[]),i.value=s}catch(s){console.error("Failed to parse saved user data",s)}if(g)try{t.value=JSON.parse(g)}catch(s){console.error("Failed to parse saved tenant data",s)}a.value&&x(a.value)&&await _()};return C(()=>{T()}),{token:y(a),refreshToken:y(n),user:y(i),tenant:y(t),isLoading:y(l),error:y(u),register:v,login:P,loginWithApiKey:R,refreshAccessToken:d,logout:k,fetchCurrentUser:_,isAuthenticated:U(()=>a.value?x(a.value)?!0:n.value?(d().catch(()=>{localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),a.value=null,n.value=null,i.value=null,t.value=null}),!!n.value):(localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),a.value=null,n.value=null,i.value=null,t.value=null,!1):!1),decodeToken:o=>o?$(o):null,isTokenExpired:o=>o?N(o):!0,isTokenValid:o=>x(o)}};export{L as a,D as u};
