import{c1 as R}from"./entry.B2IFVgKF.js";const g=["auth_token","auth_refresh_token","auth_user","auth_tenant","auth_cookie_refresh_capability"],T=3e4,p=3*60*1e3,m=15*60*1e3,l=200,v=500,f=3,A=new Set(["invalid_refresh_token","refresh_token_expired","refresh_token_revoked","refresh_token_not_found"]);let c=null,u=null,h=!1,i=0;const S=e=>new Promise(t=>setTimeout(t,e)),E=()=>l+Math.floor(Math.random()*(v-l+1)),w=e=>{try{const t=e.split(".");if(t.length!==3)return null;const r=t[1].replace(/-/g,"+").replace(/_/g,"/"),n=r.padEnd(Math.ceil(r.length/4)*4,"="),o=atob(n);return JSON.parse(o)}catch{return null}},k=e=>{const t=w(e),s=t==null?void 0:t.exp;return typeof s!="number"?null:s*1e3},d=(e,t=T)=>{const s=k(e);return s?Date.now()>=s-t:!0},_=()=>u,L=e=>{u=e},Y=()=>{u=null;for(const e of g)localStorage.removeItem(e)},M=(e,t)=>{if(e===401||e===403)return!0;if(!t||typeof t!="object")return!1;const s=t.error;return typeof s=="string"&&A.has(s)},I=(e,t)=>{if(t&&typeof t=="object"){const s=t.error;if(typeof s=="string"&&s.length>0)return s}return`http_${e}`},b=async e=>{if((e.headers.get("content-type")||"").includes("application/json"))return e.json().catch(()=>null);const s=await e.text().catch(()=>"");if(!s)return null;try{return JSON.parse(s)}catch{return{message:s}}},y=()=>{i=Date.now()},D=()=>{if(h)return;h=!0,i=Date.now();const e=["click","keydown","mousemove","scroll","touchstart","focus"];for(const t of e)window.addEventListener(t,y,{passive:!0});document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&y()})},C=()=>document.visibilityState!=="visible"?!1:Date.now()-i<=m,O=(e,t=p)=>{const s=k(e);return s?s-Date.now()<=t:!0},x=async()=>{const{public:{apiBase:e}}=R();for(let t=0;t<=f;t++)try{const s=await fetch(`${e}/auth/refresh`,{method:"POST",credentials:"include"}),r=await b(s);if(s.status===409){if(t<f){await S(E());continue}return{success:!1,shouldLogout:!1,reason:"refresh_token_in_use"}}if(!s.ok)return{success:!1,shouldLogout:M(s.status,r),reason:I(s.status,r)};if(!r||typeof r!="object"||typeof r.token!="string")return{success:!1,shouldLogout:!1,reason:"invalid_refresh_response"};const n=r.token;return L(n),{success:!0,token:n}}catch{return{success:!1,shouldLogout:!1,reason:"refresh_network_error"}}return{success:!1,shouldLogout:!1,reason:"refresh_failed"}},N=async()=>{if(c)return c;const e=x();c=e;try{return await e}finally{c===e&&(c=null)}},P=async e=>{D();const t=_(),s=(e==null?void 0:e.forceRefresh)===!0,r=(e==null?void 0:e.proactiveWindowMs)??p;if(!(s||!t||d(t)||O(t,r)&&C())&&t)return{token:t,refreshed:!1,shouldLogout:!1};const o=await N();if(o.success)return{token:o.token,refreshed:!0,shouldLogout:!1};const a=_();return a&&!d(a)?{token:a,refreshed:!1,shouldLogout:!1}:{token:null,refreshed:!1,shouldLogout:o.shouldLogout}};export{D as a,Y as c,P as e,_ as g,d as i,N as r,L as s};
