import{ad as P,ae as N,ak as C,H as J,D as O,Y as v,r as y}from"./entry.DvavCQ8-.js";const F=o=>{try{const s=o.split(".");if(s.length!==3)return!0;const l=s[1].replace(/-/g,"+").replace(/_/g,"/"),t=atob(l),n=JSON.parse(t);if(!n.exp)return!0;const i=n.exp*1e3;return Date.now()>=i-3e4}catch{return!0}};let T=null;const j=async()=>{if(typeof window>"u")return!1;const o=localStorage.getItem("auth_refresh_token");if(!o)return console.warn("‚ö†Ô∏è  No refresh token available for token refresh"),!1;if(window.__refreshTokenPromise)return console.log("üîÑ Refresh already in progress (from useAuth), waiting for result..."),window.__refreshTokenPromise;console.warn("‚ö†Ô∏è  refreshAccessToken called from useApiFetch - consider using useAuth().refreshAccessToken() instead");const{public:{apiBase:s}}=P(),a=(async()=>{var l;try{const t=await fetch(`${s}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:o})});if(t.status===409){if(console.log("‚ö†Ô∏è  Received 409 Conflict - token is being processed, waiting..."),await new Promise(i=>setTimeout(i,1e3)),window.__refreshTokenPromise)return window.__refreshTokenPromise;throw new Error(`Refresh failed with status ${t.status}`)}if(!t.ok){const i=await t.text().catch(()=>"");let f={};try{f=i?JSON.parse(i):{}}catch{}throw console.error(`‚ùå Refresh failed with status ${t.status}:`,{status:t.status,statusText:t.statusText,error:f}),{status:t.status,statusCode:t.status,message:`Refresh failed with status ${t.status}`,data:f}}const n=await t.json();return localStorage.setItem("auth_token",n.token),n.refresh_token?(localStorage.setItem("auth_refresh_token",n.refresh_token),console.log("‚úÖ Refresh token updated in storage")):console.warn("‚ö†Ô∏è  Server did not return refresh_token in response"),console.log("‚úÖ Access token refreshed successfully"),!0}catch(t){console.error("‚ùå Failed to refresh access token:",t);const n=(t==null?void 0:t.status)||(t==null?void 0:t.statusCode)||((l=t==null?void 0:t.response)==null?void 0:l.status);return n===401||n===403?(console.warn("üî¥ Refresh token invalid or expired, clearing auth data"),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant")):console.warn(n===409?"‚ö†Ô∏è  409 Conflict during refresh":n===500?"‚ö†Ô∏è  Server error during token refresh, keeping current tokens":"‚ö†Ô∏è  Unknown error during token refresh, keeping current tokens"),!1}})();return window.__refreshTokenPromise=a,a.finally(()=>{window.__refreshTokenPromise===a&&(window.__refreshTokenPromise=null)}),a},U=()=>{var a;const{public:{apiBase:o}}=P();if(!T&&typeof window<"u")try{T=((a=N().$router)==null?void 0:a.push)||(()=>window.location.href="/")}catch{T=()=>window.location.href="/"}const s=C.create({baseURL:o,async onRequest({options:l}){if(typeof window<"u"){let t=localStorage.getItem("auth_token");if(t){if(F(t))if(await j())t=localStorage.getItem("auth_token");else return;if(t){const n=l.headers||{};l.headers={...n,Authorization:`Bearer ${t}`}}}}},async onResponseError({request:l,response:t,options:n}){var I;const i=n;if(t.status===401&&typeof window<"u"){if(i!=null&&i._retry?console.warn("üî¥ Request retried and still unauthorized, redirecting to login"):i._retry=!0,localStorage.getItem("auth_refresh_token")&&!(i!=null&&i._forceLogout)&&(console.log("üîê Received 401, attempting to refresh token..."),await j())){const _=localStorage.getItem("auth_token");if(_){const A=n.headers||{};return n.headers={...A,Authorization:`Bearer ${_}`},console.log("‚úÖ Token refreshed, retrying original request"),await s(l,n)}}console.warn("üî¥ Authentication token expired or invalid, redirecting to login"),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),T?T("/",{replace:!0}):window.location.href="/"}const x=(typeof l=="string"?l:l.url).includes("/auth/");if(t.status===409&&typeof window<"u"&&x&&(console.log("‚ö†Ô∏è  Received 409 Conflict on auth request - token refresh in progress, waiting..."),localStorage.getItem("auth_refresh_token")&&window.__refreshTokenPromise)){console.log("‚è≥ Waiting for active refresh to complete..."),await window.__refreshTokenPromise;const m=localStorage.getItem("auth_token");if(m){const _=n.headers||{};return n.headers={..._,Authorization:`Bearer ${m}`},i!=null&&i._retry||(i._retry=!0),console.log("‚úÖ Refresh completed, retrying original request"),await s(l,n)}}if(t.status===429&&typeof window<"u"){const k=((I=t.headers)==null?void 0:I.get("retry-after"))||"60";console.warn(`Rate limit exceeded. Retry after ${k} seconds`)}if([502,503,504].includes(t.status)&&typeof window<"u"){const k=t.status===502?"Bad Gateway":t.status===503?"Service Unavailable":"Gateway Timeout";console.error(`‚ùå ${k} (${t.status}):`,{url:l,status:t.status,statusText:t.statusText,message:"Backend server is not responding. Please try again later."})}typeof window<"u"&&t.status>=500&&console.error(`‚ùå Server error (${t.status}):`,{url:l,status:t.status,statusText:t.statusText})}});return s},R=o=>{var a;const s=(o==null?void 0:o.status)||(o==null?void 0:o.statusCode)||((a=o==null?void 0:o.response)==null?void 0:a.status)||0;return s===502?{error:"bad_gateway",message:"–°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."}:s===503?{error:"service_unavailable",message:"–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."}:s===504?{error:"gateway_timeout",message:"–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."}:!o.response&&!o.data&&o.message&&(o.message.includes("fetch")||o.message.includes("network")||o.message.includes("Failed to fetch"))?{error:"network_error",message:"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."}:o.data&&typeof o.data=="object"?{error:o.data.error||"unknown_error",message:o.data.message||o.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞",details:o.data.details,retry_after:o.data.retry_after}:{error:"unknown_error",message:o.message||"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞"}},b=o=>{try{const s=o.split(".");if(s.length!==3)return null;const l=s[1].replace(/-/g,"+").replace(/_/g,"/"),t=atob(l);return JSON.parse(t)}catch(s){return console.error("Failed to decode JWT token:",s),null}},E=o=>{const s=b(o);if(!s||!s.exp)return!0;const a=s.exp*1e3;return Date.now()>=a-3e4},$=o=>!(!o||o.split(".").length!==3||E(o)),B=()=>{const o=U(),s=y(null),a=y(null),l=y(null),t=y(null),n=y(!1),i=y(null);let f=null;typeof window<"u"&&window.__refreshTokenPromise&&(f=window.__refreshTokenPromise);const x=async u=>{try{n.value=!0,i.value=null;const e=await o("/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:u});if(s.value=e.token,e.refresh_token&&(a.value=e.refresh_token,localStorage.setItem("auth_refresh_token",e.refresh_token)),e.user){const c={...e.user,scopes:Array.isArray(e.user.scopes)?e.user.scopes:[]};l.value=c,localStorage.setItem("auth_user",JSON.stringify(c))}return e.tenant&&(t.value=e.tenant,localStorage.setItem("auth_tenant",JSON.stringify(e.tenant))),localStorage.setItem("auth_token",e.token),console.log("Register response structure:",{has_token:!!e.token,has_refresh_token:!!e.refresh_token,has_user:!!e.user,has_tenant:!!e.tenant}),e}catch(e){const c=R(e);let d=c.message;if(c.details){const r=Object.entries(c.details).map(([g,h])=>`${g}: ${h.join(", ")}`).join("; ");d=`${d}. ${r}`}throw i.value=d,e.apiError=c,e}finally{n.value=!1}},I=async u=>{try{n.value=!0,i.value=null;const e=await o("/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:u});if(s.value=e.token,e.refresh_token&&(a.value=e.refresh_token,localStorage.setItem("auth_refresh_token",e.refresh_token)),e.user){const c={...e.user,scopes:Array.isArray(e.user.scopes)?e.user.scopes:[]};l.value=c,localStorage.setItem("auth_user",JSON.stringify(c))}return e.tenant&&(t.value=e.tenant,localStorage.setItem("auth_tenant",JSON.stringify(e.tenant))),localStorage.setItem("auth_token",e.token),console.log("Login response structure:",{has_token:!!e.token,has_refresh_token:!!e.refresh_token,has_user:!!e.user,has_tenant:!!e.tenant}),e}catch(e){const c=R(e);let d=c.message;if(c.details){const r=Object.entries(c.details).map(([g,h])=>`${g}: ${h.join(", ")}`).join("; ");d=`${d}. ${r}`}throw i.value=d,e.apiError=c,e}finally{n.value=!1}},k=async u=>{try{n.value=!0,i.value=null;const e=await o("/auth/token",{method:"POST",headers:{"x-api-key":u,"Content-Type":"application/json"},body:{api_key:u}});return s.value=e.token,e.refresh_token&&(a.value=e.refresh_token,localStorage.setItem("auth_refresh_token",e.refresh_token)),localStorage.setItem("auth_token",e.token),console.log("API Key token response structure:",{has_token:!!e.token,has_refresh_token:!!e.refresh_token,full_response:e}),e}catch(e){const c=R(e);throw i.value=c.message,e.apiError=c,e}finally{n.value=!1}},m=async(u=0)=>a.value?f?(console.log("üîÑ Refresh already in progress, waiting for result..."),f):typeof window<"u"&&window.__refreshTokenPromise?(console.log("üîÑ Refresh already in progress (from useApiFetch), waiting for result..."),f=window.__refreshTokenPromise,f):(f=(async()=>{var e,c,d;try{n.value=!0,i.value=null;const r=a.value;if(!r)return console.warn("‚ö†Ô∏è  Refresh token lost during refresh attempt"),!1;console.log(`üîÑ Attempting to refresh token (attempt ${u+1})...`);const{public:{apiBase:g}}=P(),h=await fetch(`${g}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:r})});if(h.status===409)if(console.log("‚ö†Ô∏è  Received 409 Conflict - token is being processed by another request"),u<3){const p=Math.min(1e3*Math.pow(2,u),5e3);return console.log(`‚è≥ Waiting ${p}ms before retry...`),await new Promise(S=>setTimeout(S,p)),f=null,m(u+1)}else throw console.error("‚ùå Max retries reached for 409 Conflict"),new Error(`Refresh failed with status ${h.status} after ${u+1} retries`);if(!h.ok){const p=await h.text().catch(()=>"");let S={};try{S=p?JSON.parse(p):{}}catch{}throw console.error(`‚ùå Refresh failed with status ${h.status}:`,{status:h.status,statusText:h.statusText,error:S}),{status:h.status,statusCode:h.status,message:`Refresh failed with status ${h.status}`,data:S}}const w=await h.json();return w.refresh_token?(a.value=w.refresh_token,localStorage.setItem("auth_refresh_token",w.refresh_token),console.log("‚úÖ Refresh token updated in storage")):console.warn("‚ö†Ô∏è  Server did not return refresh_token in response"),s.value=w.token,localStorage.setItem("auth_token",w.token),console.log("‚úÖ Access token refreshed successfully"),!0}catch(r){console.error("‚ùå Failed to refresh token:",{error:r,message:r==null?void 0:r.message,status:(r==null?void 0:r.status)||(r==null?void 0:r.statusCode)});const g=(r==null?void 0:r.status)||(r==null?void 0:r.statusCode)||((e=r==null?void 0:r.response)==null?void 0:e.status)||((c=r==null?void 0:r.message)!=null&&c.includes("status")?parseInt(((d=r.message.match(/\d+/))==null?void 0:d[0])||"0"):0);return g===401||g===403?(console.warn("üî¥ Refresh token invalid or expired, logging out"),_()):g===409?console.warn("‚ö†Ô∏è  409 Conflict during refresh, will retry if possible"):g===500?(console.warn("‚ö†Ô∏è  Server error during token refresh (500), keeping current session"),console.warn("   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç—É, –Ω–æ —Å–µ—Å—Å–∏—è –º–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞")):console.warn("‚ö†Ô∏è  Error during token refresh, keeping current session"),!1}finally{n.value=!1,f=null,typeof window<"u"&&window.__refreshTokenPromise===f&&(window.__refreshTokenPromise=null)}})(),typeof window<"u"&&(window.__refreshTokenPromise=f),f):(console.warn("‚ö†Ô∏è  No refresh token available"),!1),_=()=>{s.value=null,a.value=null,l.value=null,t.value=null,localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),window.location.href="/",i.value=null},A=async()=>{const u=localStorage.getItem("auth_token"),e=localStorage.getItem("auth_refresh_token"),c=localStorage.getItem("auth_user"),d=localStorage.getItem("auth_tenant");if(e&&(a.value=e),u&&$(u)){s.value=u;const r=b(u);if(r&&r.exp){const g=r.exp*1e3,h=Date.now(),w=g-h,p=5*60*1e3;w<p&&a.value&&(console.log("Access token expires soon, refreshing..."),await m())}}else if(u)if(a.value){if(console.log("Access token expired, attempting refresh..."),!await m()){console.warn("Failed to refresh token, clearing auth data"),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),s.value=null,a.value=null,l.value=null,t.value=null;return}}else{console.warn("Token expired or invalid, no refresh token available, clearing auth data"),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),s.value=null,a.value=null,l.value=null,t.value=null;return}if(c)try{const r=JSON.parse(c);Array.isArray(r.scopes)||(r.scopes=[]),l.value=r}catch(r){console.error("Failed to parse saved user data",r)}if(d)try{t.value=JSON.parse(d)}catch(r){console.error("Failed to parse saved tenant data",r)}};return J(()=>{A()}),{token:v(s),refreshToken:v(a),user:v(l),tenant:v(t),isLoading:v(n),error:v(i),register:x,login:I,loginWithApiKey:k,refreshAccessToken:m,logout:_,isAuthenticated:O(()=>s.value?$(s.value)?!0:a.value?(m().catch(()=>{localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),s.value=null,a.value=null,l.value=null,t.value=null}),!!a.value):(localStorage.removeItem("auth_token"),localStorage.removeItem("auth_refresh_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),s.value=null,a.value=null,l.value=null,t.value=null,!1):!1),decodeToken:u=>u?b(u):null,isTokenExpired:u=>u?E(u):!0,isTokenValid:u=>$(u)}};export{B as a,U as u};
