import{m as ae,$ as Be,r as E,Q as lt,Y as ge,f as K,S as Je,u as L,D as j,a0 as it,a1 as ct,n as X,o as p,c as D,q as Ce,a as i,A as z,b as P,t as H,p as J,x as B,y as Se,w as oe,a2 as Ve,d as ye,T as le,s as Ie,v as Le,K as rt,M as fe,a3 as dt,_ as Ee,H as $e,F as ie,I as Re,B as ut,J as gt,X as ft,E as mt,G as vt}from"./entry.DvavCQ8-.js";import{u as pt}from"./useAgents.CkkebVYB.js";import{u as Ge,a as ht}from"./useAuth.CA-oUVg2.js";import{a as xe,M as xt,_ as Fe}from"./DashboardSidebar.vue.BCFNDxq8.js";import{M as yt,S as bt}from"./search.CPoPIkm0.js";import{T as kt,C as Ke,M as St,S as _t}from"./index.DVIFlGhQ.js";import{C as $t}from"./chevron-down.ouWuK6l7.js";import{P as Ye}from"./plus.FDCCvd0I.js";import{L as be,_ as Mt}from"./AuthModal.vue.Bphu0Ye4.js";import{A as Oe}from"./alert-circle.40sqdf6a.js";import"./nuxt-link.De5AyltM.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const At=ae("ArrowDownIcon",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=ae("ArrowLeftIcon",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dt=ae("ImageIcon",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wt=ae("MessageCircleIcon",[["path",{d:"m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z",key:"v2veuj"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=ae("MicIcon",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rt=ae("PauseIcon",[["rect",{width:"4",height:"16",x:"6",y:"4",key:"iffhe4"}],["rect",{width:"4",height:"16",x:"14",y:"4",key:"sjin7j"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=ae("PencilIcon",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=ae("PlayIcon",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]),R=lt([]),pe=E(!1),se=E(null),Me=E(null),ke=()=>{const e=Ge();return{dialogs:R,isLoading:pe,error:se,currentAgentId:Me,fetchDialogs:async(n,s)=>{var c,C;if(!n){console.warn("[useDialogs] fetchDialogs called without agentId");return}pe.value=!0,se.value=null,Me.value=n;try{const u=new URLSearchParams;(s==null?void 0:s.archived)!==void 0&&u.set("archived",String(s.archived));const A=u.toString(),N=`agents/${n}/dialogs${A?`?${A}`:""}`;console.log(`[useDialogs] Fetching dialogs from: ${N}`);const l=await e(N);console.log("[useDialogs] Raw response:",l),console.log("[useDialogs] Response type:",Array.isArray(l)?"array":typeof l);let t=[];Array.isArray(l)?t=l:l&&typeof l=="object"&&"dialogs"in l?t=l.dialogs||[]:l&&typeof l=="object"&&"items"in l&&(t=l.items||[]),console.log(`[useDialogs] Received ${t.length} dialogs`,{agentId:n,dialogs:t}),R.value=t,Be(R),console.log("[useDialogs] dialogs.value set to:",R.value)}catch(u){console.error("[useDialogs] Error fetching dialogs:",u),console.error("[useDialogs] Error details:",{status:(u==null?void 0:u.statusCode)||(u==null?void 0:u.status),data:u==null?void 0:u.data,message:u==null?void 0:u.message});const A=((c=u==null?void 0:u.data)==null?void 0:c.detail)??((C=u==null?void 0:u.data)==null?void 0:C.message)??(u==null?void 0:u.message)??"Не удалось загрузить диалоги";se.value=typeof A=="string"?A:JSON.stringify(A),R.value=[],Be(R)}finally{pe.value=!1}},createDialog:async(n,s)=>{var c,C;if(!n)return null;pe.value=!0,se.value=null;try{const u=await e(`agents/${n}/dialogs`,{method:"POST",headers:{"Content-Type":"application/json"},body:s||{}});return R.value=[u,...R.value],u}catch(u){const A=((c=u==null?void 0:u.data)==null?void 0:c.detail)??((C=u==null?void 0:u.data)==null?void 0:C.message)??(u==null?void 0:u.message)??"Не удалось создать диалог";return se.value=typeof A=="string"?A:JSON.stringify(A),null}finally{pe.value=!1}},updateDialog:async(n,s,c)=>{var C,u;if(!n||!s)return null;try{const A=await e(`agents/${n}/dialogs/${s}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:c}),N=R.value.findIndex(l=>l.id===s);return N!==-1&&(R.value[N]=A),A}catch(A){const N=((C=A==null?void 0:A.data)==null?void 0:C.detail)??((u=A==null?void 0:A.data)==null?void 0:u.message)??(A==null?void 0:A.message)??"Не удалось обновить диалог";return se.value=typeof N=="string"?N:JSON.stringify(N),null}},deleteDialog:async(n,s)=>{var c,C;if(!n||!s)return!1;try{return await e(`agents/${n}/dialogs/${s}`,{method:"DELETE"}),R.value=R.value.filter(u=>u.id!==s),!0}catch(u){const A=((c=u==null?void 0:u.data)==null?void 0:c.detail)??((C=u==null?void 0:u.data)==null?void 0:C.message)??(u==null?void 0:u.message)??"Не удалось удалить диалог";return se.value=typeof A=="string"?A:JSON.stringify(A),!1}},upsertDialog:n=>{const s=n.id||n.session_id;if(!s)return;const c=R.value.findIndex(u=>u.id===s),C={...c!==-1?R.value[c]:{},id:s,title:n.title||(c!==-1?R.value[c].title:"Новый диалог"),last_message_preview:n.last_message_preview||n.content||(c!==-1?R.value[c].last_message_preview:""),last_message_at:n.last_message_at||n.created_at||(c!==-1?R.value[c].last_message_at:new Date().toISOString()),unread_count:n.is_new?c!==-1?R.value[c].unread_count+1:1:c!==-1?R.value[c].unread_count:0,status:n.status||(c!==-1?R.value[c].status:"NORMAL"),created_at:n.created_at||(c!==-1?R.value[c].created_at:new Date().toISOString()),updated_at:new Date().toISOString()};if(c!==-1){R.value[c]=C;const[u]=R.value.splice(c,1);R.value.unshift(u)}else R.value.unshift(C)},updateDialogStatus:(n,s)=>{const c=R.value.findIndex(C=>C.id===n);c!==-1&&(R.value[c]={...R.value[c],status:s})},updateLastMessage:(n,s,c)=>{const C=R.value.findIndex(u=>u.id===n);if(C!==-1){R.value[C]={...R.value[C],last_message_preview:s,last_message_at:c};const u=R.value.splice(C,1)[0];R.value.unshift(u)}},incrementUnread:n=>{const s=R.value.findIndex(c=>c.id===n);s!==-1&&(R.value[s]={...R.value[s],unread_count:R.value[s].unread_count+1})},markAsRead:n=>{const s=R.value.findIndex(c=>c.id===n);s!==-1&&(R.value[s]={...R.value[s],unread_count:0})},getDialogById:n=>R.value.find(s=>s.id===n),clearDialogs:()=>{R.value=[],Me.value=null,se.value=null}}},U=E({}),q=(e,a)=>{U.value={...U.value,[e]:a}},Ae=E(!1),re=E(!1),de=E(!1),ue=E(null),ne=E(null),De=E(new Map),Et=(e,a)=>{const d=a.isUser??a.is_user,m=a.isAgent??a.is_agent;if(typeof d=="boolean")return d?"user":"agent";if(typeof m=="boolean")return m?"agent":"user";if(typeof e=="string"){const g=e.toLowerCase();if(["user","human","client","customer","visitor","requester"].includes(g))return"user";if(["agent","assistant","bot","ai","system"].includes(g))return"agent"}return"agent"},Ot=e=>{if(typeof e=="string"){const a=e.toLowerCase();if(a.includes("image")||a.includes("photo")||a.includes("img"))return"image";if(a.includes("voice")||a.includes("audio")||a.includes("wav")||a.includes("mp3"))return"voice"}return"text"},Pt=e=>{if(typeof e!="string")return"sent";const a=e.toLowerCase();return a==="sending"?"sending":a==="failed"?"failed":a==="streaming"?"streaming":a==="done"?"done":"sent"},ze=(e,a)=>{var s;const d=(e==null?void 0:e.dialog_id)??(e==null?void 0:e.dialogId)??(e==null?void 0:e.session_id)??(e==null?void 0:e.sessionId)??a,m=(e==null?void 0:e.id)??(e==null?void 0:e.message_id)??(e==null?void 0:e.messageId)??(e==null?void 0:e.uuid)??(e==null?void 0:e._id)??`${d}-${(e==null?void 0:e.created_at)??(e==null?void 0:e.createdAt)??Date.now()}`,g=(e==null?void 0:e.role)??(e==null?void 0:e.sender)??(e==null?void 0:e.author)??(e==null?void 0:e.from)??(e==null?void 0:e.actor)??(e==null?void 0:e.direction),h=Et(g,{isUser:e==null?void 0:e.isUser,is_user:e==null?void 0:e.is_user,isAgent:e==null?void 0:e.isAgent,is_agent:e==null?void 0:e.is_agent}),f=Ot((e==null?void 0:e.type)??(e==null?void 0:e.message_type)??(e==null?void 0:e.content_type)??(e==null?void 0:e.kind)??(e==null?void 0:e.media_type)),$=(e==null?void 0:e.content)??(e==null?void 0:e.text)??(e==null?void 0:e.message)??(e==null?void 0:e.body)??(e==null?void 0:e.payload)??((s=e==null?void 0:e.data)==null?void 0:s.content)??"",S=typeof $=="string"?$:JSON.stringify($),w=(e==null?void 0:e.created_at)??(e==null?void 0:e.createdAt)??(e==null?void 0:e.timestamp)??(e==null?void 0:e.time)??(e==null?void 0:e.created)??new Date().toISOString(),k=Pt(e==null?void 0:e.status),y=(e==null?void 0:e.duration_seconds)??(e==null?void 0:e.durationSeconds)??(e==null?void 0:e.duration),n=typeof y=="number"?y:Number.isFinite(Number(y))?Number(y):void 0;return{id:String(m),dialog_id:String(d),role:h,type:f,content:String(S),status:k,duration_seconds:n,created_at:String(w)}},Xe=()=>{const e=Ge(),{updateDialogStatus:a,updateLastMessage:d}=ke(),m=l=>{const t=U.value[l]||[];return console.log(`[useMessages] getMessages(${l}):`,t.length,"messages"),t},g=async(l,t,x)=>{var v,r,b;if(!l||!t){console.warn("[useMessages] Missing agentId or dialogId:",{agentId:l,dialogId:t});return}Ae.value=!0,ne.value=null;let o=!1;try{const _=new URLSearchParams;x!=null&&x.before&&_.set("before",x.before),x!=null&&x.limit&&_.set("limit",String(x.limit));const I=_.toString(),O=encodeURIComponent(t),T=`agents/${l}/dialogs/${O}/messages${I?`?${I}`:""}`;console.log(`[useMessages] Fetching history from: ${T}`),console.log(`[useMessages] Original dialogId: ${t}, encoded: ${O}`);const M=await e(T,{method:"GET"});console.log("[useMessages] Raw response:",M),console.log("[useMessages] Response type:",Array.isArray(M)?"array":typeof M);let W=[];Array.isArray(M)?(W=M,o=!1):M&&typeof M=="object"&&"messages"in M?(W=M.messages||[],o=M.has_more||!1):M&&typeof M=="object"&&"items"in M?(W=M.items||[],o=M.has_more||!1):M&&typeof M=="object"&&"data"in M?(W=M.data||[],o=M.has_more||!1):console.error("[useMessages] Unexpected response format:",M),W=W.map(Z=>ze(Z,t)),console.log(`[useMessages] Received ${W.length} messages`,{hasMore:o,dialogId:t});const F=U.value[t]||[];x!=null&&x.before?q(t,[...W,...F]):q(t,W),console.log(`[useMessages] Messages set for ${t}:`,(v=U.value[t])==null?void 0:v.length),De.value.set(t,o)}catch(_){const I=((r=_==null?void 0:_.data)==null?void 0:r.detail)??((b=_==null?void 0:_.data)==null?void 0:b.message)??(_==null?void 0:_.message)??"Не удалось загрузить сообщения";ne.value=typeof I=="string"?I:JSON.stringify(I)}finally{Ae.value=!1}},h=async(l,t,x,o="text",v=!0)=>{var I,O;if(!l||!t||!x.trim())return null;re.value=!0,ne.value=null;const r=`temp-${Date.now()}`,b={id:r,dialog_id:t,role:"user",type:o,content:x.trim(),status:"sending",created_at:new Date().toISOString()},_=U.value[t]||[];q(t,[..._,b]);try{const T={content:x.trim(),type:o},M=await e(`agents/${l}/dialogs/${t}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:T}),W=U.value[t]||[],V=W.findIndex(F=>F.id===r);if(V!==-1){const F=[...W];F[V]={...M,status:"sent"},q(t,F)}return d(t,x.trim().slice(0,100),M.created_at),v&&await s(l,t,M.id),M}catch(T){const M=U.value[t]||[],W=M.findIndex(F=>F.id===r);if(W!==-1){const F=[...M];F[W]={...F[W],status:"failed",error_message:(T==null?void 0:T.message)||"Ошибка отправки"},q(t,F)}const V=((I=T==null?void 0:T.data)==null?void 0:I.detail)??((O=T==null?void 0:T.data)==null?void 0:O.message)??(T==null?void 0:T.message)??"Не удалось отправить сообщение";return ne.value=typeof V=="string"?V:JSON.stringify(V),null}finally{re.value=!1}},f=async(l,t,x,o=!0)=>{const v=U.value[t]||[],r=v.find(b=>b.id===x);!r||r.status!=="failed"||(q(t,v.filter(b=>b.id!==x)),await h(l,t,r.content,r.type,o))},$=(l,t,x="text")=>{const o=`temp-${Date.now()}`,v={id:o,dialog_id:l,role:"user",type:x,content:t.trim(),status:"sending",created_at:new Date().toISOString()},r=U.value[l]||[];return q(l,[...r,v]),re.value=!0,o},S=(l,t,x)=>{const o=U.value[l]||[],v=o.findIndex(r=>r.id===t);if(v!==-1){const r=[...o];r[v]={...r[v],id:x||t,status:"sent"},q(l,r)}re.value=!1},w=(l,t,x)=>{const o=U.value[l]||[],v=o.findIndex(r=>r.id===t);if(v!==-1){const r=[...o];r[v]={...r[v],status:"failed",error_message:x||"Ошибка отправки"},q(l,r)}re.value=!1,ne.value=x||"Ошибка отправки"},k=(l,t)=>{de.value=!0;const x=`agent-${l}`;ue.value=x;const o={id:x,dialog_id:t,role:"agent",type:"text",content:"",status:"streaming",created_at:new Date().toISOString()},v=U.value[t]||[];q(t,[...v,o])},y=(l,t,x)=>{const o=`agent-${l}`,v=U.value[t]||[],r=v.findIndex(b=>b.id===o);if(r!==-1){const b=[...v];b[r]={...b[r],content:x,status:"done"},q(t,b)}de.value=!1,ue.value=null},n=(l,t,x)=>{const o=`agent-${l}`,v=U.value[t]||[],r=v.findIndex(b=>b.id===o);if(r!==-1){const b=[...v];b[r]={...b[r],content:`Ошибка: ${x}`,status:"failed",error_message:x},q(t,b)}de.value=!1,ue.value=null,ne.value=x},s=async(l,t,x)=>{var b,_,I,O,T;de.value=!0,a(t,"IN_PROGRESS");const o=`agent-${Date.now()}`;ue.value=o;const v={id:o,dialog_id:t,role:"agent",type:"text",content:"",status:"streaming",created_at:new Date().toISOString()},r=U.value[t]||[];q(t,[...r,v]);try{const M=typeof window<"u"?localStorage.getItem("auth_token"):null,W=await fetch(`/api/v1/agents/${l}/dialogs/${t}/messages/stream`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream",...M?{Authorization:`Bearer ${M}`}:{}},body:JSON.stringify({user_message_id:x})});if(!W.ok)throw new Error(`Stream error: ${W.status}`);const V=(b=W.body)==null?void 0:b.getReader();if(!V)throw new Error("No reader available");const F=new TextDecoder;let Z="";for(;;){const{done:ee,value:ot}=await V.read();if(ee)break;Z+=F.decode(ot,{stream:!0});const je=Z.split(`
`);Z=je.pop()||"";for(const We of je)if(We.startsWith("data: ")){const Ue=We.slice(6);if(Ue==="[DONE]")continue;try{const Y=JSON.parse(Ue);if(Y.type==="delta"&&((_=Y.data)!=null&&_.content)){const ve=U.value[t]||[],te=ve.findIndex(G=>G.id===o);if(te!==-1){const G=[...ve];G[te]={...G[te],content:G[te].content+Y.data.content},q(t,G)}}else if(Y.type==="done"){const ve=U.value[t]||[],te=ve.findIndex(G=>G.id===o);if(te!==-1){const G=[...ve];G[te]={...G[te],id:((I=Y.data)==null?void 0:I.message_id)||o,status:"done"},q(t,G)}}else if(Y.type==="error")throw new Error(((O=Y.data)==null?void 0:O.error)||"Stream error")}catch(Y){console.warn("Failed to parse SSE event:",Y)}}}const ce=U.value[t]||[],me=ce.findIndex(ee=>ee.id===o||ee.status==="streaming");if(me!==-1&&ce[me].status==="streaming"){const ee=[...ce];ee[me]={...ee[me],status:"done"},q(t,ee)}const Ne=((T=ce[me])==null?void 0:T.content)||"";Ne&&d(t,Ne.slice(0,100),new Date().toISOString()),a(t,"NORMAL")}catch(M){console.error("Stream error:",M);const W=U.value[t]||[],V=W.findIndex(F=>F.id===o);if(V!==-1){const F=W.filter((Z,ce)=>ce!==V);q(t,F)}a(t,"ERROR"),ne.value=(M==null?void 0:M.message)||"Ошибка получения ответа агента"}finally{de.value=!1,ue.value=null}},c=(l,t)=>{const x=U.value[l]||[];q(l,[...x,t])},C=(l,t,x)=>{const o=U.value[l]||[],v=o.findIndex(r=>r.id===t);if(v!==-1){const r=[...o];r[v]={...r[v],...x},q(l,r)}},u=l=>{const{[l]:t,...x}=U.value;U.value=x,De.value.delete(l)},A=l=>De.value.get(l)??!0,N=l=>{const t=(l==null?void 0:l.dialog_id)??(l==null?void 0:l.dialogId)??(l==null?void 0:l.session_id)??(l==null?void 0:l.sessionId);if(!t)return;const x=U.value[t]||[],o=ze(l,t);x.find(v=>v.id===o.id)||(q(t,[...x,o]),d(t,o.content.slice(0,100),o.created_at))};return{isLoading:ge(Ae),isSending:ge(re),isStreaming:ge(de),streamingMessageId:ge(ue),error:ge(ne),messagesMap:U,getMessages:m,dialogHasMore:A,fetchMessages:g,sendMessage:h,retryMessage:f,addMessage:c,addIncomingMessage:N,updateMessage:C,clearMessages:u,createOptimisticMessage:$,markMessageSent:S,markMessageFailed:w,handleRunStart:k,handleRunResult:y,handleRunError:n,startAgentStream:s}},Tt={maxAttempts:5,baseDelay:1e3,maxDelay:16e3},Nt=(e,a)=>{const d=ke(),m=Xe(),g={...Tt,...a==null?void 0:a.reconnectConfig},h=E("disconnected"),f=E(0),$=E(null),S=E(null);let w=null,k=null,y=null;const n=_=>{if(typeof window>"u")return null;const I=localStorage.getItem("auth_token");if(!I)return console.error("[WebSocket] No auth token found"),null;const O=window.location.protocol==="https:"?"wss:":"ws:",T=window.location.host;return`${O}//${T}/api/v1/agents/${_}/ws?token=${I}`},s=_=>{if(!w||w.readyState!==WebSocket.OPEN)return console.warn("[WebSocket] Cannot send - connection not open"),!1;try{return w.send(JSON.stringify(_)),!0}catch(I){return console.error("[WebSocket] Send error:",I),!1}},c=_=>{try{const I=JSON.parse(_.data);switch(console.log("[WebSocket] Received:",I.type,I.data),I.type){case"message_created":{const O=I.data;m.addIncomingMessage({id:O.id,dialog_id:O.session_id,role:O.role,content:O.content,created_at:O.created_at,user_info:O.user_info});break}case"dialog_updated":{d.upsertDialog(I.data);break}case"run_start":{const{run_id:O,dialog_id:T}=I.data;$.value=O,S.value=T;const M=`agent-${O}`;m.addMessage(T,{id:M,dialog_id:T,role:"agent",type:"text",content:"",status:"streaming",created_at:new Date().toISOString()}),d.updateDialogStatus(T,"IN_PROGRESS");break}case"run_result":{const{run_id:O,output:T,dialog_id:M,tokens:W,tools_called:V}=I.data,F=`agent-${O}`;m.updateMessage(M,F,{content:T,status:"done"}),d.updateLastMessage(M,T.slice(0,100),new Date().toISOString()),d.updateDialogStatus(M,"NORMAL"),$.value===O&&($.value=null,S.value=null);break}case"run_error":{const{run_id:O,error:T,dialog_id:M}=I.data,W=`agent-${O}`;m.getMessages(M).findIndex(Z=>Z.id===W)!==-1&&m.updateMessage(M,W,{content:`Ошибка: ${T}`,status:"failed",error_message:T}),d.updateDialogStatus(M,"ERROR"),$.value===O&&($.value=null,S.value=null);break}case"ping":{s({type:"pong"}),C();break}case"error":{console.error("[WebSocket] Server error:",I.data.message);break}case"status":{console.log("[WebSocket] Status:",I.data);break}case"dialog_joined":{console.log("[WebSocket] Joined dialog:",I.data.dialog_id);break}case"dialog_left":{console.log("[WebSocket] Left dialog:",I.data.dialog_id);break}default:console.warn("[WebSocket] Unknown message type:",I.type)}}catch(I){console.error("[WebSocket] Error parsing message:",I)}},C=()=>{y&&clearTimeout(y),y=setTimeout(()=>{console.warn("[WebSocket] No ping received in 60s, reconnecting..."),l()},6e4)},u=()=>{if(f.value>=g.maxAttempts){console.error("[WebSocket] Max reconnect attempts reached"),h.value="error";return}const _=Math.min(g.baseDelay*Math.pow(2,f.value),g.maxDelay);console.log(`[WebSocket] Reconnecting in ${_}ms (attempt ${f.value+1}/${g.maxAttempts})`),k=setTimeout(()=>{f.value++,A()},_)},A=()=>{const _=L(e);if(!_||typeof window>"u"){console.warn("[WebSocket] Cannot connect - no agent ID or not in browser");return}N(!1);const I=n(_);if(I){console.log(`[WebSocket] Connecting to ${I.replace(/token=.*/,"token=***")}`),h.value="connecting";try{w=new WebSocket(I),w.onopen=()=>{console.log("[WebSocket] Connected"),h.value="connected",f.value=0,C()},w.onclose=O=>{console.log(`[WebSocket] Closed (code: ${O.code}, reason: ${O.reason})`),h.value="disconnected",y&&(clearTimeout(y),y=null),O.code!==1e3&&O.code!==1008?u():O.code===1008&&(console.error("[WebSocket] Unauthorized - invalid token"),h.value="error")},w.onerror=O=>{console.error("[WebSocket] Error:",O),h.value="error"},w.onmessage=c}catch(O){console.error("[WebSocket] Connection error:",O),h.value="error",u()}}},N=(_=!0)=>{_&&k&&(clearTimeout(k),k=null),y&&(clearTimeout(y),y=null),w&&(console.log("[WebSocket] Disconnecting"),w.close(1e3,"Client closed"),w=null),_&&(h.value="disconnected",f.value=0)},l=()=>{N(!1),f.value=0,A()},t=(_,I)=>s({type:"send_message",dialog_id:_,content:I}),x=_=>s({type:"join_dialog",dialog_id:_}),o=_=>s({type:"leave_dialog",dialog_id:_}),v=()=>s({type:"get_status"});K(()=>L(e),(_,I)=>{_!==I&&(_?A():N())},{immediate:(a==null?void 0:a.autoConnect)!==!1}),Je(()=>{N()});const r=j(()=>h.value==="connected"),b=j(()=>h.value==="connecting");return{connectionState:h,isConnected:r,isConnecting:b,reconnectAttempts:f,connect:A,disconnect:N,reconnect:l,sendMessage:t,joinDialog:x,leaveDialog:o,getStatus:v}};function jt(e){return it()?(ct(e),!0):!1}function Ze(e){return typeof e=="function"?e():L(e)}const et=typeof window<"u"&&typeof document<"u";typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope;const Wt=Object.prototype.toString,Ut=e=>Wt.call(e)==="[object Object]",_e=()=>{},Bt=Ft();function Ft(){var e,a;return et&&((e=window==null?void 0:window.navigator)==null?void 0:e.userAgent)&&(/iP(?:ad|hone|od)/.test(window.navigator.userAgent)||((a=window==null?void 0:window.navigator)==null?void 0:a.maxTouchPoints)>2&&/iPad|Macintosh/.test(window==null?void 0:window.navigator.userAgent))}function he(e){var a;const d=Ze(e);return(a=d==null?void 0:d.$el)!=null?a:d}const tt=et?window:void 0;function we(...e){let a,d,m,g;if(typeof e[0]=="string"||Array.isArray(e[0])?([d,m,g]=e,a=tt):[a,d,m,g]=e,!a)return _e;Array.isArray(d)||(d=[d]),Array.isArray(m)||(m=[m]);const h=[],f=()=>{h.forEach(k=>k()),h.length=0},$=(k,y,n,s)=>(k.addEventListener(y,n,s),()=>k.removeEventListener(y,n,s)),S=K(()=>[he(a),Ze(g)],([k,y])=>{if(f(),!k)return;const n=Ut(y)?{...y}:y;h.push(...d.flatMap(s=>m.map(c=>$(k,s,c,n))))},{immediate:!0,flush:"post"}),w=()=>{S(),f()};return jt(w),w}let qe=!1;function st(e,a,d={}){const{window:m=tt,ignore:g=[],capture:h=!0,detectIframe:f=!1}=d;if(!m)return _e;Bt&&!qe&&(qe=!0,Array.from(m.document.body.children).forEach(n=>n.addEventListener("click",_e)),m.document.documentElement.addEventListener("click",_e));let $=!0;const S=n=>g.some(s=>{if(typeof s=="string")return Array.from(m.document.querySelectorAll(s)).some(c=>c===n.target||n.composedPath().includes(c));{const c=he(s);return c&&(n.target===c||n.composedPath().includes(c))}}),k=[we(m,"click",n=>{const s=he(e);if(!(!s||s===n.target||n.composedPath().includes(s))){if(n.detail===0&&($=!S(n)),!$){$=!0;return}a(n)}},{passive:!0,capture:h}),we(m,"pointerdown",n=>{const s=he(e);$=!S(n)&&!!(s&&!n.composedPath().includes(s))},{passive:!0}),f&&we(m,"blur",n=>{setTimeout(()=>{var s;const c=he(e);((s=m.document.activeElement)==null?void 0:s.tagName)==="IFRAME"&&!(c!=null&&c.contains(m.document.activeElement))&&a(n)},0)})].filter(Boolean);return()=>k.forEach(n=>n())}const nt="agent-enabled-states",Pe=typeof window<"u",zt=()=>{if(!Pe)return{};try{const e=window.localStorage.getItem(nt);return e?JSON.parse(e):{}}catch(e){return console.error("Failed to parse stored agent enabled states:",e),{}}},He=e=>{if(Pe)try{window.localStorage.setItem(nt,JSON.stringify(e))}catch(a){console.error("Failed to persist agent enabled states:",a)}},Q=E(Pe?zt():{}),Te=()=>{const e=g=>Q.value[g]??!0,a=(g,h)=>{Q.value={...Q.value,[g]:h},He(Q.value)},d=g=>{const f=!e(g);return a(g,f),f},m=g=>{if(Q.value[g]!==void 0){const{[g]:h,...f}=Q.value;Q.value=f,He(Q.value)}};return{enabledStates:ge(Q),isAgentEnabled:e,setAgentEnabled:a,toggleAgentEnabled:d,removeAgentState:m}},qt={class:"flex-1 min-w-0"},Ht={class:"flex items-center gap-2"},Jt={class:"text-xs text-slate-500 truncate mt-0.5"},Vt={class:"text-xs text-slate-400 flex-shrink-0"},Gt={key:0,class:"fixed inset-0 z-[110] flex items-center justify-center p-4"},Kt={class:"relative bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full"},Yt={class:"flex gap-3 mt-4"},Qt=["disabled"],Xt={key:0,class:"fixed inset-0 z-[110] flex items-center justify-center p-4"},Zt={class:"relative bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full"},es={class:"flex gap-3"},ts=X({__name:"DialogItem",props:{dialog:{},isSelected:{type:Boolean},agentEnabled:{type:Boolean}},emits:["click","rename","delete"],setup(e,{emit:a}){const d=e,m=a,g=E(!1),h=E(null),f=E({x:0,y:0}),$=E(!1),S=E(""),w=E(null),k=E(!1);st(h,()=>{g.value=!1});const y=j(()=>d.dialog.title||"Диалог"),n=j(()=>{if(!d.dialog.last_message_at)return"";const l=new Date(d.dialog.last_message_at),x=new Date().getTime()-l.getTime(),o=Math.floor(x/(1e3*60*60*24));return o===0?l.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}):o===1?"Вчера":o<7?l.toLocaleDateString("ru-RU",{weekday:"short"}):l.toLocaleDateString("ru-RU",{day:"numeric",month:"short"})}),s=j(()=>{const l=d.dialog.status;return l==="IN_PROGRESS"&&!d.agentEnabled?d.dialog.unread_count>0?"UNREAD":null:l==="IN_PROGRESS"?"IN_PROGRESS":l==="ERROR"?"ERROR":d.dialog.unread_count>0?"UNREAD":l==="NEW"?"NEW":null}),c=l=>{l.preventDefault(),f.value={x:l.clientX,y:l.clientY},g.value=!0},C=()=>{g.value=!1,S.value=d.dialog.title||"",$.value=!0,fe(()=>{var l,t;(l=w.value)==null||l.focus(),(t=w.value)==null||t.select()})},u=()=>{S.value.trim()&&(m("rename",d.dialog.id,S.value.trim()),$.value=!1)},A=()=>{g.value=!1,k.value=!0},N=()=>{m("delete",d.dialog.id),k.value=!1};return(l,t)=>{const x=dt("StatusIndicator");return p(),D("div",{class:"relative group",onContextmenu:Ce(c,["prevent"])},[i("button",{onClick:t[0]||(t[0]=o=>l.$emit("click")),class:z(["w-full px-4 py-3 flex items-start gap-3 text-left transition-colors",[e.isSelected?"bg-indigo-50":"hover:bg-slate-50"]])},[i("div",{class:z(["w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0",[e.isSelected?"bg-indigo-100":"bg-slate-100"]])},[P(L(xe),{class:z(["w-5 h-5",[e.isSelected?"text-indigo-600":"text-slate-500"]])},null,8,["class"])],2),i("div",qt,[i("div",Ht,[i("h3",{class:z(["text-sm font-semibold truncate",[e.isSelected?"text-indigo-900":"text-slate-900"]])},H(y.value),3),s.value?(p(),J(x,{key:0,status:s.value,count:e.dialog.unread_count},null,8,["status","count"])):B("",!0)]),i("p",Jt,H(e.dialog.last_message_preview||"Нет сообщений"),1)]),i("span",Vt,H(n.value),1)],2),i("button",{onClick:Ce(c,["stop"]),class:"absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-lg opacity-0 group-hover:opacity-100 hover:bg-slate-200 transition-opacity lg:block hidden"},[P(L(yt),{class:"w-4 h-4 text-slate-500"})]),(p(),J(Se,{to:"body"},[P(le,{"enter-active-class":"transition duration-100 ease-out","enter-from-class":"opacity-0 scale-95","enter-to-class":"opacity-100 scale-100","leave-active-class":"transition duration-75 ease-in","leave-from-class":"opacity-100 scale-100","leave-to-class":"opacity-0 scale-95"},{default:oe(()=>[g.value?(p(),D("div",{key:0,ref_key:"contextMenuRef",ref:h,class:"fixed bg-white rounded-xl shadow-lg border border-slate-200 py-1 z-[100] min-w-[160px]",style:Ve({top:`${f.value.y}px`,left:`${f.value.x}px`})},[i("button",{onClick:C,class:"w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2"},[P(L(It),{class:"w-4 h-4"}),t[6]||(t[6]=ye(" Переименовать ",-1))]),i("button",{onClick:A,class:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"},[P(L(kt),{class:"w-4 h-4"}),t[7]||(t[7]=ye(" Удалить ",-1))])],4)):B("",!0)]),_:1})])),(p(),J(Se,{to:"body"},[P(le,{name:"modal-fade"},{default:oe(()=>[$.value?(p(),D("div",Gt,[i("div",{class:"absolute inset-0 bg-black/50",onClick:t[1]||(t[1]=o=>$.value=!1)}),i("div",Kt,[t[8]||(t[8]=i("h3",{class:"text-lg font-bold text-slate-900 mb-4"},"Переименовать диалог",-1)),Ie(i("input",{"onUpdate:modelValue":t[2]||(t[2]=o=>S.value=o),type:"text",placeholder:"Название диалога",class:"w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent",onKeyup:rt(u,["enter"]),ref_key:"renameInputRef",ref:w},null,544),[[Le,S.value]]),i("div",Yt,[i("button",{onClick:t[3]||(t[3]=o=>$.value=!1),class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors"}," Отмена "),i("button",{onClick:u,disabled:!S.value.trim(),class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors"}," Сохранить ",8,Qt)])])])):B("",!0)]),_:1})])),(p(),J(Se,{to:"body"},[P(le,{name:"modal-fade"},{default:oe(()=>[k.value?(p(),D("div",Xt,[i("div",{class:"absolute inset-0 bg-black/50",onClick:t[4]||(t[4]=o=>k.value=!1)}),i("div",Zt,[t[9]||(t[9]=i("h3",{class:"text-lg font-bold text-slate-900 mb-2"},"Удалить диалог?",-1)),t[10]||(t[10]=i("p",{class:"text-sm text-slate-500 mb-6"}," Это действие нельзя отменить. Все сообщения будут удалены. ",-1)),i("div",es,[i("button",{onClick:t[5]||(t[5]=o=>k.value=!1),class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors"}," Отмена "),i("button",{onClick:N,class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-bold text-white bg-red-600 hover:bg-red-700 transition-colors"}," Удалить ")])])])):B("",!0)]),_:1})]))],32)}}}),ss=Ee(ts,[["__scopeId","data-v-315e093e"]]),ns={class:"h-full flex flex-col"},as={class:"p-4 border-b border-slate-200"},os={class:"w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"},ls={class:"text-white font-bold text-sm"},is={class:"flex-1 text-left min-w-0"},cs={class:"text-sm font-semibold text-slate-900 truncate"},rs={class:"text-xs text-slate-500"},ds={key:0,class:"absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-lg border border-slate-200 z-50 max-h-64 overflow-y-auto"},us={class:"p-2"},gs=["onClick"],fs={class:"w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"},ms={class:"text-white font-bold text-xs"},vs={class:"text-sm font-medium truncate"},ps={key:0,class:"px-3 py-4 text-center text-sm text-slate-500"},hs={class:"px-4 py-3"},xs={class:"relative"},ys={class:"px-4 pb-3"},bs=["disabled"],ks={class:"flex-1 overflow-y-auto"},Ss={key:0,class:"flex items-center justify-center py-8"},_s={key:1,class:"px-4 py-8 text-center"},$s={class:"text-sm text-slate-500"},Ms={key:2,class:"divide-y divide-slate-100"},As=X({__name:"DialogsSidebar",props:{agents:{},selectedAgentId:{},selectedDialogId:{},isLoading:{type:Boolean}},emits:["select-agent","select-dialog","create-dialog"],setup(e,{emit:a}){$e(()=>{console.log("=== [DialogsSidebar] MOUNTED === BUILD v2"),console.log("[DialogsSidebar] Initial dialogs:",g.value),console.log("[DialogsSidebar] dialogs ref:",g)});const d=e,m=a,{dialogs:g,isLoading:h,updateDialog:f,deleteDialog:$}=ke(),{isAgentEnabled:S}=Te(),w=E(null),k=E(!1),y=E("");st(w,()=>{k.value=!1});const n=j(()=>d.agents.find(o=>o.id===d.selectedAgentId)),s=j(()=>{var o;return((o=n.value)==null?void 0:o.name)||"Выберите агента"}),c=j(()=>{var o;return N(((o=n.value)==null?void 0:o.name)||"")}),C=j(()=>d.selectedAgentId?S(d.selectedAgentId):!0),u=j(()=>{const o=d.agents.length;return o===1?"агент":o>=2&&o<=4?"агента":"агентов"}),A=j(()=>{if(console.log("[DialogsSidebar] dialogs.value:",g.value),console.log("[DialogsSidebar] dialogs.value.length:",g.value.length),!y.value.trim())return g.value;const o=y.value.toLowerCase();return g.value.filter(v=>{const r=v.title||"Диалог",b=v.last_message_preview||"";return r.toLowerCase().includes(o)||b.toLowerCase().includes(o)})}),N=o=>o?o.split(" ").map(v=>v.charAt(0)).join("").toUpperCase().slice(0,2):"?",l=o=>{k.value=!1,m("select-agent",o)},t=async(o,v)=>{d.selectedAgentId&&await f(d.selectedAgentId,o,{title:v})},x=async o=>{d.selectedAgentId&&await $(d.selectedAgentId,o)};return K(()=>d.selectedAgentId,()=>{y.value=""}),K(g,o=>{console.log("[DialogsSidebar] dialogs changed:",o),console.log("[DialogsSidebar] dialogs.length:",o.length)},{immediate:!0,deep:!0}),(o,v)=>(p(),D("div",ns,[i("div",as,[i("div",{class:"relative",ref_key:"dropdownRef",ref:w},[i("button",{onClick:v[0]||(v[0]=r=>k.value=!k.value),class:"w-full flex items-center gap-3 px-3 py-2.5 bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors"},[i("div",os,[i("span",ls,H(c.value),1)]),i("div",is,[i("p",cs,H(s.value),1),i("p",rs,H(e.agents.length)+" "+H(u.value),1)]),P(L($t),{class:z(["w-5 h-5 text-slate-400 transition-transform",{"rotate-180":k.value}])},null,8,["class"])]),P(le,{"enter-active-class":"transition duration-150 ease-out","enter-from-class":"opacity-0 scale-95","enter-to-class":"opacity-100 scale-100","leave-active-class":"transition duration-100 ease-in","leave-from-class":"opacity-100 scale-100","leave-to-class":"opacity-0 scale-95"},{default:oe(()=>[k.value?(p(),D("div",ds,[i("div",us,[(p(!0),D(ie,null,Re(e.agents,r=>(p(),D("button",{key:r.id,onClick:b=>l(r.id),class:z(["w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors",[r.id===e.selectedAgentId?"bg-indigo-50 text-indigo-900":"hover:bg-slate-50 text-slate-700"]])},[i("div",fs,[i("span",ms,H(N(r.name)),1)]),i("span",vs,H(r.name),1),r.id===e.selectedAgentId?(p(),J(L(Ke),{key:0,class:"w-4 h-4 text-indigo-600 ml-auto flex-shrink-0"})):B("",!0)],10,gs))),128)),e.agents.length===0?(p(),D("div",ps," Нет доступных агентов ")):B("",!0)])])):B("",!0)]),_:1})],512)]),i("div",hs,[i("div",xs,[P(L(bt),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),Ie(i("input",{"onUpdate:modelValue":v[1]||(v[1]=r=>y.value=r),type:"text",placeholder:"Поиск диалогов...",class:"w-full pl-9 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"},null,512),[[Le,y.value]])])]),i("div",ys,[i("button",{onClick:v[2]||(v[2]=r=>o.$emit("create-dialog")),disabled:!e.selectedAgentId,class:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white rounded-xl text-sm font-semibold transition-colors"},[P(L(Ye),{class:"w-4 h-4"}),v[4]||(v[4]=ye(" Новый диалог ",-1))],8,bs)]),i("div",ks,[e.isLoading||L(h)?(p(),D("div",Ss,[P(L(be),{class:"w-6 h-6 text-indigo-600 animate-spin"})])):A.value.length===0?(p(),D("div",_s,[P(L(xe),{class:"w-12 h-12 text-slate-300 mx-auto mb-3"}),i("p",$s,H(y.value?"Диалоги не найдены":"Нет диалогов"),1),!y.value&&e.selectedAgentId?(p(),D("button",{key:0,onClick:v[3]||(v[3]=r=>o.$emit("create-dialog")),class:"mt-3 text-sm text-indigo-600 hover:text-indigo-700 font-medium"}," Создать первый диалог ")):B("",!0)])):(p(),D("div",Ms,[(p(!0),D(ie,null,Re(A.value,r=>(p(),J(ss,{key:r.id,dialog:r,"is-selected":r.id===e.selectedDialogId,"agent-enabled":C.value,onClick:b=>o.$emit("select-dialog",r.id),onRename:t,onDelete:x},null,8,["dialog","is-selected","agent-enabled","onClick"]))),128))]))])]))}}),Ds={class:"bg-white border-b border-slate-200 px-4 py-3 flex items-center gap-4 flex-shrink-0"},ws={class:"w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"},Cs={class:"text-white font-bold text-sm"},Rs={class:"flex-1 min-w-0"},Is={class:"text-sm font-semibold text-slate-900 truncate"},Ls={class:"flex items-center gap-1.5"},Es={class:"flex items-center gap-2"},Os={class:"text-xs text-slate-500 hidden sm:inline"},Ps=["aria-checked"],Ts=X({__name:"ChatHeader",props:{agent:{},isStreaming:{type:Boolean}},emits:["back"],setup(e){const a=e,{isAgentEnabled:d,toggleAgentEnabled:m}=Te(),g=j(()=>d(a.agent.id)),h=j(()=>a.agent.name?a.agent.name.split(" ").map($=>$.charAt(0)).join("").toUpperCase().slice(0,2):"?"),f=()=>{m(a.agent.id)};return($,S)=>(p(),D("div",Ds,[i("button",{onClick:S[0]||(S[0]=w=>$.$emit("back")),class:"lg:hidden p-2 -ml-2 rounded-lg text-slate-600 hover:bg-slate-100 transition-colors"},[P(L(Qe),{class:"w-5 h-5"})]),i("div",ws,[i("span",Cs,H(h.value),1)]),i("div",Rs,[i("h2",Is,H(e.agent.name),1),i("div",Ls,[e.isStreaming&&g.value?(p(),D(ie,{key:0},[P(L(be),{class:"w-3 h-3 text-indigo-600 animate-spin"}),S[1]||(S[1]=i("span",{class:"text-xs text-indigo-600 font-medium"},"В работе...",-1))],64)):g.value?(p(),D(ie,{key:2},[S[4]||(S[4]=i("span",{class:"w-2 h-2 bg-green-500 rounded-full"},null,-1)),S[5]||(S[5]=i("span",{class:"text-xs text-slate-500"},"Включен",-1))],64)):(p(),D(ie,{key:1},[S[2]||(S[2]=i("span",{class:"w-2 h-2 bg-slate-400 rounded-full"},null,-1)),S[3]||(S[3]=i("span",{class:"text-xs text-slate-500"},"Выключен",-1))],64))])]),i("div",Es,[i("span",Os,H(g.value?"Вкл":"Выкл"),1),i("button",{onClick:f,class:z(["relative w-11 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2",[g.value?"bg-indigo-600":"bg-slate-300"]]),role:"switch","aria-checked":g.value},[i("span",{class:z(["absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform",[g.value?"translate-x-5":"translate-x-0"]])},null,2)],10,Ps)])]))}}),Ns=["innerHTML"],js=["src"],Ws={key:2,class:"flex items-center gap-3 min-w-[200px]"},Us={class:"flex-1"},Bs={key:3,class:"flex items-center gap-1 mt-1"},Fs={class:"text-[10px] text-slate-400"},zs={key:2,class:"flex items-center gap-1"},qs=X({__name:"MessageBubble",props:{message:{}},emits:["retry","image-click"],setup(e){const a=e,d=new St({html:!1,linkify:!0,breaks:!0}),m=E(!1),g=E(0),h=E(null),f=j(()=>a.message.role==="agent"),$=j(()=>f.value?"bg-indigo-600 text-white rounded-br-sm":"bg-white border border-slate-200 text-slate-900 rounded-bl-sm shadow-sm"),S=j(()=>a.message.type!=="text"?"":d.render(a.message.content)),w=j(()=>new Date(a.message.created_at).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})),k=j(()=>{const n=a.message.duration_seconds||0,s=Math.floor(n/60),c=n%60;return`${s}:${c.toString().padStart(2,"0")}`}),y=()=>{h.value||(h.value=new Audio(a.message.content),h.value.addEventListener("timeupdate",()=>{h.value&&(g.value=h.value.currentTime/h.value.duration*100)}),h.value.addEventListener("ended",()=>{m.value=!1,g.value=0})),m.value?h.value.pause():h.value.play(),m.value=!m.value};return(n,s)=>(p(),D("div",{class:z(["flex",[f.value?"justify-end":"justify-start"]])},[i("div",{class:z(["max-w-[85%] sm:max-w-[70%] lg:max-w-[60%]",[f.value?"order-1":"order-2"]])},[i("div",{class:z(["text-[11px] font-medium mb-1 px-1",[f.value?"text-right text-indigo-600":"text-left text-slate-500"]])},H(f.value?"Агент":"Пользователь"),3),i("div",{class:z(["rounded-2xl px-4 py-2.5 relative",$.value])},[e.message.type==="text"?(p(),D("div",{key:0,class:z(["text-sm whitespace-pre-wrap break-words prose prose-sm max-w-none",[f.value?"prose-invert":""]]),innerHTML:S.value},null,10,Ns)):e.message.type==="image"?(p(),D("img",{key:1,src:e.message.content,alt:"Image",class:"rounded-lg max-w-full cursor-pointer hover:opacity-90 transition-opacity",onClick:s[0]||(s[0]=c=>n.$emit("image-click",e.message.content))},null,8,js)):e.message.type==="voice"?(p(),D("div",Ws,[i("button",{onClick:y,class:z(["w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 transition-colors",[f.value?"bg-white/20 hover:bg-white/30 text-white":"bg-slate-200 hover:bg-slate-300 text-slate-700"]])},[m.value?(p(),J(L(Rt),{key:0,class:"w-5 h-5"})):(p(),J(L(Lt),{key:1,class:"w-5 h-5 ml-0.5"}))],2),i("div",Us,[i("div",{class:z(["h-1 rounded-full overflow-hidden",[f.value?"bg-white/30":"bg-slate-300"]])},[i("div",{class:z(["h-full transition-all",[f.value?"bg-white":"bg-slate-600"]]),style:Ve({width:`${g.value}%`})},null,6)],2),i("span",{class:z(["text-xs mt-1 block",[f.value?"text-white/70":"text-slate-500"]])},H(k.value),3)])])):B("",!0),e.message.status==="streaming"?(p(),D("div",Bs,[...s[2]||(s[2]=[i("span",{class:"w-1.5 h-1.5 bg-current rounded-full animate-pulse opacity-60"},null,-1)])])):B("",!0)],2),i("div",{class:z(["flex items-center gap-2 mt-1 px-1",[f.value?"justify-end":"justify-start"]])},[i("span",Fs,H(w.value),1),f.value?(p(),D(ie,{key:0},[e.message.status==="sending"?(p(),J(L(be),{key:0,class:"w-3 h-3 text-slate-400 animate-spin"})):e.message.status==="sent"?(p(),J(L(Ke),{key:1,class:"w-3 h-3 text-slate-400"})):e.message.status==="failed"?(p(),D("div",zs,[P(L(Oe),{class:"w-3 h-3 text-red-500"}),i("button",{onClick:s[1]||(s[1]=c=>n.$emit("retry")),class:"text-[10px] text-red-500 hover:text-red-600 font-medium"}," Повторить ")])):B("",!0)],64)):B("",!0)],2)],2)],2))}}),Hs=Ee(qs,[["__scopeId","data-v-7a5bebcf"]]),Js={class:"flex-1 flex items-center justify-center p-8"},Vs={class:"text-center max-w-sm"},Gs={class:"w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6"},Ks={class:"text-lg font-semibold text-slate-900 mb-2"},Ys={class:"text-sm text-slate-500 mb-6"},at=X({__name:"DialogsEmptyState",props:{type:{default:"no-dialog"},errorMessage:{}},emits:["create","retry"],setup(e){const a=e,d=j(()=>{switch(a.type){case"no-agent":return{icon:xe,title:"Выберите агента",description:"Выберите агента из списка слева, чтобы начать диалог.",showAction:!1,actionLabel:""};case"no-dialog":return{icon:wt,title:"Выберите диалог",description:"Выберите существующий диалог или создайте новый, чтобы начать общение с агентом.",showAction:!0,actionLabel:"Новый диалог"};case"no-messages":return{icon:xe,title:"Начните диалог",description:"Напишите сообщение, чтобы начать общение с агентом.",showAction:!1,actionLabel:""};case"error":return{icon:Oe,title:"Ошибка загрузки",description:a.errorMessage||"Не удалось загрузить данные. Попробуйте обновить страницу.",showAction:!0,actionLabel:"Повторить"};default:return{icon:xe,title:"Нет данных",description:"Данные отсутствуют.",showAction:!1,actionLabel:""}}}),m=j(()=>d.value.icon),g=j(()=>d.value.title),h=j(()=>d.value.description),f=j(()=>d.value.showAction),$=j(()=>d.value.actionLabel);return(S,w)=>(p(),D("div",Js,[i("div",Vs,[i("div",Gs,[(p(),J(ut(m.value),{class:"w-10 h-10 text-slate-400"}))]),i("h3",Ks,H(g.value),1),i("p",Ys,H(h.value),1),f.value?(p(),D("button",{key:0,onClick:w[0]||(w[0]=k=>S.$emit("create")),class:"inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-semibold transition-colors"},[P(L(Ye),{class:"w-4 h-4"}),ye(" "+H($.value),1)])):B("",!0)])]))}}),Qs={key:0,class:"flex justify-center py-3"},Xs={key:1,class:"flex justify-center py-3"},Zs={key:2,class:"h-full flex items-center justify-center"},en={key:3,class:"space-y-4"},tn={key:4,class:"flex items-center gap-2 py-2 px-3 text-slate-500"},sn=["src"],nn=X({__name:"MessagesFeed",props:{dialogId:{},messages:{},isLoading:{type:Boolean},isStreaming:{type:Boolean},hasMore:{type:Boolean}},emits:["load-more","retry"],setup(e){const a=e,d=E(null),m=E(!1),g=E(!0),h=E(null),f=()=>{if(!d.value)return;const{scrollTop:n,scrollHeight:s,clientHeight:c}=d.value,C=s-n-c;g.value=C<100,g.value&&(m.value=!1)},$=(n=!0)=>{d.value&&(d.value.scrollTo({top:d.value.scrollHeight,behavior:n?"smooth":"auto"}),m.value=!1)},S=()=>{$(!0)};K(()=>a.messages.length,(n,s)=>{if(n>s){const c=a.messages[a.messages.length-1];g.value||(c==null?void 0:c.role)==="user"?fe(()=>$(!1)):(c==null?void 0:c.role)==="agent"&&(m.value=!0)}}),K(()=>a.isStreaming,n=>{n&&g.value&&fe(()=>$(!1))});const w=n=>{h.value=n,document.body.style.overflow="hidden"},k=()=>{h.value=null,document.body.style.overflow=""},y=n=>{n.key==="Escape"&&h.value&&k()};return $e(()=>{window.addEventListener("keydown",y),fe(()=>$(!1))}),Je(()=>{window.removeEventListener("keydown",y),document.body.style.overflow=""}),(n,s)=>(p(),D("div",{ref_key:"scrollContainerRef",ref:d,class:"flex-1 overflow-y-auto px-4 py-4",onScroll:f},[e.hasMore&&!e.isLoading?(p(),D("div",Qs,[i("button",{onClick:s[0]||(s[0]=c=>n.$emit("load-more")),class:"text-sm text-indigo-600 hover:text-indigo-700 font-medium"}," Загрузить ранние сообщения ")])):B("",!0),e.isLoading&&e.messages.length>0?(p(),D("div",Xs,[P(L(be),{class:"w-5 h-5 text-indigo-600 animate-spin"})])):B("",!0),!e.isLoading&&e.messages.length===0?(p(),D("div",Zs,[P(at,{type:"no-messages"})])):(p(),D("div",en,[(p(!0),D(ie,null,Re(e.messages,c=>(p(),J(Hs,{key:c.id,message:c,onRetry:C=>n.$emit("retry",c.id),onImageClick:w},null,8,["message","onRetry"]))),128))])),e.isStreaming?(p(),D("div",tn,[...s[2]||(s[2]=[gt('<div class="flex gap-1" data-v-da25e471><span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay:0ms;" data-v-da25e471></span><span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay:150ms;" data-v-da25e471></span><span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay:300ms;" data-v-da25e471></span></div><span class="text-xs" data-v-da25e471>Агент печатает...</span>',2)])])):B("",!0),P(le,{"enter-active-class":"transition duration-200 ease-out","enter-from-class":"opacity-0 translate-y-4","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition duration-150 ease-in","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-4"},{default:oe(()=>[m.value?(p(),D("button",{key:0,onClick:S,class:"fixed bottom-24 left-1/2 -translate-x-1/2 lg:left-auto lg:translate-x-0 lg:right-8 px-4 py-2 bg-indigo-600 text-white rounded-full text-sm font-medium shadow-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 z-10"},[P(L(At),{class:"w-4 h-4"}),s[3]||(s[3]=ye(" Новые сообщения ",-1))])):B("",!0)]),_:1}),(p(),J(Se,{to:"body"},[P(le,{name:"lightbox-fade"},{default:oe(()=>[h.value?(p(),D("div",{key:0,class:"fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4",onClick:k},[i("button",{onClick:k,class:"absolute top-4 right-4 p-2 text-white/80 hover:text-white transition-colors"},[P(L(ft),{class:"w-6 h-6"})]),i("img",{src:h.value,class:"max-w-full max-h-full object-contain",onClick:s[1]||(s[1]=Ce(()=>{},["stop"]))},null,8,sn)])):B("",!0)]),_:1})]))],544))}}),an=Ee(nn,[["__scopeId","data-v-da25e471"]]),on={class:"bg-white border-t border-slate-200 px-4 py-3 flex-shrink-0"},ln={key:0,class:"mb-3 px-3 py-2 bg-amber-50 border border-amber-200 rounded-lg flex items-center gap-2"},cn={class:"flex items-end gap-2"},rn=["disabled"],dn={class:"flex-1 relative"},un=["disabled"],gn={disabled:!0,class:"p-2.5 rounded-xl text-slate-400 cursor-not-allowed transition-colors flex-shrink-0",title:"Голосовое сообщение (скоро)"},fn=["disabled"],mn={key:1,class:"mt-1 text-right"},vn=X({__name:"MessageComposer",props:{isSending:{type:Boolean},isStreaming:{type:Boolean},agentEnabled:{type:Boolean}},emits:["send","attach-image"],setup(e,{emit:a}){const d=e,m=a,g=E(null),h=E(null),f=E(""),$=j(()=>f.value.trim().length>0&&f.value.length<=4e3&&!d.isSending&&!d.isStreaming),S=()=>{$.value&&(m("send",f.value.trim()),f.value="",fe(()=>{var s;k(),(s=g.value)==null||s.focus()}))},w=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),S())},k=()=>{g.value&&(g.value.style.height="auto",g.value.style.height=`${Math.min(g.value.scrollHeight,150)}px`)},y=()=>{var s;(s=h.value)==null||s.click()},n=s=>{var u;const c=s.target,C=(u=c.files)==null?void 0:u[0];C&&m("attach-image",C),c.value=""};return K(f,s=>{s||fe(k)}),(s,c)=>(p(),D("div",on,[e.agentEnabled?B("",!0):(p(),D("div",ln,[P(L(Oe),{class:"w-4 h-4 text-amber-600 flex-shrink-0"}),c[1]||(c[1]=i("span",{class:"text-xs text-amber-700"}," Агент выключен. Сообщения будут сохранены, но ответы не будут генерироваться. ",-1))])),i("div",cn,[i("button",{onClick:y,disabled:e.isSending||e.isStreaming,class:"p-2.5 rounded-xl text-slate-500 hover:text-slate-700 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex-shrink-0",title:"Прикрепить изображение"},[P(L(Dt),{class:"w-5 h-5"})],8,rn),i("input",{ref_key:"fileInputRef",ref:h,type:"file",accept:"image/*",class:"hidden",onChange:n},null,544),i("div",dn,[Ie(i("textarea",{ref_key:"textareaRef",ref:g,"onUpdate:modelValue":c[0]||(c[0]=C=>f.value=C),onKeydown:w,onInput:k,disabled:e.isSending||e.isStreaming,placeholder:"Напишите сообщение...",rows:"1",class:"w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm resize-none placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed transition-all",style:{maxHeight:"150px"}},null,40,un),[[Le,f.value]])]),i("button",gn,[P(L(Ct),{class:"w-5 h-5"})]),i("button",{onClick:S,disabled:!$.value,class:"p-2.5 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors flex-shrink-0",title:"Отправить"},[e.isSending?(p(),J(L(be),{key:0,class:"w-5 h-5 animate-spin"})):(p(),J(L(_t),{key:1,class:"w-5 h-5"}))],8,fn)]),f.value.length>500?(p(),D("div",mn,[i("span",{class:z(["text-xs",f.value.length>4e3?"text-red-500":"text-slate-400"])},H(f.value.length)+" / 4000 ",3)])):B("",!0)]))}}),pn={class:"flex-1 flex flex-col h-full overflow-hidden"},hn=X({__name:"ChatArea",props:{dialogId:{},agent:{},wsSendMessage:{type:Function},isWsConnected:{type:Boolean}},emits:["back"],setup(e){const a=e,{messagesMap:d,fetchMessages:m,sendMessage:g,retryMessage:h,createOptimisticMessage:f,markMessageFailed:$,isLoading:S,isSending:w,isStreaming:k,dialogHasMore:y}=Xe(),{isAgentEnabled:n}=Te(),{markAsRead:s}=ke(),c=j(()=>{const v=d.value[a.dialogId]||[];return console.log(`[ChatArea] computed messages for ${a.dialogId}:`,v.length),v}),C=j(()=>y(a.dialogId)),u=j(()=>n(a.agent.id)),A=async()=>{console.log("[ChatArea] Loading messages for:",{agentId:a.agent.id,dialogId:a.dialogId}),await m(a.agent.id,a.dialogId,{limit:50}),console.log("[ChatArea] Messages loaded:",c.value.length),s(a.dialogId)},N=async()=>{const o=c.value[0];o&&await m(a.agent.id,a.dialogId,{before:o.id,limit:30})},l=async o=>{if(a.isWsConnected&&a.wsSendMessage){console.log("[ChatArea] Sending via WebSocket");const v=f(a.dialogId,o,"text");a.wsSendMessage(a.dialogId,o)||(console.warn("[ChatArea] WebSocket send failed, message marked as failed"),$(a.dialogId,v,"WebSocket отключен"))}else console.log("[ChatArea] Sending via HTTP (WebSocket not connected)"),await g(a.agent.id,a.dialogId,o,"text",u.value)},t=async o=>{console.log("Attach image:",o.name)},x=async o=>{await h(a.agent.id,a.dialogId,o,u.value)};return K(()=>a.dialogId,()=>{A()},{immediate:!0}),$e(()=>{A()}),(o,v)=>(p(),D("div",pn,[P(Ts,{agent:e.agent,"is-streaming":L(k),onBack:v[0]||(v[0]=r=>o.$emit("back"))},null,8,["agent","is-streaming"]),P(an,{"dialog-id":e.dialogId,messages:c.value,"is-loading":L(S),"is-streaming":L(k),"has-more":C.value,onLoadMore:N,onRetry:x},null,8,["dialog-id","messages","is-loading","is-streaming","has-more"]),P(vn,{"is-sending":L(w),"is-streaming":L(k),"agent-enabled":u.value,onSend:l,onAttachImage:t},null,8,["is-sending","is-streaming","agent-enabled"])]))}}),xn={class:"min-h-screen bg-slate-50"},yn={class:"lg:hidden bg-white border-b border-slate-200 px-4 py-3"},bn={class:"flex items-center justify-between"},kn={class:"flex items-center gap-2"},Sn={class:"flex"},_n={key:0,class:"lg:hidden fixed inset-0 z-50 w-full"},$n={class:"flex-1 flex h-[calc(100vh-57px)] lg:h-screen overflow-hidden"},Tn=X({__name:"dialogs",setup(e){const{isAuthenticated:a}=ht(),d=E(!1),m=E(!1),g=mt(),h=vt(),{agents:f,isLoading:$,fetchAgents:S}=pt(),{fetchDialogs:w,createDialog:k}=ke(),y=E(g.query.agentId||null),n=E(g.query.dialogId||null),s=E(!n.value),{isConnected:c,sendMessage:C,joinDialog:u,leaveDialog:A}=Nt(j(()=>y.value)),N=j(()=>{if(y.value)return f.value.find(r=>r.id===y.value)}),l=async r=>{console.log("[Page] Selecting agent:",r),y.value=r,n.value=null,h.push({query:{...g.query,agentId:r,dialogId:void 0}}),await w(r)},t=r=>{var b;console.log("[Page] Selecting dialog:",r),console.log("[Page] selectedAgentId:",y.value),console.log("[Page] selectedAgent:",N.value),n.value&&n.value!==r&&A(n.value),n.value=r,s.value=!1,u(r),h.push({query:{...g.query,dialogId:r}}),console.log("[Page] After selection - dialogId:",n.value,"agent:",(b=N.value)==null?void 0:b.id)};K(()=>g.query.agentId,r=>{y.value=typeof r=="string"?r:null}),K(()=>g.query.dialogId,r=>{n.value=typeof r=="string"?r:null,n.value&&(s.value=!1)});const x=async()=>{if(!y.value){f.value.length>0&&await l(f.value[0].id);return}const r=await k(y.value);r&&t(r.id)},o=()=>{d.value=!1,v()},v=async()=>{var r;console.log("[Page] Loading initial data..."),console.log("[Page] Route query:",g.query),console.log("[Page] selectedAgentId from URL:",y.value),console.log("[Page] selectedDialogId from URL:",n.value),await S(),console.log("[Page] Agents loaded:",f.value.length,f.value.map(b=>b.id)),y.value?(console.log("[Page] Agent already selected from URL:",y.value),console.log("[Page] Calling fetchDialogs..."),await w(y.value),console.log("[Page] fetchDialogs completed"),console.log("[Page] selectedAgent after fetch:",(r=N.value)==null?void 0:r.id),console.log("[Page] selectedDialogId:",n.value),console.log("[Page] ChatArea should render:",!!(n.value&&N.value))):f.value.length>0?(console.log("[Page] No agent in URL, selecting first one"),await l(f.value[0].id)):console.log("[Page] No agents available")};return K(a,r=>{console.log("[Page] Auth state changed:",r),r&&v()}),$e(()=>{console.log("[Page] Mounted, isAuthenticated:",a.value),console.log("[Page] BUILD VERSION: 2026-02-04-v2"),a.value?v():(console.log("[Page] Not authenticated, showing modal"),d.value=!0)}),(r,b)=>(p(),D("div",xn,[i("div",yn,[i("div",bn,[i("div",kn,[n.value&&!s.value?(p(),D("button",{key:0,onClick:b[0]||(b[0]=_=>s.value=!0),class:"p-2 -ml-2 rounded-lg text-slate-600 hover:bg-slate-100"},[P(L(Qe),{class:"h-5 w-5"})])):B("",!0),b[6]||(b[6]=i("div",{class:"w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center"},[i("span",{class:"text-white font-bold text-xs"},"М")],-1)),b[7]||(b[7]=i("span",{class:"text-slate-900 font-bold"},"Диалоги",-1))]),i("button",{onClick:b[1]||(b[1]=_=>m.value=!m.value),class:"p-2 rounded-lg text-slate-600 hover:bg-slate-100"},[P(L(xt),{class:"h-5 w-5"})])])]),i("div",Sn,[P(Fe,{class:"hidden lg:block"}),m.value?(p(),D("div",{key:0,class:"lg:hidden fixed inset-0 z-40 bg-black bg-opacity-50",onClick:b[2]||(b[2]=_=>m.value=!1)})):B("",!0),P(le,{"enter-active-class":"transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1)","enter-from-class":"-translate-x-full opacity-0 scale-95","enter-to-class":"translate-x-0 opacity-100 scale-100","leave-active-class":"transition-all duration-400 ease-in","leave-from-class":"translate-x-0 opacity-100 scale-100","leave-to-class":"-translate-x-full opacity-0 scale-95"},{default:oe(()=>[m.value?(p(),D("div",_n,[P(Fe,{onClose:b[3]||(b[3]=_=>m.value=!1)})])):B("",!0)]),_:1}),i("main",$n,[i("div",{class:z(["w-full lg:w-80 xl:w-96 flex-shrink-0 border-r border-slate-200 bg-white",!s.value&&n.value?"hidden lg:flex lg:flex-col":"flex flex-col"])},[P(As,{agents:L(f),"selected-agent-id":y.value,"selected-dialog-id":n.value,"is-loading":L($),onSelectAgent:l,onSelectDialog:t,onCreateDialog:x},null,8,["agents","selected-agent-id","selected-dialog-id","is-loading"])],2),i("div",{class:z(["flex-1 flex flex-col bg-slate-50",s.value&&n.value?"hidden lg:flex":"flex"])},[n.value&&N.value?(p(),J(hn,{key:0,"dialog-id":n.value,agent:N.value,"ws-send-message":L(C),"is-ws-connected":L(c),onBack:b[4]||(b[4]=_=>s.value=!0)},null,8,["dialog-id","agent","ws-send-message","is-ws-connected"])):(p(),J(at,{key:1,type:"no-dialog",onCreate:x}))],2)])]),P(Mt,{"is-open":d.value,onClose:b[5]||(b[5]=_=>d.value=!1),onAuthenticated:o},null,8,["is-open"])]))}});export{Tn as default};
