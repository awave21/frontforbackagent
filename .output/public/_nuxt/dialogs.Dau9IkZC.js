import{M as Se,k as E,bg as be,bf as Ze,f as Q,b6 as ze,u as j,L as W,m as oe,o as f,c as $,s as Te,a,A as G,n as J,t as H,p as q,d as ve,b as B,T as De,w as ae,a_ as Fe,q as ce,v as Ee,x as je,E as et,H as pe,N as tt,_ as Ce,a5 as qe,F as ue,C as Ie,J as st,B as He,D as nt,X as at,P as ot,b$ as lt}from"./entry.Dw2909n2.js";import{u as it}from"./useAgents.B7UkyiZ0.js";import{u as Ve,g as X}from"./useApiFetch.sBSRwplN.js";import{u as rt}from"./useAuth.jgUYoTAC.js";import{g as Ge}from"./authSessionManager.CAWbIGEs.js";import{o as Je}from"./index.wwnDQnet.js";import{M as ke}from"./message-square.C2TtVjfK.js";import{M as ct}from"./more-vertical.CWTsiCiJ.js";import{P as ut}from"./pencil.QlFcg03D.js";import{T as dt}from"./trash-2.Dv1Ml6au.js";import{C as gt}from"./chevron-down.8AIWZq2w.js";import{C as Ke}from"./check.CexbSXYH.js";import{S as ft}from"./search.DVEG5Gql.js";import{L as Me}from"./loader-2.D-f1OOw-.js";import{A as mt}from"./chevron-right.Dt1o7IKv.js";import{c as vt}from"./safe-markdown._KYjoumJ.js";import{P as pt}from"./play.CNuZBiss.js";import{A as Xe}from"./alert-circle.CFB8cae4.js";import{P as xt}from"./plus.DTMN2fIW.js";import{M as ht}from"./message-circle.DGkt7i9Z.js";import{U as yt}from"./user-check.BNUluFSE.js";import{S as bt}from"./send.DT84bmvo.js";import{M as _t,_ as We}from"./DashboardSidebar.vue.B26z5fa-.js";import{_ as kt}from"./AuthModal.vue.BSzxuO2s.js";import"./index.0dLU0aXR.js";import"./nuxt-link.t2uHRS69.js";import"./index.DT79k1l5.js";import"./floating-ui.vue.VILNG3-i.js";import"./chevrons-up-down.C2VhQO3Y.js";import"./settings.DdVzARvN.js";import"./sparkles.CVmRtpTC.js";import"./link.DpqSbqvX.js";import"./database.CDLRhh8b.js";import"./code.CqfGPh0g.js";import"./cpu.BtB-GUA5.js";import"./eye.B5oT6PQ0.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const St=Se("ArrowDownIcon",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mt=Se("ImageIcon",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $t=Se("MicIcon",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dt=Se("PauseCircleIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"10",x2:"10",y1:"15",y2:"9",key:"c1nkhi"}],["line",{x1:"14",x2:"14",y1:"15",y2:"9",key:"h65svq"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=Se("PauseIcon",[["rect",{width:"4",height:"16",x:"6",y:"4",key:"iffhe4"}],["rect",{width:"4",height:"16",x:"14",y:"4",key:"sjin7j"}]]),Be=new Set(["active","paused"]),$e=e=>{const s=e.status&&Be.has(e.status)?e.status:e.agent_status??"active";return{...e,agent_status:s,status:Be.has(e.status)?"NORMAL":e.status||"NORMAL"}},O=E([]),_e=E(!1),ne=E(null),Re=E(null),xe=()=>{const e=Ve();return{dialogs:O,isLoading:_e,error:ne,currentAgentId:Re,fetchDialogs:async(i,o)=>{if(!i){console.warn("[useDialogs] fetchDialogs called without agentId");return}_e.value=!0,ne.value=null,Re.value=i;try{const r=new URLSearchParams;(o==null?void 0:o.archived)!==void 0&&r.set("archived",String(o.archived));const d=r.toString(),U=`agents/${i}/dialogs${d?`?${d}`:""}`,I=await e(U);let M=[];Array.isArray(I)?M=I:I&&typeof I=="object"&&"dialogs"in I?M=I.dialogs||[]:I&&typeof I=="object"&&"items"in I&&(M=I.items||[]),O.value=M.map($e)}catch(r){console.error("[useDialogs] Error fetching dialogs:",r),console.error("[useDialogs] Error details:",{status:(r==null?void 0:r.statusCode)||(r==null?void 0:r.status),data:r==null?void 0:r.data,message:r==null?void 0:r.message}),ne.value=X(r,"Не удалось загрузить диалоги"),O.value=[]}finally{_e.value=!1}},createDialog:async(i,o)=>{if(!i)return null;_e.value=!0,ne.value=null;try{const r=await e(`agents/${i}/dialogs`,{method:"POST",headers:{"Content-Type":"application/json"},body:o||{}}),d=$e(r);return O.value=[d,...O.value],d}catch(r){return ne.value=X(r,"Не удалось создать диалог"),null}finally{_e.value=!1}},updateDialog:async(i,o,r)=>{if(!i||!o)return null;try{const d=await e(`agents/${i}/dialogs/${encodeURIComponent(o)}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:r}),U=$e(d),I=O.value.findIndex(M=>M.id===o);return I!==-1&&(O.value[I]=U),U}catch(d){return ne.value=X(d,"Не удалось обновить диалог"),null}},deleteDialog:async(i,o)=>{if(!i||!o)return!1;try{return await e(`agents/${i}/dialogs/${encodeURIComponent(o)}`,{method:"DELETE"}),O.value=O.value.filter(r=>r.id!==o),!0}catch(r){return ne.value=X(r,"Не удалось удалить диалог"),!1}},toggleDialogAgentStatus:async(i,o)=>{if(!i||!o)return null;const r=O.value.findIndex(I=>I.id===o),d=r!==-1?O.value[r].agent_status??"active":"active",U=d==="active"?"paused":"active";r!==-1&&(O.value[r]={...O.value[r],agent_status:U});try{return await e(`agents/${i}/dialogs/${encodeURIComponent(o)}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:{status:U}}),U}catch(I){return r!==-1&&(O.value[r]={...O.value[r],agent_status:d}),ne.value=X(I,"Не удалось изменить статус агента"),console.error("[useDialogs] toggleDialogAgentStatus error:",I),null}},upsertDialog:i=>{const o=i.id||i.session_id;if(!o)return;const r=O.value.findIndex(h=>h.id===o),d=r!==-1?O.value[r]:null,U=i.user_info||(d==null?void 0:d.user_info);let I=null;U&&(U.first_name||U.last_name?I=[U.first_name,U.last_name].filter(Boolean).join(" "):U.username&&(I=`@${U.username}`));const M=i.platform||(d==null?void 0:d.platform)||(o.startsWith("telegram:")?"telegram":void 0),c=M==="telegram"||o.startsWith("telegram:")?`Telegram #${o.replace("telegram:","")}`:"Диалог",t=I||(d==null?void 0:d.title)||c,n=$e({...d||{},id:o,title:t,last_message_preview:i.last_message_preview||i.content||(d==null?void 0:d.last_message_preview)||"",last_message_at:i.last_message_at||i.created_at||(d==null?void 0:d.last_message_at)||new Date().toISOString(),unread_count:i.is_new?((d==null?void 0:d.unread_count)??0)+1:(d==null?void 0:d.unread_count)??0,status:i.status||(d==null?void 0:d.status)||"NORMAL",agent_status:i.agent_status||(d==null?void 0:d.agent_status),created_at:i.created_at||(d==null?void 0:d.created_at)||new Date().toISOString(),updated_at:new Date().toISOString(),platform:M,user_info:U||(d==null?void 0:d.user_info)});r!==-1?O.value=[n,...O.value.filter((h,l)=>l!==r)]:O.value=[n,...O.value]},updateDialogStatus:(i,o)=>{const r=O.value.findIndex(d=>d.id===i);r!==-1&&(O.value[r]={...O.value[r],status:o})},updateLastMessage:(i,o,r)=>{const d=O.value.findIndex(U=>U.id===i);if(d!==-1){O.value[d]={...O.value[d],last_message_preview:o,last_message_at:r};const U=O.value.splice(d,1)[0];O.value.unshift(U)}},incrementUnread:i=>{const o=O.value.findIndex(r=>r.id===i);o!==-1&&(O.value[o]={...O.value[o],unread_count:O.value[o].unread_count+1})},markAsRead:i=>{const o=O.value.findIndex(r=>r.id===i);o!==-1&&(O.value[o]={...O.value[o],unread_count:0})},getDialogById:i=>O.value.find(o=>o.id===i),resolveDialogId:i=>{if(!i)return null;const o=String(i),r=O.value.find(U=>U.id===o);if(r)return r.id;const d=O.value.find(U=>U.id.endsWith(`:${o}`));return(d==null?void 0:d.id)??o},clearDialogs:()=>{O.value=[],Re.value=null,ne.value=null}}},F=Ze({}),V=(e,s)=>{F[e]=[...s]},we=E(!1),re=E(!1),fe=E(!1),me=E(null),te=E(null),Le=E(new Map),At=(e,s)=>{const u=s.isUser??s.is_user,y=s.isAgent??s.is_agent;if(typeof u=="boolean")return u?"user":"agent";if(typeof y=="boolean")return y?"agent":"user";if(typeof e=="string"){const _=e.toLowerCase();if(["user","human","client","customer","visitor","requester"].includes(_))return"user";if(["manager","operator","admin","support"].includes(_))return"manager";if(["agent","assistant","bot","ai","system"].includes(_))return"agent"}return"agent"},Rt=e=>{if(typeof e=="string"){const s=e.toLowerCase();if(s.includes("image")||s.includes("photo")||s.includes("img"))return"image";if(s.includes("voice")||s.includes("audio")||s.includes("wav")||s.includes("mp3"))return"voice"}return"text"},wt=e=>{if(typeof e!="string")return"sent";const s=e.toLowerCase();return s==="sending"?"sending":s==="failed"?"failed":s==="streaming"?"streaming":s==="done"?"done":"sent"},Lt=new Set(["tool","function","tool_result","function_result","tool_call","function_call","tool_use"]),Tt=new Set(["tool_result","tool_call","function_call","function_result","tool_use"]),It=e=>{const s=e.trim();if(s.length<20||!(s.startsWith("{")&&s.endsWith("}")||s.startsWith("[")&&s.endsWith("]")))return!1;try{const y=JSON.parse(s);if(typeof y=="object"&&y!==null)return!0}catch{if(/^\{\s*'[^']+'\s*:/.test(s))return!0}return!1},Pe=(e,s)=>{var i;const u=(e==null?void 0:e.role)??(e==null?void 0:e.sender)??(e==null?void 0:e.author)??(e==null?void 0:e.from)??(e==null?void 0:e.direction);if(typeof u=="string"&&Lt.has(u.toLowerCase()))return null;const y=(e==null?void 0:e.type)??(e==null?void 0:e.message_type)??(e==null?void 0:e.content_type)??(e==null?void 0:e.kind);if(typeof y=="string"&&Tt.has(y.toLowerCase()))return null;const _=(e==null?void 0:e.content)??(e==null?void 0:e.text)??(e==null?void 0:e.message)??(e==null?void 0:e.body)??(e==null?void 0:e.payload)??((i=e==null?void 0:e.data)==null?void 0:i.content)??"";if(typeof _=="object"&&_!==null)return null;const T=typeof _=="string"?_:String(_);if(It(T))return null;const b=(e==null?void 0:e.dialog_id)??(e==null?void 0:e.dialogId)??(e==null?void 0:e.session_id)??(e==null?void 0:e.sessionId)??s,N=(e==null?void 0:e.id)??(e==null?void 0:e.message_id)??(e==null?void 0:e.messageId)??(e==null?void 0:e.uuid)??(e==null?void 0:e._id)??`${b}-${(e==null?void 0:e.created_at)??(e==null?void 0:e.createdAt)??Date.now()}`,A=At(u,{isUser:e==null?void 0:e.isUser,is_user:e==null?void 0:e.is_user,isAgent:e==null?void 0:e.isAgent,is_agent:e==null?void 0:e.is_agent}),m=Rt((e==null?void 0:e.type)??(e==null?void 0:e.message_type)??(e==null?void 0:e.content_type)??(e==null?void 0:e.kind)??(e==null?void 0:e.media_type)),p=(e==null?void 0:e.created_at)??(e==null?void 0:e.createdAt)??(e==null?void 0:e.timestamp)??(e==null?void 0:e.time)??(e==null?void 0:e.created)??new Date().toISOString(),k=wt(e==null?void 0:e.status),R=(e==null?void 0:e.duration_seconds)??(e==null?void 0:e.durationSeconds)??(e==null?void 0:e.duration),x=typeof R=="number"?R:Number.isFinite(Number(R))?Number(R):void 0;return{id:String(N),dialog_id:String(b),role:A,type:m,content:T,status:k,duration_seconds:x,created_at:String(p)}},Ye=()=>{const e=Ve(),{updateDialogStatus:s,updateLastMessage:u,resolveDialogId:y}=xe(),_=c=>F[c]||[],T=async(c,t,n)=>{if(!c||!t){console.warn("[useMessages] Missing agentId or dialogId:",{agentId:c,dialogId:t});return}we.value=!0,te.value=null;let h=!1;const l=new URLSearchParams;n!=null&&n.before&&l.set("before",n.before),n!=null&&n.limit&&l.set("limit",String(n.limit));const v=l.toString(),D=encodeURIComponent(t),w=`agents/${c}/dialogs/${D}/messages${v?`?${v}`:""}`;try{console.log("[useMessages] fetchMessages URL:",w);const g=await e(w,{method:"GET"});console.log("[useMessages] fetchMessages raw response:",g),console.log("[useMessages] fetchMessages response type:",typeof g,Array.isArray(g)?"array":"");let L=[];Array.isArray(g)?(L=g,h=!1):g&&typeof g=="object"&&"messages"in g?(L=g.messages||[],h=g.has_more||!1):g&&typeof g=="object"&&"items"in g?(L=g.items||[],h=g.has_more||!1):g&&typeof g=="object"&&"data"in g?(L=g.data||[],h=g.has_more||!1):console.error("[useMessages] Unexpected response format:",g),console.log("[useMessages] rawMessages count:",L.length),L.length>0&&console.log("[useMessages] first raw message sample:",L[0]);const C=[];for(const S of L){const P=Pe(S,t);P?C.push(P):console.warn("[useMessages] Message filtered out by normalizeMessage:",{id:S==null?void 0:S.id,role:(S==null?void 0:S.role)??(S==null?void 0:S.sender),type:(S==null?void 0:S.type)??(S==null?void 0:S.message_type),content_type:typeof(S==null?void 0:S.content),content_preview:typeof(S==null?void 0:S.content)=="string"?S.content.slice(0,80):typeof(S==null?void 0:S.content)})}const z=F[t]||[];n!=null&&n.before?V(t,[...C,...z]):V(t,C),Le.value.set(t,h),console.log("[useMessages] Final messages count for dialog",t,":",(F[t]||[]).length)}catch(g){console.error("[useMessages] fetchMessages error:",g),console.error("[useMessages] fetchMessages error details:",{status:(g==null?void 0:g.statusCode)||(g==null?void 0:g.status),data:g==null?void 0:g.data,message:g==null?void 0:g.message,url:w}),te.value=X(g,"Не удалось загрузить сообщения")}finally{we.value=!1}},b=async(c,t,n,h="text",l=!0)=>{if(!c||!t||!n.trim())return null;re.value=!0,te.value=null;const v=`temp-${Date.now()}`,D={id:v,dialog_id:t,role:"user",type:h,content:n.trim(),status:"sending",created_at:new Date().toISOString()},w=F[t]||[];V(t,[...w,D]);try{const g={content:n.trim(),type:h},L=encodeURIComponent(t),C=await e(`agents/${c}/dialogs/${L}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:g}),z=F[t]||[],S=z.findIndex(P=>P.id===v);if(S!==-1){const P=[...z];P[S]={...P[S],status:"sent"},V(t,P)}if(u(t,n.trim().slice(0,100),C.created_at||new Date().toISOString()),l){const P=(C==null?void 0:C.id)||(C==null?void 0:C.message_id);P&&await o(c,t,P)}return C}catch(g){const L=F[t]||[],C=L.findIndex(z=>z.id===v);if(C!==-1){const z=[...L];z[C]={...z[C],status:"failed",error_message:X(g,"Ошибка отправки")},V(t,z)}return te.value=X(g,"Не удалось отправить сообщение"),null}finally{re.value=!1}},N=async(c,t,n,h=!0)=>{const l=F[t]||[],v=l.find(D=>D.id===n);!v||v.status!=="failed"||(V(t,l.filter(D=>D.id!==n)),await b(c,t,v.content,v.type,h))},A=async(c,t,n)=>{if(!c||!t||!n.trim())return null;re.value=!0,te.value=null;const h=`temp-mgr-${Date.now()}`,l={id:h,dialog_id:t,role:"manager",type:"text",content:n.trim(),status:"sending",created_at:new Date().toISOString()},v=F[t]||[];V(t,[...v,l]);try{const D={content:n.trim()},w=encodeURIComponent(t);await e(`agents/${c}/dialogs/${w}/manager-message`,{method:"POST",headers:{"Content-Type":"application/json"},body:D});const g=F[t]||[],L=g.findIndex(C=>C.id===h);if(L!==-1){const C=[...g];C[L]={...C[L],status:"sent"},V(t,C)}return u(t,n.trim().slice(0,100),new Date().toISOString()),{...l,status:"sent"}}catch(D){const w=F[t]||[],g=w.findIndex(L=>L.id===h);if(g!==-1){const L=[...w];L[g]={...L[g],status:"failed",error_message:X(D,"Ошибка отправки")},V(t,L)}return te.value=X(D,"Не удалось отправить сообщение менеджера"),null}finally{re.value=!1}},m=(c,t,n="text")=>{const h=`temp-${Date.now()}`,l={id:h,dialog_id:c,role:"user",type:n,content:t.trim(),status:"sending",created_at:new Date().toISOString()},v=F[c]||[];return V(c,[...v,l]),re.value=!0,h},p=(c,t,n)=>{const h=F[c]||[],l=h.findIndex(v=>v.id===t);if(l!==-1){const v=[...h];v[l]={...v[l],status:"sent"},V(c,v)}re.value=!1},k=(c,t,n)=>{const h=n||"Не удалось отправить сообщение",l=F[c]||[],v=l.findIndex(D=>D.id===t);if(v!==-1){const D=[...l];D[v]={...D[v],status:"failed",error_message:h},V(c,D)}re.value=!1,te.value=h},R=(c,t)=>{fe.value=!0;const n=`agent-${c}`;me.value=n;const h={id:n,dialog_id:t,role:"agent",type:"text",content:"",status:"streaming",created_at:new Date().toISOString()},l=F[t]||[];V(t,[...l,h])},x=(c,t,n)=>{const h=`agent-${c}`,l=F[t]||[],v=l.findIndex(D=>D.id===h);if(v!==-1){const D=[...l];D[v]={...D[v],content:n,status:"done"},V(t,D)}fe.value=!1,me.value=null},i=(c,t,n)=>{const h=`agent-${c}`,l=F[t]||[],v=l.findIndex(D=>D.id===h);if(v!==-1){const D=[...l];D[v]={...D[v],content:`Ошибка: ${n}`,status:"failed",error_message:n},V(t,D)}fe.value=!1,me.value=null,te.value=n},o=async(c,t,n)=>{var D,w,g,L,C;fe.value=!0,s(t,"IN_PROGRESS");const h=`agent-${Date.now()}`;me.value=h;const l={id:h,dialog_id:t,role:"agent",type:"text",content:"",status:"streaming",created_at:new Date().toISOString()},v=F[t]||[];V(t,[...v,l]);try{const z=Ge(),S=encodeURIComponent(t),P=await fetch(`/api/v1/agents/${c}/dialogs/${S}/messages/stream`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",Accept:"text/event-stream",...z?{Authorization:`Bearer ${z}`}:{}},body:JSON.stringify({user_message_id:n})});if(!P.ok)throw new Error(X({status:P.status},"Не удалось получить ответ агента"));const Z=(D=P.body)==null?void 0:D.getReader();if(!Z)throw new Error("No reader available");const he=new TextDecoder;let ee="";for(;;){const{done:Y,value:ge}=await Z.read();if(Y)break;ee+=he.decode(ge,{stream:!0});const Oe=ee.split(`
`);ee=Oe.pop()||"";for(const Ne of Oe)if(Ne.startsWith("data: ")){const Ue=Ne.slice(6);if(Ue==="[DONE]")continue;try{const se=JSON.parse(Ue);if(se.type==="delta"&&((w=se.data)!=null&&w.content)){const ye=F[t]||[],ie=ye.findIndex(K=>K.id===h);if(ie!==-1){const K=[...ye];K[ie]={...K[ie],content:K[ie].content+se.data.content},V(t,K)}}else if(se.type==="done"){const ye=F[t]||[],ie=ye.findIndex(K=>K.id===h);if(ie!==-1){const K=[...ye];K[ie]={...K[ie],id:((g=se.data)==null?void 0:g.message_id)||h,status:"done"},V(t,K)}}else if(se.type==="error")throw new Error(((L=se.data)==null?void 0:L.error)||"Stream error")}catch(se){console.warn("Failed to parse SSE event:",se)}}}const de=F[t]||[],le=de.findIndex(Y=>Y.id===h||Y.status==="streaming");if(le!==-1&&de[le].status==="streaming"){const Y=[...de];Y[le]={...Y[le],status:"done"},V(t,Y)}const Ae=((C=de[le])==null?void 0:C.content)||"";Ae&&u(t,Ae.slice(0,100),new Date().toISOString()),s(t,"NORMAL")}catch(z){console.error("Stream error:",z);const S=F[t]||[],P=S.findIndex(Z=>Z.id===h);if(P!==-1){const Z=S.filter((he,ee)=>ee!==P);V(t,Z)}s(t,"ERROR"),te.value=X(z,"Не удалось получить ответ агента")}finally{fe.value=!1,me.value=null}},r=(c,t)=>{const n=y(c)??c,h=F[n]||[];V(n,[...h,{...t,dialog_id:n}])},d=(c,t,n)=>{const h=y(c)??c,l=F[h]||[],v=l.findIndex(D=>D.id===t);if(v!==-1){const D=[...l];D[v]={...D[v],...n},V(h,D)}},U=c=>{const t=y(c)??c;delete F[t],Le.value.delete(t)},I=c=>Le.value.get(c)??!0,M=c=>{const t=(c==null?void 0:c.dialog_id)??(c==null?void 0:c.session_id),n=y(t);if(!n)return;const h=F[n]||[],l=Pe({...c,dialog_id:n},n);if(!l||h.some(w=>w.id===l.id))return;const v=Date.now();h.some(w=>w.role===l.role&&w.content.trim()===l.content.trim()&&w.status!=="failed"&&v-new Date(w.created_at).getTime()<15e3)||(V(n,[...h,l]),u(n,l.content.slice(0,100),l.created_at))};return{isLoading:be(we),isSending:be(re),isStreaming:be(fe),streamingMessageId:be(me),error:be(te),messagesMap:F,getMessages:_,dialogHasMore:I,fetchMessages:T,sendMessage:b,sendManagerMessage:A,retryMessage:N,addMessage:r,addIncomingMessage:M,updateMessage:d,clearMessages:U,createOptimisticMessage:m,markMessageSent:p,markMessageFailed:k,handleRunStart:R,handleRunResult:x,handleRunError:i,startAgentStream:o}},Et={maxAttempts:5,baseDelay:1e3,maxDelay:16e3},jt=(e,s)=>{const u=xe(),y=Ye(),{resolveDialogId:_}=u,T={...Et,...s==null?void 0:s.reconnectConfig},b=E("disconnected"),N=E(0),A=E(null),m=E(null),p=E(null);let k=null,R=null,x=null;const i=w=>{if(typeof window>"u")return null;const g=Ge();if(!g)return console.error("[WebSocket] No auth token found"),null;const L=window.location.protocol==="https:"?"wss:":"ws:",C=window.location.host;return`${L}//${C}/api/v1/agents/${w}/ws?token=${g}`},o=w=>{if(!k||k.readyState!==WebSocket.OPEN)return console.warn("[WebSocket] Cannot send - connection not open"),!1;try{return k.send(JSON.stringify(w)),!0}catch(g){return console.error("[WebSocket] Send error:",g),!1}},r=w=>{try{const L=JSON.parse(w.data);switch(L.type){case"message_created":{const C=L.data,z=C.dialog_id??C.session_id,S=_(z)??(z?String(z):null);if(!S){console.warn("[WebSocket] message_created without dialog_id/session_id");break}const P=typeof C.role=="string"?C.role.toLowerCase():"";if(["tool","function","tool_result","function_result","tool_call","function_call","tool_use"].includes(P)||typeof C.content=="object"&&C.content!==null)break;const he=S===p.value,ee=C.user_info,de=(ee==null?void 0:ee.platform)||(S.startsWith("telegram:")?"telegram":void 0),le=typeof C.content=="string"?C.content:"";u.upsertDialog({id:S,session_id:S,last_message_preview:le,last_message_at:C.created_at,is_new:!he,platform:de,user_info:ee});const Y=y.getMessages(S).find(ge=>ge.status==="sending"&&(ge.role==="user"||ge.role==="manager")&&ge.content.trim()===le.trim());Y?y.markMessageSent(S,Y.id,C.id):y.addIncomingMessage({...C,dialog_id:S}),he&&u.markAsRead(S);break}case"dialog_updated":{u.upsertDialog(L.data);break}case"run_start":{const{run_id:C,dialog_id:z}=L.data,S=_(z)??z;A.value=C,m.value=S,y.handleRunStart(C,S),u.updateDialogStatus(S,"IN_PROGRESS");break}case"run_result":{const{run_id:C,output:z,dialog_id:S}=L.data,P=_(S)??S,Z=P===p.value;y.handleRunResult(C,P,z),u.upsertDialog({id:P,last_message_preview:z.slice(0,100),last_message_at:new Date().toISOString(),is_new:!Z}),u.updateDialogStatus(P,"NORMAL"),Z&&u.markAsRead(P),A.value===C&&(A.value=null,m.value=null);break}case"run_error":{const{run_id:C,error:z,dialog_id:S}=L.data,P=_(S)??S;y.handleRunError(C,P,z),u.updateDialogStatus(P,"ERROR"),A.value===C&&(A.value=null,m.value=null);break}case"ping":{o({type:"pong"}),d();break}case"error":{console.error("[WebSocket] Server error:",L.data.message);break}case"status":case"dialog_joined":case"dialog_left":break;default:console.warn("[WebSocket] Unknown message type:",L.type)}}catch(g){console.error("[WebSocket] Error parsing message:",g)}},d=()=>{x&&clearTimeout(x),x=setTimeout(()=>{console.warn("[WebSocket] No ping received in 60s, reconnecting..."),c()},6e4)},U=()=>{if(N.value>=T.maxAttempts){console.error("[WebSocket] Max reconnect attempts reached"),b.value="error";return}const w=Math.min(T.baseDelay*Math.pow(2,N.value),T.maxDelay);R=setTimeout(()=>{N.value++,I()},w)},I=()=>{const w=j(e);if(!w||typeof window>"u"){console.warn("[WebSocket] Cannot connect - no agent ID or not in browser");return}M(!1);const g=i(w);if(g){b.value="connecting";try{k=new WebSocket(g),k.onopen=()=>{b.value="connected",N.value=0,d()},k.onclose=L=>{b.value="disconnected",x&&(clearTimeout(x),x=null),L.code!==1e3&&L.code!==1008?U():L.code===1008&&(console.error("[WebSocket] Unauthorized - invalid token"),b.value="error")},k.onerror=L=>{console.error("[WebSocket] Error:",L),b.value="error"},k.onmessage=r}catch(L){console.error("[WebSocket] Connection error:",L),b.value="error",U()}}},M=(w=!0)=>{w&&R&&(clearTimeout(R),R=null),x&&(clearTimeout(x),x=null),k&&(k.close(1e3,"Client closed"),k=null),p.value=null,w&&(b.value="disconnected",N.value=0)},c=()=>{M(!1),N.value=0,I()},t=(w,g)=>o({type:"send_message",dialog_id:w,content:g}),n=w=>{const g=o({type:"join_dialog",dialog_id:w});return g&&(p.value=w),g},h=w=>{const g=o({type:"leave_dialog",dialog_id:w});return g&&p.value===w&&(p.value=null),g},l=()=>o({type:"get_status"});Q(()=>j(e),(w,g)=>{w!==g&&(w?I():M())},{immediate:(s==null?void 0:s.autoConnect)!==!1}),ze(()=>{M()});const v=W(()=>b.value==="connected"),D=W(()=>b.value==="connecting");return{connectionState:b,isConnected:v,isConnecting:D,reconnectAttempts:N,connect:I,disconnect:M,reconnect:c,sendMessage:t,joinDialog:n,leaveDialog:h,getStatus:l}},Ot={class:"flex-1 min-w-0"},Nt={class:"flex items-center gap-2"},Ut={key:0,class:"px-1.5 py-0.5 text-[10px] font-medium rounded bg-blue-100 text-blue-700"},Wt={key:0,class:"text-xs text-blue-500 truncate"},Bt={class:"text-xs text-slate-500 truncate mt-0.5"},Pt={class:"flex flex-col items-end gap-1 flex-shrink-0"},zt={class:"text-xs text-slate-400"},Ft={key:0,class:"px-1.5 py-0.5 text-[10px] font-medium rounded bg-green-100 text-green-700 flex items-center gap-0.5"},qt={key:1,class:"px-1.5 py-0.5 text-[10px] font-medium rounded bg-amber-100 text-amber-700 flex items-center gap-0.5"},Ht={key:0,class:"fixed inset-0 z-[110] flex items-center justify-center p-4"},Vt={class:"relative bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full"},Gt={class:"flex gap-3 mt-4"},Jt=["disabled"],Kt={key:0,class:"fixed inset-0 z-[110] flex items-center justify-center p-4"},Xt={class:"relative bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full"},Yt={class:"flex gap-3"},Qt=oe({__name:"DialogItem",props:{dialog:{},isSelected:{type:Boolean}},emits:["click","rename","delete"],setup(e,{emit:s}){const u=e,y=s,_=E(!1),T=E(null),b=E({x:0,y:0}),N=E(!1),A=E(""),m=E(null),p=E(!1);Je(T,()=>{_.value=!1});const k=W(()=>{var t;return u.dialog.platform==="telegram"||((t=u.dialog.id)==null?void 0:t.startsWith("telegram:"))}),R=W(()=>{var t;return((t=u.dialog.user_info)==null?void 0:t.username)||null}),x=W(()=>{const t=u.dialog.user_info;return t!=null&&t.first_name||t!=null&&t.last_name?[t.first_name,t.last_name].filter(Boolean).join(" "):t!=null&&t.username?`@${t.username}`:k.value&&u.dialog.id?`Telegram #${u.dialog.id.replace("telegram:","")}`:"Диалог"}),i=W(()=>{if(!u.dialog.last_message_at)return"";const t=new Date(u.dialog.last_message_at),h=new Date().getTime()-t.getTime(),l=Math.floor(h/(1e3*60*60*24));return l===0?t.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}):l===1?"Вчера":l<7?t.toLocaleDateString("ru-RU",{weekday:"short"}):t.toLocaleDateString("ru-RU",{day:"numeric",month:"short"})}),o=W(()=>(u.dialog.agent_status??"active")==="active"),r=W(()=>{const t=u.dialog.status;return t==="IN_PROGRESS"&&!o.value?u.dialog.unread_count>0?"UNREAD":null:t==="IN_PROGRESS"?"IN_PROGRESS":t==="ERROR"?"ERROR":u.dialog.unread_count>0?"UNREAD":t==="NEW"?"NEW":null}),d=t=>{t.preventDefault(),b.value={x:t.clientX,y:t.clientY},_.value=!0},U=()=>{_.value=!1,A.value=u.dialog.title||"",N.value=!0,pe(()=>{var t,n;(t=m.value)==null||t.focus(),(n=m.value)==null||n.select()})},I=()=>{A.value.trim()&&(y("rename",u.dialog.id,A.value.trim()),N.value=!1)},M=()=>{_.value=!1,p.value=!0},c=()=>{y("delete",u.dialog.id),p.value=!1};return(t,n)=>{const h=tt("StatusIndicator");return f(),$("div",{class:"relative group",onContextmenu:Te(d,["prevent"])},[a("button",{onClick:n[0]||(n[0]=l=>t.$emit("click")),class:G(["w-full px-4 py-3 flex items-start gap-3 text-left transition-colors",[e.isSelected?"bg-indigo-50":"hover:bg-slate-50"]])},[a("div",{class:G(["w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0",[k.value?e.isSelected?"bg-blue-100":"bg-blue-50":e.isSelected?"bg-indigo-100":"bg-slate-100"]])},[k.value?(f(),$("svg",{key:0,class:G(["w-5 h-5",[e.isSelected?"text-blue-600":"text-blue-500"]]),viewBox:"0 0 24 24",fill:"currentColor"},[...n[6]||(n[6]=[a("path",{d:"M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"},null,-1)])],2)):(f(),J(j(ke),{key:1,class:G(["w-5 h-5",[e.isSelected?"text-indigo-600":"text-slate-500"]])},null,8,["class"]))],2),a("div",Ot,[a("div",Nt,[a("h3",{class:G(["text-sm font-semibold truncate",[e.isSelected?"text-indigo-900":"text-slate-900"]])},H(x.value),3),k.value?(f(),$("span",Ut," TG ")):q("",!0),r.value?(f(),J(h,{key:1,status:r.value,count:e.dialog.unread_count},null,8,["status","count"])):q("",!0)]),R.value?(f(),$("p",Wt," @"+H(R.value),1)):q("",!0),a("p",Bt,H(e.dialog.last_message_preview||"Нет сообщений"),1)]),a("div",Pt,[a("span",zt,H(i.value),1),o.value?(f(),$("span",Ft,[...n[7]||(n[7]=[a("span",{class:"w-1.5 h-1.5 bg-green-500 rounded-full"},null,-1),ve(" Агент ",-1)])])):(f(),$("span",qt,[B(j(Dt),{class:"w-3 h-3"}),n[8]||(n[8]=ve(" Пауза ",-1))]))])],2),a("button",{onClick:Te(d,["stop"]),class:"absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-lg opacity-0 group-hover:opacity-100 hover:bg-slate-200 transition-opacity lg:block hidden"},[B(j(ct),{class:"w-4 h-4 text-slate-500"})]),(f(),J(De,{to:"body"},[B(ce,{"enter-active-class":"transition duration-100 ease-out","enter-from-class":"opacity-0 scale-95","enter-to-class":"opacity-100 scale-100","leave-active-class":"transition duration-75 ease-in","leave-from-class":"opacity-100 scale-100","leave-to-class":"opacity-0 scale-95"},{default:ae(()=>[_.value?(f(),$("div",{key:0,ref_key:"contextMenuRef",ref:T,class:"fixed bg-white rounded-xl shadow-lg border border-slate-200 py-1 z-[100] min-w-[160px]",style:Fe({top:`${b.value.y}px`,left:`${b.value.x}px`})},[a("button",{onClick:U,class:"w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2"},[B(j(ut),{class:"w-4 h-4"}),n[9]||(n[9]=ve(" Переименовать ",-1))]),a("button",{onClick:M,class:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"},[B(j(dt),{class:"w-4 h-4"}),n[10]||(n[10]=ve(" Удалить ",-1))])],4)):q("",!0)]),_:1})])),(f(),J(De,{to:"body"},[B(ce,{name:"modal-fade"},{default:ae(()=>[N.value?(f(),$("div",Ht,[a("div",{class:"absolute inset-0 bg-black/50",onClick:n[1]||(n[1]=l=>N.value=!1)}),a("div",Vt,[n[11]||(n[11]=a("h3",{class:"text-lg font-bold text-slate-900 mb-4"},"Переименовать диалог",-1)),Ee(a("input",{"onUpdate:modelValue":n[2]||(n[2]=l=>A.value=l),type:"text",placeholder:"Название диалога",class:"w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent",onKeyup:et(I,["enter"]),ref_key:"renameInputRef",ref:m},null,544),[[je,A.value]]),a("div",Gt,[a("button",{onClick:n[3]||(n[3]=l=>N.value=!1),class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors"}," Отмена "),a("button",{onClick:I,disabled:!A.value.trim(),class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors"}," Сохранить ",8,Jt)])])])):q("",!0)]),_:1})])),(f(),J(De,{to:"body"},[B(ce,{name:"modal-fade"},{default:ae(()=>[p.value?(f(),$("div",Kt,[a("div",{class:"absolute inset-0 bg-black/50",onClick:n[4]||(n[4]=l=>p.value=!1)}),a("div",Xt,[n[12]||(n[12]=a("h3",{class:"text-lg font-bold text-slate-900 mb-2"},"Удалить диалог?",-1)),n[13]||(n[13]=a("p",{class:"text-sm text-slate-500 mb-6"}," Это действие нельзя отменить. Все сообщения будут удалены. ",-1)),a("div",Yt,[a("button",{onClick:n[5]||(n[5]=l=>p.value=!1),class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors"}," Отмена "),a("button",{onClick:c,class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-bold text-white bg-red-600 hover:bg-red-700 transition-colors"}," Удалить ")])])])):q("",!0)]),_:1})]))],32)}}}),Zt=Ce(Qt,[["__scopeId","data-v-1509f877"]]),es={class:"h-full flex flex-col"},ts={class:"p-4 border-b border-slate-200"},ss={class:"w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"},ns={class:"text-white font-bold text-sm"},as={class:"flex-1 text-left min-w-0"},os={class:"text-sm font-semibold text-slate-900 truncate"},ls={class:"text-xs text-slate-500"},is={key:0,class:"absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-lg border border-slate-200 z-50 max-h-64 overflow-y-auto"},rs={class:"p-2"},cs=["onClick"],us={class:"w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"},ds={class:"text-white font-bold text-xs"},gs={class:"text-sm font-medium truncate"},fs={key:0,class:"px-3 py-4 text-center text-sm text-slate-500"},ms={class:"px-4 py-3"},vs={class:"relative"},ps={class:"flex-1 overflow-y-auto"},xs={key:0,class:"flex items-center justify-center py-8"},hs={key:1,class:"px-4 py-8 text-center"},ys={class:"text-sm text-slate-500"},bs=oe({__name:"DialogsSidebar",props:{agents:{},selectedAgentId:{},selectedDialogId:{},isLoading:{type:Boolean}},emits:["select-agent","select-dialog","create-dialog"],setup(e,{emit:s}){const u=e,y=s,{dialogs:_,isLoading:T,updateDialog:b,deleteDialog:N}=xe(),A=E(null),m=E(!1),p=E("");Je(A,()=>{m.value=!1});const k=W(()=>u.agents.find(M=>M.id===u.selectedAgentId)),R=W(()=>{var M;return((M=k.value)==null?void 0:M.name)||"Выберите агента"}),x=W(()=>{var M;return r(((M=k.value)==null?void 0:M.name)||"")}),i=W(()=>{const M=u.agents.length;return M===1?"агент":M>=2&&M<=4?"агента":"агентов"}),o=W(()=>{if(!p.value.trim())return _.value;const M=p.value.toLowerCase();return _.value.filter(c=>{const t=c.title||"Диалог",n=c.last_message_preview||"";return t.toLowerCase().includes(M)||n.toLowerCase().includes(M)})}),r=M=>M?M.split(" ").map(c=>c.charAt(0)).join("").toUpperCase().slice(0,2):"?",d=M=>{m.value=!1,y("select-agent",M)},U=async(M,c)=>{u.selectedAgentId&&await b(u.selectedAgentId,M,{title:c})},I=async M=>{u.selectedAgentId&&await N(u.selectedAgentId,M)};return Q(()=>u.selectedAgentId,()=>{p.value=""}),(M,c)=>(f(),$("div",es,[a("div",ts,[a("div",{class:"relative",ref_key:"dropdownRef",ref:A},[a("button",{onClick:c[0]||(c[0]=t=>m.value=!m.value),class:"w-full flex items-center gap-3 px-3 py-2.5 bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors"},[a("div",ss,[a("span",ns,H(x.value),1)]),a("div",as,[a("p",os,H(R.value),1),a("p",ls,H(e.agents.length)+" "+H(i.value),1)]),B(j(gt),{class:G(["w-5 h-5 text-slate-400 transition-transform",{"rotate-180":m.value}])},null,8,["class"])]),B(ce,{"enter-active-class":"transition duration-150 ease-out","enter-from-class":"opacity-0 scale-95","enter-to-class":"opacity-100 scale-100","leave-active-class":"transition duration-100 ease-in","leave-from-class":"opacity-100 scale-100","leave-to-class":"opacity-0 scale-95"},{default:ae(()=>[m.value?(f(),$("div",is,[a("div",rs,[(f(!0),$(ue,null,Ie(e.agents,t=>(f(),$("button",{key:t.id,onClick:n=>d(t.id),class:G(["w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors",[t.id===e.selectedAgentId?"bg-indigo-50 text-indigo-900":"hover:bg-slate-50 text-slate-700"]])},[a("div",us,[a("span",ds,H(r(t.name)),1)]),a("span",gs,H(t.name),1),t.id===e.selectedAgentId?(f(),J(j(Ke),{key:0,class:"w-4 h-4 text-indigo-600 ml-auto flex-shrink-0"})):q("",!0)],10,cs))),128)),e.agents.length===0?(f(),$("div",fs," Нет доступных агентов ")):q("",!0)])])):q("",!0)]),_:1})],512)]),a("div",ms,[a("div",vs,[B(j(ft),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),Ee(a("input",{"onUpdate:modelValue":c[1]||(c[1]=t=>p.value=t),type:"text",placeholder:"Поиск диалогов...",class:"w-full pl-9 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"},null,512),[[je,p.value]])])]),a("div",ps,[e.isLoading||j(T)?(f(),$("div",xs,[B(j(Me),{class:"w-6 h-6 text-indigo-600 animate-spin"})])):o.value.length===0?(f(),$("div",hs,[B(j(ke),{class:"w-12 h-12 text-slate-300 mx-auto mb-3"}),a("p",ys,H(p.value?"Диалоги не найдены":"Нет диалогов"),1),!p.value&&e.selectedAgentId?(f(),$("button",{key:0,onClick:c[2]||(c[2]=t=>M.$emit("create-dialog")),class:"mt-3 text-sm text-indigo-600 hover:text-indigo-700 font-medium"}," Создать первый диалог ")):q("",!0)])):(f(),J(qe,{key:2,tag:"div",class:"divide-y divide-slate-100",name:"dialog-list"},{default:ae(()=>[(f(!0),$(ue,null,Ie(o.value,t=>(f(),J(Zt,{key:t.id,dialog:t,"is-selected":t.id===e.selectedDialogId,onClick:n=>M.$emit("select-dialog",t.id),onRename:U,onDelete:I},null,8,["dialog","is-selected","onClick"]))),128))]),_:1}))])]))}}),_s=Ce(bs,[["__scopeId","data-v-26ed367c"]]),ks={class:"bg-white border-b border-slate-200 px-4 py-3 flex items-center gap-3 flex-shrink-0"},Ss={key:0,class:"w-5 h-5 text-blue-600",viewBox:"0 0 24 24",fill:"currentColor"},Ms={key:1,class:"text-white font-bold text-sm"},$s={class:"flex-1 min-w-0"},Ds={class:"text-sm font-semibold text-slate-900 truncate"},Cs={key:0,class:"text-xs text-blue-600 truncate"},As={class:"flex items-center gap-1.5 mt-0.5"},Rs={class:"text-xs text-slate-500"},ws={class:"text-xs text-slate-500"},Ls={class:"flex items-center gap-2"},Ts=["aria-checked","title"],Is=oe({__name:"ChatHeader",props:{agent:{},dialog:{},isStreaming:{type:Boolean}},emits:["back"],setup(e){const s=e,{toggleDialogAgentStatus:u}=xe(),y=W(()=>{var m;return(((m=s.dialog)==null?void 0:m.agent_status)??"active")==="active"}),_=W(()=>{var m,p,k;return((m=s.dialog)==null?void 0:m.platform)==="telegram"||((k=(p=s.dialog)==null?void 0:p.id)==null?void 0:k.startsWith("telegram:"))}),T=W(()=>{var m,p;return((p=(m=s.dialog)==null?void 0:m.user_info)==null?void 0:p.username)||""}),b=W(()=>{var p,k;const m=(p=s.dialog)==null?void 0:p.user_info;return m!=null&&m.first_name||m!=null&&m.last_name?[m.first_name,m.last_name].filter(Boolean).join(" "):m!=null&&m.username?`@${m.username}`:_.value&&((k=s.dialog)!=null&&k.id)?`Telegram #${s.dialog.id.replace("telegram:","")}`:"Диалог"}),N=W(()=>{var p,k;const m=(p=s.dialog)==null?void 0:p.user_info;if(m!=null&&m.first_name){const R=m.first_name.charAt(0),x=((k=m.last_name)==null?void 0:k.charAt(0))||"";return(R+x).toUpperCase()}return m!=null&&m.username?m.username.charAt(0).toUpperCase():"?"}),A=()=>{var m;(m=s.dialog)!=null&&m.id&&u(s.agent.id,s.dialog.id)};return(m,p)=>(f(),$("div",ks,[a("button",{onClick:p[0]||(p[0]=k=>m.$emit("back")),class:"lg:hidden p-2 -ml-2 rounded-lg text-slate-600 hover:bg-slate-100 transition-colors"},[B(j(mt),{class:"w-5 h-5"})]),a("div",{class:G(["w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0",[_.value?"bg-blue-100":"bg-gradient-to-br from-indigo-500 to-purple-600"]])},[_.value?(f(),$("svg",Ss,[...p[1]||(p[1]=[a("path",{d:"M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"},null,-1)])])):(f(),$("span",Ms,H(N.value),1))],2),a("div",$s,[a("h2",Ds,H(b.value),1),_.value&&T.value?(f(),$("p",Cs," @"+H(T.value),1)):q("",!0),a("div",As,[e.isStreaming&&y.value?(f(),$(ue,{key:0},[B(j(Me),{class:"w-3 h-3 text-indigo-600 animate-spin"}),p[2]||(p[2]=a("span",{class:"text-xs text-indigo-600 font-medium"},"В работе...",-1))],64)):y.value?(f(),$(ue,{key:2},[p[4]||(p[4]=a("span",{class:"w-2 h-2 bg-green-500 rounded-full"},null,-1)),a("span",ws,H(e.agent.name),1)],64)):(f(),$(ue,{key:1},[p[3]||(p[3]=a("span",{class:"w-2 h-2 bg-slate-400 rounded-full"},null,-1)),a("span",Rs,H(e.agent.name)+" · Выкл.",1)],64))])]),a("div",Ls,[a("button",{onClick:A,class:G(["relative w-11 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2",[y.value?"bg-indigo-600":"bg-slate-300"]]),role:"switch","aria-checked":y.value,title:y.value?"Выключить агента":"Включить агента"},[a("span",{class:G(["absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform",[y.value?"translate-x-5":"translate-x-0"]])},null,2)],10,Ts)])]))}}),Es=["innerHTML"],js=["src"],Os={key:2,class:"flex items-center gap-3 min-w-[200px]"},Ns={class:"flex-1"},Us={key:3,class:"flex items-center gap-1 mt-1"},Ws={class:"text-[10px] text-slate-400"},Bs={key:2,class:"flex items-center gap-1"},Ps=oe({__name:"MessageBubble",props:{message:{}},emits:["retry","image-click"],setup(e){const s=e,u=vt({linkify:!0,breaks:!0}),y=E(!1),_=E(0),T=E(null),b=W(()=>s.message.role==="agent"),N=W(()=>s.message.role==="manager"),A=W(()=>b.value||N.value),m=W(()=>N.value?"bg-emerald-600 text-white rounded-br-sm":b.value?"bg-indigo-600 text-white rounded-br-sm":"bg-white border border-slate-200 text-slate-900 rounded-bl-sm shadow-sm"),p=W(()=>s.message.type!=="text"?"":u.render(s.message.content)),k=W(()=>new Date(s.message.created_at).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})),R=W(()=>{const i=s.message.duration_seconds||0,o=Math.floor(i/60),r=i%60;return`${o}:${r.toString().padStart(2,"0")}`}),x=()=>{T.value||(T.value=new Audio(s.message.content),T.value.addEventListener("timeupdate",()=>{T.value&&(_.value=T.value.currentTime/T.value.duration*100)}),T.value.addEventListener("ended",()=>{y.value=!1,_.value=0})),y.value?T.value.pause():T.value.play(),y.value=!y.value};return(i,o)=>(f(),$("div",{class:G(["flex",[A.value?"justify-end":"justify-start"]])},[a("div",{class:G(["max-w-[85%] sm:max-w-[70%] lg:max-w-[60%]",[A.value?"order-1":"order-2"]])},[a("div",{class:G(["text-[11px] font-medium mb-1 px-1",[N.value?"text-right text-emerald-600":b.value?"text-right text-indigo-600":"text-left text-slate-500"]])},H(N.value?"Менеджер":b.value?"Агент":"Пользователь"),3),a("div",{class:G(["rounded-2xl px-4 py-2.5 relative",m.value])},[e.message.type==="text"?(f(),$("div",{key:0,class:G(["text-sm whitespace-pre-wrap break-words prose prose-sm max-w-none",[A.value?"prose-invert":""]]),innerHTML:p.value},null,10,Es)):e.message.type==="image"?(f(),$("img",{key:1,src:e.message.content,alt:"Image",class:"rounded-lg max-w-full cursor-pointer hover:opacity-90 transition-opacity",onClick:o[0]||(o[0]=r=>i.$emit("image-click",e.message.content))},null,8,js)):e.message.type==="voice"?(f(),$("div",Os,[a("button",{onClick:x,class:G(["w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 transition-colors",[A.value?"bg-white/20 hover:bg-white/30 text-white":"bg-slate-200 hover:bg-slate-300 text-slate-700"]])},[y.value?(f(),J(j(Ct),{key:0,class:"w-5 h-5"})):(f(),J(j(pt),{key:1,class:"w-5 h-5 ml-0.5"}))],2),a("div",Ns,[a("div",{class:G(["h-1 rounded-full overflow-hidden",[A.value?"bg-white/30":"bg-slate-300"]])},[a("div",{class:G(["h-full transition-all",[A.value?"bg-white":"bg-slate-600"]]),style:Fe({width:`${_.value}%`})},null,6)],2),a("span",{class:G(["text-xs mt-1 block",[A.value?"text-white/70":"text-slate-500"]])},H(R.value),3)])])):q("",!0),e.message.status==="streaming"?(f(),$("div",Us,[...o[2]||(o[2]=[a("span",{class:"w-1.5 h-1.5 bg-current rounded-full animate-pulse opacity-60"},null,-1)])])):q("",!0)],2),a("div",{class:G(["flex items-center gap-2 mt-1 px-1",[A.value?"justify-end":"justify-start"]])},[a("span",Ws,H(k.value),1),A.value?(f(),$(ue,{key:0},[e.message.status==="sending"?(f(),J(j(Me),{key:0,class:"w-3 h-3 text-slate-400 animate-spin"})):e.message.status==="sent"?(f(),J(j(Ke),{key:1,class:"w-3 h-3 text-slate-400"})):e.message.status==="failed"?(f(),$("div",Bs,[B(j(Xe),{class:"w-3 h-3 text-red-500"}),a("button",{onClick:o[1]||(o[1]=r=>i.$emit("retry")),class:"text-[10px] text-red-500 hover:text-red-600 font-medium"}," Повторить ")])):q("",!0)],64)):q("",!0)],2)],2)],2))}}),zs=Ce(Ps,[["__scopeId","data-v-44947884"]]),Fs={class:"flex-1 flex items-center justify-center p-8"},qs={class:"text-center max-w-sm"},Hs={class:"w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6"},Vs={class:"text-lg font-semibold text-slate-900 mb-2"},Gs={class:"text-sm text-slate-500 mb-6"},Qe=oe({__name:"DialogsEmptyState",props:{type:{default:"no-dialog"},errorMessage:{}},emits:["create","retry"],setup(e){const s=e,u=W(()=>{switch(s.type){case"no-agent":return{icon:ke,title:"Выберите агента",description:"Выберите агента из списка слева, чтобы начать диалог.",showAction:!1,actionLabel:""};case"no-dialog":return{icon:ht,title:"Выберите диалог",description:"Выберите существующий диалог или создайте новый, чтобы начать общение с агентом.",showAction:!0,actionLabel:"Новый диалог"};case"no-messages":return{icon:ke,title:"Начните диалог",description:"Напишите сообщение, чтобы начать общение с агентом.",showAction:!1,actionLabel:""};case"error":return{icon:Xe,title:"Ошибка загрузки",description:s.errorMessage||"Не удалось загрузить данные. Попробуйте обновить страницу.",showAction:!0,actionLabel:"Повторить"};default:return{icon:ke,title:"Нет данных",description:"Данные отсутствуют.",showAction:!1,actionLabel:""}}}),y=W(()=>u.value.icon),_=W(()=>u.value.title),T=W(()=>u.value.description),b=W(()=>u.value.showAction),N=W(()=>u.value.actionLabel);return(A,m)=>(f(),$("div",Fs,[a("div",qs,[a("div",Hs,[(f(),J(st(y.value),{class:"w-10 h-10 text-slate-400"}))]),a("h3",Vs,H(_.value),1),a("p",Gs,H(T.value),1),b.value?(f(),$("button",{key:0,onClick:m[0]||(m[0]=p=>A.$emit("create")),class:"inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-semibold transition-colors"},[B(j(xt),{class:"w-4 h-4"}),ve(" "+H(N.value),1)])):q("",!0)])]))}}),Js={key:0,class:"flex justify-center py-3"},Ks={key:1,class:"flex justify-center py-3"},Xs={key:2,class:"h-full flex items-center justify-center"},Ys={key:4,class:"flex items-center gap-2 py-2 px-3 text-slate-500"},Qs=["src"],Zs=oe({__name:"MessagesFeed",props:{dialogId:{},messages:{},isLoading:{type:Boolean},isStreaming:{type:Boolean},hasMore:{type:Boolean}},emits:["load-more","retry"],setup(e){const s=e,u=E(null),y=E(!1),_=E(!0),T=E(null),b=E(!1),N=()=>{if(!u.value)return;const{scrollTop:x,scrollHeight:i,clientHeight:o}=u.value,r=i-x-o;_.value=r<100,_.value&&(y.value=!1)},A=(x=!0)=>{u.value&&(u.value.scrollTo({top:u.value.scrollHeight,behavior:x?"smooth":"auto"}),y.value=!1)},m=()=>{A(!0)};Q(()=>s.messages.length,(x,i)=>{if(x>i){!b.value&&i>0&&(b.value=!0);const o=s.messages[s.messages.length-1];_.value||(o==null?void 0:o.role)==="user"||(o==null?void 0:o.role)==="manager"?pe(()=>A(!1)):(o==null?void 0:o.role)==="agent"&&(y.value=!0)}}),Q(()=>s.dialogId,()=>{b.value=!1}),Q(()=>s.isStreaming,x=>{x&&_.value&&pe(()=>A(!1))});const p=x=>{T.value=x,document.body.style.overflow="hidden"},k=()=>{T.value=null,document.body.style.overflow=""},R=x=>{x.key==="Escape"&&T.value&&k()};return He(()=>{window.addEventListener("keydown",R),pe(()=>A(!1))}),ze(()=>{window.removeEventListener("keydown",R),document.body.style.overflow=""}),(x,i)=>(f(),$("div",{ref_key:"scrollContainerRef",ref:u,class:"flex-1 overflow-y-auto px-4 py-4",onScroll:N},[e.hasMore&&!e.isLoading?(f(),$("div",Js,[a("button",{onClick:i[0]||(i[0]=o=>x.$emit("load-more")),class:"text-sm text-indigo-600 hover:text-indigo-700 font-medium"}," Загрузить ранние сообщения ")])):q("",!0),e.isLoading&&e.messages.length>0?(f(),$("div",Ks,[B(j(Me),{class:"w-5 h-5 text-indigo-600 animate-spin"})])):q("",!0),!e.isLoading&&e.messages.length===0?(f(),$("div",Xs,[B(Qe,{type:"no-messages"})])):(f(),J(qe,{key:3,tag:"div",class:"space-y-4",name:b.value?"msg":"",css:b.value},{default:ae(()=>[(f(!0),$(ue,null,Ie(e.messages,o=>(f(),J(zs,{key:o.id,message:o,onRetry:r=>x.$emit("retry",o.id),onImageClick:p},null,8,["message","onRetry"]))),128))]),_:1},8,["name","css"])),e.isStreaming?(f(),$("div",Ys,[...i[2]||(i[2]=[nt('<div class="flex gap-1" data-v-50b57f6b><span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay:0ms;" data-v-50b57f6b></span><span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay:150ms;" data-v-50b57f6b></span><span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay:300ms;" data-v-50b57f6b></span></div><span class="text-xs" data-v-50b57f6b>Агент печатает...</span>',2)])])):q("",!0),B(ce,{"enter-active-class":"transition duration-200 ease-out","enter-from-class":"opacity-0 translate-y-4","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition duration-150 ease-in","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-4"},{default:ae(()=>[y.value?(f(),$("button",{key:0,onClick:m,class:"fixed bottom-24 left-1/2 -translate-x-1/2 lg:left-auto lg:translate-x-0 lg:right-8 px-4 py-2 bg-indigo-600 text-white rounded-full text-sm font-medium shadow-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 z-10"},[B(j(St),{class:"w-4 h-4"}),i[3]||(i[3]=ve(" Новые сообщения ",-1))])):q("",!0)]),_:1}),(f(),J(De,{to:"body"},[B(ce,{name:"lightbox-fade"},{default:ae(()=>[T.value?(f(),$("div",{key:0,class:"fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4",onClick:k},[a("button",{onClick:k,class:"absolute top-4 right-4 p-2 text-white/80 hover:text-white transition-colors"},[B(j(at),{class:"w-6 h-6"})]),a("img",{src:T.value,class:"max-w-full max-h-full object-contain",onClick:i[1]||(i[1]=Te(()=>{},["stop"]))},null,8,Qs)])):q("",!0)]),_:1})]))],544))}}),en=Ce(Zs,[["__scopeId","data-v-50b57f6b"]]),tn={class:"bg-white border-t border-slate-200 px-4 py-3 flex-shrink-0"},sn={key:0,class:"mb-3 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg flex items-center gap-2"},nn={class:"flex items-end gap-2"},an=["disabled"],on={class:"flex-1 relative"},ln=["disabled"],rn={disabled:!0,class:"p-2.5 rounded-xl text-slate-400 cursor-not-allowed transition-colors flex-shrink-0",title:"Голосовое сообщение (скоро)"},cn=["disabled"],un={key:1,class:"mt-1 text-right"},dn=oe({__name:"MessageComposer",props:{isSending:{type:Boolean},isStreaming:{type:Boolean},agentEnabled:{type:Boolean}},emits:["send","attach-image"],setup(e,{emit:s}){const u=e,y=s,_=E(null),T=E(null),b=E(""),N=W(()=>b.value.trim().length>0&&b.value.length<=4e3&&!u.isSending&&!u.isStreaming),A=()=>{N.value&&(y("send",b.value.trim()),b.value="",pe(()=>{var x;p(),(x=_.value)==null||x.focus()}))},m=x=>{x.key==="Enter"&&!x.shiftKey&&(x.preventDefault(),A())},p=()=>{_.value&&(_.value.style.height="auto",_.value.style.height=`${Math.min(_.value.scrollHeight,150)}px`)},k=()=>{var x;(x=T.value)==null||x.click()},R=x=>{var r;const i=x.target,o=(r=i.files)==null?void 0:r[0];o&&y("attach-image",o),i.value=""};return Q(b,x=>{x||pe(p)}),(x,i)=>(f(),$("div",tn,[e.agentEnabled?q("",!0):(f(),$("div",sn,[B(j(yt),{class:"w-4 h-4 text-emerald-600 flex-shrink-0"}),i[1]||(i[1]=a("span",{class:"text-xs text-emerald-700"}," Режим менеджера. Сообщения будут отправлены от вашего имени. ",-1))])),a("div",nn,[a("button",{onClick:k,disabled:e.isSending||e.isStreaming,class:"p-2.5 rounded-xl text-slate-500 hover:text-slate-700 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex-shrink-0",title:"Прикрепить изображение"},[B(j(Mt),{class:"w-5 h-5"})],8,an),a("input",{ref_key:"fileInputRef",ref:T,type:"file",accept:"image/*",class:"hidden",onChange:R},null,544),a("div",on,[Ee(a("textarea",{ref_key:"textareaRef",ref:_,"onUpdate:modelValue":i[0]||(i[0]=o=>b.value=o),onKeydown:m,onInput:p,disabled:e.isSending||e.isStreaming,placeholder:"Напишите сообщение...",rows:"1",class:"w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm resize-none placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed transition-all",style:{maxHeight:"150px"}},null,40,ln),[[je,b.value]])]),a("button",rn,[B(j($t),{class:"w-5 h-5"})]),a("button",{onClick:A,disabled:!N.value,class:"p-2.5 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors flex-shrink-0",title:"Отправить"},[e.isSending?(f(),J(j(Me),{key:0,class:"w-5 h-5 animate-spin"})):(f(),J(j(bt),{key:1,class:"w-5 h-5"}))],8,cn)]),b.value.length>500?(f(),$("div",un,[a("span",{class:G(["text-xs",b.value.length>4e3?"text-red-500":"text-slate-400"])},H(b.value.length)+" / 4000 ",3)])):q("",!0)]))}}),gn={class:"flex-1 flex flex-col h-full overflow-hidden"},fn={key:0,class:"px-4 py-2 bg-red-50 border-b border-red-200 text-red-700 text-sm flex items-center gap-2"},mn=oe({__name:"ChatArea",props:{dialogId:{},agent:{},wsSendMessage:{type:Function},isWsConnected:{type:Boolean}},emits:["back"],setup(e){const s=e,{messagesMap:u,fetchMessages:y,sendMessage:_,sendManagerMessage:T,retryMessage:b,createOptimisticMessage:N,markMessageFailed:A,isLoading:m,isSending:p,isStreaming:k,error:R,dialogHasMore:x}=Ye(),{markAsRead:i,getDialogById:o}=xe(),r=W(()=>u[s.dialogId]??[]),d=W(()=>o(s.dialogId)),U=W(()=>x(s.dialogId)),I=W(()=>{var l;return(((l=d.value)==null?void 0:l.agent_status)??"active")==="active"}),M=async()=>{console.log("[ChatArea] loadMessages for dialog:",s.dialogId,"agent:",s.agent.id),await y(s.agent.id,s.dialogId,{limit:50}),console.log("[ChatArea] Messages loaded, count:",r.value.length,"error:",R.value),i(s.dialogId)},c=async()=>{const l=r.value[0];l&&await y(s.agent.id,s.dialogId,{before:l.id,limit:30})},t=async l=>{if(!I.value){await T(s.agent.id,s.dialogId,l);return}if(s.isWsConnected&&s.wsSendMessage){const v=N(s.dialogId,l,"text");s.wsSendMessage(s.dialogId,l)||A(s.dialogId,v,"WebSocket отключен")}else await _(s.agent.id,s.dialogId,l,"text",I.value)},n=async l=>{},h=async l=>{await b(s.agent.id,s.dialogId,l,I.value)};return Q(()=>s.dialogId,()=>M(),{immediate:!0}),(l,v)=>(f(),$("div",gn,[B(Is,{agent:e.agent,dialog:d.value,"is-streaming":j(k),onBack:v[0]||(v[0]=D=>l.$emit("back"))},null,8,["agent","dialog","is-streaming"]),j(R)?(f(),$("div",fn,[v[1]||(v[1]=a("span",{class:"font-medium"},"Ошибка загрузки:",-1)),a("span",null,H(j(R)),1),a("button",{onClick:M,class:"ml-auto text-red-600 hover:text-red-800 underline text-xs"}," Повторить ")])):q("",!0),B(en,{"dialog-id":e.dialogId,messages:r.value,"is-loading":j(m),"is-streaming":j(k),"has-more":U.value,onLoadMore:c,onRetry:h},null,8,["dialog-id","messages","is-loading","is-streaming","has-more"]),B(dn,{"is-sending":j(p),"is-streaming":j(k),"agent-enabled":I.value,onSend:t,onAttachImage:n},null,8,["is-sending","is-streaming","agent-enabled"])]))}}),vn={class:"h-screen flex flex-col bg-slate-50 overflow-hidden"},pn={key:0,class:"lg:hidden bg-white border-b border-slate-200 px-4 py-3 shrink-0"},xn={class:"flex items-center justify-between"},hn={class:"flex flex-1 min-h-0"},yn={key:0,class:"lg:hidden fixed inset-0 z-50 w-full"},bn={class:"flex-1 min-w-0 flex overflow-hidden"},na=oe({__name:"dialogs",setup(e){const{isAuthenticated:s}=rt(),u=E(!1),y=E(!1),_=ot(),T=lt(),{agents:b,isLoading:N,fetchAgents:A}=it(),{fetchDialogs:m,createDialog:p}=xe(),k=E(_.query.agentId||null),R=E(_.query.dialogId||null),x=E(!R.value),i=E(null),{isConnected:o,sendMessage:r,joinDialog:d,leaveDialog:U}=jt(W(()=>k.value)),I=W(()=>{if(k.value)return b.value.find(l=>l.id===k.value)}),M=async l=>{k.value=l,R.value=null,T.push({query:{..._.query,agentId:l,dialogId:void 0}}),await m(l)},c=l=>{R.value=l,x.value=!1,T.push({query:{..._.query,dialogId:l}})};Q(()=>_.query.agentId,l=>{k.value=typeof l=="string"?l:null}),Q(()=>_.query.dialogId,l=>{R.value=typeof l=="string"?l:null,R.value&&(x.value=!1)}),Q([o,R],([l,v])=>{if(!l){i.value=null;return}i.value&&i.value!==v&&(U(i.value),i.value=null),v&&i.value!==v&&(d(v)?i.value=v:console.warn("[Page] Failed to join dialog (WebSocket not ready):",v))},{immediate:!0});const t=async()=>{if(!k.value){b.value.length>0&&await M(b.value[0].id);return}const l=await p(k.value);l&&c(l.id)},n=()=>{u.value=!1,h()},h=async()=>{await A(),k.value?await m(k.value):b.value.length>0&&await M(b.value[0].id)};return Q(s,l=>{l&&h()}),He(()=>{s.value?h():u.value=!0}),(l,v)=>(f(),$("div",vn,[x.value||!R.value?(f(),$("div",pn,[a("div",xn,[v[5]||(v[5]=a("div",{class:"flex items-center gap-2"},[a("div",{class:"w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center"},[a("span",{class:"text-white font-bold text-xs"},"М")]),a("span",{class:"text-slate-900 font-bold"},"Диалоги")],-1)),a("button",{onClick:v[0]||(v[0]=D=>y.value=!y.value),class:"p-2 rounded-lg text-slate-600 hover:bg-slate-100"},[B(j(_t),{class:"h-5 w-5"})])])])):q("",!0),a("div",hn,[B(We,{class:"hidden lg:flex"}),y.value?(f(),$("div",{key:0,class:"lg:hidden fixed inset-0 z-40 bg-black bg-opacity-50",onClick:v[1]||(v[1]=D=>y.value=!1)})):q("",!0),B(ce,{"enter-active-class":"transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1)","enter-from-class":"-translate-x-full opacity-0 scale-95","enter-to-class":"translate-x-0 opacity-100 scale-100","leave-active-class":"transition-all duration-400 ease-in","leave-from-class":"translate-x-0 opacity-100 scale-100","leave-to-class":"-translate-x-full opacity-0 scale-95"},{default:ae(()=>[y.value?(f(),$("div",yn,[B(We,{onClose:v[2]||(v[2]=D=>y.value=!1)})])):q("",!0)]),_:1}),a("main",bn,[a("div",{class:G(["w-full lg:w-80 xl:w-96 flex-shrink-0 border-r border-slate-200 bg-white",!x.value&&R.value?"hidden lg:flex lg:flex-col":"flex flex-col"])},[B(_s,{agents:j(b),"selected-agent-id":k.value,"selected-dialog-id":R.value,"is-loading":j(N),onSelectAgent:M,onSelectDialog:c,onCreateDialog:t},null,8,["agents","selected-agent-id","selected-dialog-id","is-loading"])],2),a("div",{class:G(["flex-1 flex flex-col bg-slate-50",x.value&&R.value?"hidden lg:flex":"flex"])},[R.value&&I.value?(f(),J(mn,{key:R.value,"dialog-id":R.value,agent:I.value,"ws-send-message":j(r),"is-ws-connected":j(o),onBack:v[3]||(v[3]=D=>x.value=!0)},null,8,["dialog-id","agent","ws-send-message","is-ws-connected"])):(f(),J(Qe,{key:1,type:"no-dialog",onCreate:t}))],2)])]),B(kt,{"is-open":u.value,onClose:v[4]||(v[4]=D=>u.value=!1),onAuthenticated:n},null,8,["is-open"])]))}});export{na as default};
