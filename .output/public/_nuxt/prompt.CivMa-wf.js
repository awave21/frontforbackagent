import{_ as fe}from"./AgentPageShell.vue.OnHAWrZH.js";import{bY as B,m as I,o as n,c as i,a as e,b as w,u as o,A as _,F as O,C as V,t as g,p as C,s as xe,n as $,d as L,w as H,L as P,y as ge,z as ye,f as Q,B as be,b3 as he,v as we,x as _e,k as R,H as ke}from"./entry.CVvpXMAV.js";import{u as $e}from"./usePermissions.LMwBn15y.js";import{u as Ce}from"./useAgentEditorStore.DYCdO3fc.js";import{C as N}from"./chevron-down.DWuYxfsG.js";import{L as q}from"./loader-2.CJ85gz1d.js";import{_ as Le,a as Se,b as Te,c as Pe,d as Ae,M as De,T as Me}from"./SheetClose.vue.CXXlFDGM.js";import{i as Oe}from"./index.DopZtmKD.js";import{C as X}from"./check.nYYGxIUw.js";import"./useAuth.Bu6P1IiJ.js";import"./AuthModal.vue.B2CHdnIo.js";import"./eye.CUTpVi36.js";import"./alert-circle.DxAvbiuF.js";import"./useAgents.BVvSzsfX.js";import"./index.Dnmbk6A8.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=B("BracesIcon",[["path",{d:"M8 3H7a2 2 0 0 0-2 2v5a2 2 0 0 1-2 2 2 2 0 0 1 2 2v5c0 1.1.9 2 2 2h1",key:"ezmyqa"}],["path",{d:"M16 21h1a2 2 0 0 0 2-2v-5c0-1.1.9-2 2-2a2 2 0 0 1-2-2V5a2 2 0 0 0-2-2h-1",key:"e1hn23"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=B("Code2Icon",[["path",{d:"m18 16 4-4-4-4",key:"1inbqp"}],["path",{d:"m6 8-4 4 4 4",key:"15zrgr"}],["path",{d:"m14.5 4-5 16",key:"e7oirm"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=B("HashIcon",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=B("LayoutTemplateIcon",[["rect",{width:"18",height:"7",x:"3",y:"3",rx:"1",key:"f1a2em"}],["rect",{width:"9",height:"7",x:"3",y:"14",rx:"1",key:"jqznyg"}],["rect",{width:"5",height:"7",x:"16",y:"14",rx:"1",key:"q5h2i8"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=B("Minimize2Icon",[["polyline",{points:"4 14 10 14 10 20",key:"11kfnr"}],["polyline",{points:"20 10 14 10 14 4",key:"rlmsce"}],["line",{x1:"14",x2:"21",y1:"10",y2:"3",key:"o5lafz"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=B("PanelRightCloseIcon",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["line",{x1:"15",x2:"15",y1:"3",y2:"21",key:"1hpv9i"}],["path",{d:"m8 9 3 3-3 3",key:"12hl5m"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=B("PanelRightOpenIcon",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["line",{x1:"15",x2:"15",y1:"3",y2:"21",key:"1hpv9i"}],["path",{d:"m10 15-3-3 3-3",key:"1pgupc"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=B("RotateCcwIcon",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),ee={create:"Создание агента",update:"Обновление",publish:"Публикация",manual:"Ручное изменение"},He={class:"flex flex-col min-h-0"},Fe={class:"overflow-hidden"},Ne={class:"p-4 pt-0 space-y-3"},Ie={key:0,class:"flex justify-center py-4"},Ue={key:1,class:"text-[11px] text-muted-foreground text-center py-2"},Ye=["onClick"],Ge={class:"flex justify-between items-start mb-0.5"},We={class:"text-xs font-medium text-foreground"},Je={class:"text-[10px] text-muted-foreground font-mono"},Ke={class:"flex items-center gap-1.5 mb-1"},Qe={key:0,class:"text-[9px] font-bold text-primary uppercase"},Xe={key:0,class:"text-[11px] text-muted-foreground line-clamp-2 mb-1"},Ze={class:"text-[10px] text-muted-foreground/60"},et={class:"flex items-center gap-3 mt-1"},tt=["onClick","disabled"],st=["disabled"],ot=I({__name:"SystemPromptHistorySection",props:{isOpen:{type:Boolean},versions:{},isLoading:{type:Boolean},isLoadingMore:{type:Boolean},isActivating:{type:Boolean},hasMore:{type:Boolean}},emits:["toggle","preview","activate","load-more"],setup(a,{emit:f}){const p=f,b=()=>{p("toggle")},y=d=>ee[d]??d,T=d=>{const v=new Date(d);if(Number.isNaN(v.getTime()))return d;const c=new Date,x=v.toDateString()===c.toDateString(),l=new Date(c);l.setDate(l.getDate()-1);const u=v.toDateString()===l.toDateString(),m=v.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"});return x?`Сегодня, ${m}`:u?`Вчера, ${m}`:v.toLocaleDateString("ru-RU",{day:"numeric",month:"short"})+`, ${m}`};return(d,v)=>(n(),i("div",He,[e("button",{onClick:b,class:"w-full flex items-center justify-between p-4 hover:bg-muted/10 transition-colors shrink-0"},[v[1]||(v[1]=e("h3",{class:"text-xs font-semibold text-muted-foreground uppercase tracking-wider"},"История версий",-1)),w(o(N),{class:_(["w-4 h-4 text-muted-foreground transition-transform duration-200",{"rotate-180":a.isOpen}])},null,8,["class"])]),e("div",{class:_(["grid transition-all duration-300 ease-in-out",a.isOpen?"grid-rows-[1fr] opacity-100":"grid-rows-[0fr] opacity-0"])},[e("div",Fe,[e("div",Ne,[a.isLoading?(n(),i("div",Ie,[w(o(q),{class:"w-4 h-4 animate-spin text-muted-foreground"})])):a.versions.length?(n(),i(O,{key:2},[(n(!0),i(O,null,V(a.versions,c=>(n(),i("div",{key:c.id,class:_(["relative pl-4 pb-3 last:pb-0 cursor-pointer group",c.is_active?"border-l-2 border-primary":"border-l-2 border-muted"]),onClick:x=>d.$emit("preview",c)},[e("div",{class:_(["absolute -left-[5px] top-0.5 w-2 h-2 rounded-full",c.is_active?"bg-primary border-2 border-primary":"bg-background border-2 border-muted-foreground/50"])},null,2),e("div",Ge,[e("span",We,g(T(c.created_at)),1),e("span",Je,"v."+g(c.version_number),1)]),e("div",Ke,[e("span",{class:_(["text-[9px] font-semibold uppercase tracking-wider px-1 py-0.5 rounded",{"bg-emerald-100 text-emerald-700":c.triggered_by==="publish","bg-blue-100 text-blue-700":c.triggered_by==="update","bg-violet-100 text-violet-700":c.triggered_by==="manual","bg-slate-100 text-slate-600":c.triggered_by==="create"}])},g(y(c.triggered_by)),3),c.is_active?(n(),i("span",Qe,"Активна")):C("",!0)]),c.change_summary?(n(),i("p",Xe,g(c.change_summary),1)):C("",!0),e("p",Ze,g(c.prompt_length)+" симв.",1),e("div",et,[c.is_active?C("",!0):(n(),i("button",{key:0,onClick:xe(x=>d.$emit("activate",c),["stop"]),disabled:a.isActivating,class:"text-[10px] font-medium text-primary hover:underline disabled:opacity-50"}," Восстановить ",8,tt)),v[2]||(v[2]=e("span",{class:"text-[10px] font-medium text-primary opacity-0 group-hover:opacity-100 transition-opacity"}," Просмотр → ",-1))])],10,Ye))),128)),a.hasMore?(n(),i("button",{key:0,onClick:v[0]||(v[0]=c=>d.$emit("load-more")),disabled:a.isLoadingMore,class:"w-full text-center text-[10px] font-medium text-primary hover:underline disabled:opacity-50 py-2"},[a.isLoadingMore?(n(),$(o(q),{key:0,class:"w-3 h-3 animate-spin inline mr-1"})):C("",!0),v[3]||(v[3]=L(" Загрузить ещё ",-1))],8,st)):C("",!0)],64)):(n(),i("p",Ue," История промпта пока пуста "))])])],2)]))}}),nt=(a,f)=>{const p=a.split(`
`),b=f.split(`
`),y=p.length,T=b.length,d=Array.from({length:y+1},()=>Array(T+1).fill(0));for(let h=1;h<=y;h++)for(let k=1;k<=T;k++)d[h][k]=p[h-1]===b[k-1]?d[h-1][k-1]+1:Math.max(d[h-1][k],d[h][k-1]);const v=[],c=[];let x=y,l=T;const u=[],m=[];for(;x>0||l>0;)x>0&&l>0&&p[x-1]===b[l-1]?(u.push({type:"equal",text:p[x-1]}),m.push({type:"equal",text:b[l-1]}),x--,l--):l>0&&(x===0||d[x][l-1]>=d[x-1][l])?(m.push({type:"added",text:b[l-1]}),l--):x>0&&(u.push({type:"removed",text:p[x-1]}),x--);return v.push(...u.reverse()),c.push(...m.reverse()),{left:v,right:c}},rt={class:"flex items-center justify-between"},it={key:0,class:"text-sm text-slate-500 mt-1"},at={key:0,class:"ml-1 text-indigo-600 font-bold"},lt={class:"flex-1 overflow-y-auto p-6 space-y-4"},dt={key:0,class:"flex justify-center py-12"},ct={key:0,class:"space-y-1"},ut={class:"text-sm text-slate-500 italic"},mt={key:1,class:"space-y-1"},pt={class:"rounded-md border border-slate-200 bg-slate-50"},vt={class:"text-xs text-slate-900 whitespace-pre-wrap font-mono leading-relaxed p-4"},ft={key:2,class:"grid grid-cols-2 gap-4"},xt={class:"space-y-2"},gt={class:"flex items-center gap-2"},yt={class:"text-sm font-medium text-slate-700"},bt={class:"text-[10px] font-medium text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded"},ht={class:"rounded-md border border-slate-200 bg-slate-50 overflow-auto"},wt={class:"p-4 font-mono text-xs leading-relaxed"},_t={class:"space-y-2"},kt={class:"rounded-md border border-slate-200 bg-slate-50 overflow-auto"},$t={class:"p-4 font-mono text-xs leading-relaxed"},Ct={class:"flex-shrink-0 border-t border-slate-200 bg-white px-6 py-3"},Lt={class:"flex items-center justify-end gap-2"},St=["disabled"],Tt=I({__name:"SystemPromptVersionPreview",props:{open:{type:Boolean},version:{},activePrompt:{},isLoading:{type:Boolean},isActivating:{type:Boolean},canActivate:{type:Boolean}},emits:["update:open","activate"],setup(a,{emit:f}){const p=a,b=f,y=P({get:()=>p.open,set:l=>b("update:open",l)}),T=P(()=>!p.version||p.version.is_active?null:nt(p.version.system_prompt,p.activePrompt)),d=P(()=>{var l;return((l=T.value)==null?void 0:l.left)??[]}),v=P(()=>{var l;return((l=T.value)==null?void 0:l.right)??[]}),c=l=>ee[l]??l,x=l=>{const u=new Date(l);if(Number.isNaN(u.getTime()))return l;const m=new Date,h=u.toDateString()===m.toDateString(),k=new Date(m);k.setDate(k.getDate()-1);const z=u.toDateString()===k.toDateString(),D=u.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"});return h?`Сегодня, ${D}`:z?`Вчера, ${D}`:u.toLocaleDateString("ru-RU",{day:"numeric",month:"short"})+`, ${D}`};return(l,u)=>(n(),$(o(Le),{open:y.value,"onUpdate:open":u[2]||(u[2]=m=>y.value=m)},{default:H(()=>[w(o(Se),{side:"right","class-name":"!max-w-[100vw] w-full flex flex-col"},{default:H(()=>[w(o(Te),null,{default:H(()=>[e("div",rt,[w(o(Pe),null,{default:H(()=>{var m;return[L(" Сравнение: версия #"+g((m=a.version)==null?void 0:m.version_number)+" и активная ",1)]}),_:1}),w(o(Ae))]),a.version?(n(),i("p",it,[L(g(x(a.version.created_at))+" · "+g(c(a.version.triggered_by))+" ",1),a.version.is_active?(n(),i("span",at,"(активна)")):C("",!0)])):C("",!0)]),_:1}),e("div",lt,[a.isLoading?(n(),i("div",dt,[w(o(q),{class:"w-5 h-5 animate-spin text-slate-400"})])):a.version?(n(),i(O,{key:1},[a.version.change_summary?(n(),i("div",ct,[u[3]||(u[3]=e("label",{class:"text-sm font-medium text-slate-700"},"Описание изменений",-1)),e("p",ut," « "+g(a.version.change_summary)+" » ",1)])):C("",!0),a.version.is_active?(n(),i("div",mt,[u[4]||(u[4]=e("label",{class:"text-sm font-medium text-slate-700"},"Системный промпт (активная версия)",-1)),e("div",pt,[e("pre",vt,g(a.version.system_prompt),1)])])):(n(),i("div",ft,[e("div",xt,[e("div",gt,[e("span",yt,"Версия #"+g(a.version.version_number),1),e("span",bt,g(x(a.version.created_at)),1)]),e("div",ht,[e("div",wt,[(n(!0),i(O,null,V(d.value,(m,h)=>(n(),i("div",{key:"l"+h,class:_(["whitespace-pre-wrap",{"bg-red-100 text-red-800":m.type==="removed","text-slate-900":m.type==="equal"}])},g(m.text),3))),128))])])]),e("div",_t,[u[5]||(u[5]=e("div",{class:"flex items-center gap-2"},[e("span",{class:"text-sm font-medium text-slate-700"},"Активная версия"),e("span",{class:"text-[10px] font-bold text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded"},"Текущая")],-1)),e("div",kt,[e("div",$t,[(n(!0),i(O,null,V(v.value,(m,h)=>(n(),i("div",{key:"r"+h,class:_(["whitespace-pre-wrap",{"bg-green-100 text-green-800":m.type==="added","text-slate-900":m.type==="equal"}])},g(m.text),3))),128))])])])]))],64)):C("",!0)]),e("div",Ct,[e("div",Lt,[e("button",{onClick:u[0]||(u[0]=m=>y.value=!1),class:"px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-md transition-colors"}," Закрыть "),a.version&&!a.version.is_active&&a.canActivate?(n(),i("button",{key:0,onClick:u[1]||(u[1]=m=>l.$emit("activate")),disabled:a.isActivating,class:"px-5 py-2 bg-indigo-600 text-white rounded-md text-sm font-bold hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-1.5"},[a.isActivating?(n(),$(o(q),{key:0,class:"w-3.5 h-3.5 animate-spin"})):(n(),$(o(Z),{key:1,class:"w-3.5 h-3.5"})),u[6]||(u[6]=L(" Восстановить эту версию ",-1))],8,St)):C("",!0)])])]),_:1})]),_:1},8,["open"]))}}),Pt={class:"flex-1 flex flex-col bg-background rounded-md border border-border overflow-hidden min-w-0 min-h-0"},At={class:"flex items-center justify-between px-4 py-3 border-b border-border bg-background"},Dt={class:"flex items-center gap-2"},Mt={type:"button",disabled:"",class:"inline-flex items-center justify-center gap-2 px-3 py-1.5 bg-primary/10 text-primary rounded-md text-xs font-medium opacity-50 cursor-not-allowed"},Ot={type:"button",disabled:"",class:"inline-flex items-center justify-center gap-2 px-3 py-1.5 bg-background border border-border text-muted-foreground rounded-md text-xs font-medium opacity-50 cursor-not-allowed"},jt={class:"flex items-center gap-1"},Bt=["title"],Rt=["title"],Vt={class:"px-6 py-2 bg-muted/50 border-b border-border flex justify-between items-center"},qt={class:"flex items-center gap-3"},zt={key:0,class:"flex items-center gap-1.5 text-[10px] text-blue-600"},Et={key:1,class:"flex items-center gap-1.5 text-[10px] text-amber-600"},Ht={key:2,class:"flex items-center gap-1.5 text-[10px] text-green-600"},Ft={class:"text-[10px] text-muted-foreground font-mono"},Nt={class:"border-b border-border"},It={class:"flex items-center gap-1.5 text-[10px] font-semibold text-muted-foreground uppercase tracking-wider"},Ut={class:"px-4 py-3 bg-muted/10 space-y-2.5"},Yt={class:"flex flex-wrap gap-1"},Gt=["onClick"],Wt={key:0,class:"absolute top-full left-1/2 -translate-x-1/2 mt-1.5 px-2.5 py-1 bg-white border border-slate-200 text-slate-600 text-[10px] rounded-md shadow-md whitespace-nowrap opacity-0 invisible group-hover/tag:opacity-100 group-hover/tag:visible transition-all duration-150 pointer-events-none z-50"},Jt={class:"flex-1 relative bg-background"},Kt=["disabled"],Qt={key:0,class:"flex items-center justify-between px-4 py-2 border-t border-border bg-background"},Xt={class:"text-xs text-muted-foreground"},Zt={class:"flex items-center gap-2"},es=["disabled"],ts={class:"min-w-0 overflow-hidden"},ss={class:"w-80 bg-card rounded-md border border-border text-card-foreground flex flex-col overflow-hidden max-w-full h-full"},os={class:"flex-1 overflow-y-auto flex flex-col"},ns={class:"border-b border-border"},rs={class:"overflow-hidden"},is={class:"p-4 pt-0 bg-muted/30"},as={class:"space-y-1"},ls=["onClick"],ds={class:"text-xs text-primary font-medium bg-primary/10 px-1.5 py-0.5 rounded"},cs={class:"text-[10px] text-muted-foreground"},us={key:0,class:"border-b border-border"},ms={class:"overflow-hidden"},ps={class:"p-4 pt-0 bg-muted/30"},vs={class:"space-y-1"},fs=["onClick"],xs={class:"text-xs text-emerald-600 font-medium bg-emerald-500/10 px-1.5 py-0.5 rounded"},gs=I({__name:"AgentPromptPanel",setup(a){const f=Ce(),{form:p,agent:b,isPromptFullscreen:y,promptSidebarTools:T,promptHistory:d}=ge(f),{canEditAgents:v}=$e(),{success:c,error:x}=ye(),l=P(()=>b.value?p.value.system_prompt!==b.value.system_prompt:!1),u=()=>{f.isPromptFocused=!0},m=async()=>{f.isPromptFocused=!1,l.value&&v.value&&await f.autoSavePrompt()},h=R(!0),k=R(!0);let z=null;Q(h,s=>{z&&clearTimeout(z),s?z=setTimeout(()=>{k.value=!0},320):k.value=!1});const D=R(typeof window<"u"&&window.innerWidth<1024),A=R(["history"]),F=R(!1),j=R(null),U=R(!1),te=P(()=>{var s;return((s=d.value)==null?void 0:s.versions)??[]}),se=P(()=>{var s;return((s=d.value)==null?void 0:s.isLoading)??!1}),oe=P(()=>{var s;return((s=d.value)==null?void 0:s.isLoadingMore)??!1}),J=P(()=>{var s;return((s=d.value)==null?void 0:s.isActivating)??!1}),ne=P(()=>{var t;const s=(t=d.value)==null?void 0:t.nextCursor;return s!=null}),re=[{id:"markdown",label:"Markdown",color:"blue",tags:[{label:"# Заголовок",value:"# ",hint:"Заголовок первого уровня"},{label:"## Подзаголовок",value:"## ",hint:"Заголовок второго уровня"}]},{id:"structure",label:"Структура",color:"violet",tags:[{label:"goal",value:`<goal>

</goal>`,cursorOffset:7,hint:"Цель и задача агента"},{label:"role",value:`<role>

</role>`,cursorOffset:7,hint:"Роль и персона агента"},{label:"context",value:`<context>

</context>`,cursorOffset:10,hint:"Контекст и знания"},{label:"instructions",value:`<instructions>

</instructions>`,cursorOffset:15,hint:"Инструкции поведения"},{label:"examples",value:`<examples>

</examples>`,cursorOffset:11,hint:"Примеры диалогов"},{label:"format",value:`<output_format>

</output_format>`,cursorOffset:16,hint:"Формат ответов"}]},{id:"behavior",label:"Поведение",color:"emerald",tags:[{label:"style",value:`<style>

</style>`,cursorOffset:8,hint:"Стиль общения"},{label:"constraints",value:`<constraints>

</constraints>`,cursorOffset:14,hint:"Ограничения и запреты"},{label:"flow",value:`<flow>

</flow>`,cursorOffset:7,hint:"Сценарий диалога"},{label:"fallback",value:`<fallback>

</fallback>`,cursorOffset:11,hint:"Действия при ошибках"},{label:"tools",value:`<tools>

</tools>`,cursorOffset:8,hint:"Описание инструментов"}]},{id:"custom",label:"Свой",color:"neutral",tags:[{label:"Свой тег",value:`<>

</>`,cursorOffset:1,hint:"Пустой тег — впишите своё название"}]}],ie=[{name:"{client_name}",description:"Имя клиента"},{name:"{clinic_phone}",description:"Телефон клиники"},{name:"{service_list}",description:"Список услуг"},{name:"{current_date}",description:"Текущая дата"}],ae=P(()=>{const s=p.value.system_prompt||"";if(!s)return 0;const t=(s.match(/[\u0400-\u04FF]/g)||[]).length,S=s.length-t;return Math.ceil(t/1.5+S/4)}),Y=(s,t)=>{const S=document.querySelector('textarea[placeholder="Ты — дружелюбный и профессиональный ассистент клиники..."]');if(S){const E=S.selectionStart,r=S.selectionEnd,M=S.scrollTop,W=p.value.system_prompt;p.value.system_prompt=W.substring(0,E)+s+W.substring(r),ke(()=>{S.focus({preventScroll:!0}),S.scrollTop=M;const K=E+(t!==void 0?t:s.length);S.setSelectionRange(K,K)})}else p.value.system_prompt+=(p.value.system_prompt?`
`:"")+s},le=(s,t)=>{Y(`${s}()`),c("Инструмент добавлен",`Инструмент ${s}() вставлен`)},de=s=>{Y(s.value,s.cursorOffset),c("Тег добавлен",`${s.label} вставлен`)},G=async s=>{const t=A.value.indexOf(s);t===-1?A.value.push(s):A.value.splice(t,1),s==="functions"&&(await f.ensureToolsLoaded(),await f.ensureSqnsStatusLoaded())},ce=async()=>{await G("history"),A.value.includes("history")&&await f.ensurePromptHistoryLoaded()},ue=()=>{var s;(s=d.value)==null||s.fetchMore()},me=async s=>{if(d.value){F.value=!0,U.value=!0,j.value=null;try{const t=await d.value.fetchVersionDetail(s.id);j.value=t}catch(t){x("Версия не найдена",t.message||""),F.value=!1}finally{U.value=!1}}},pe=async s=>{if(d.value&&confirm(`Текущий промпт будет заменён на версию #${s.version_number}. Продолжить?`))try{const t=await d.value.activateVersion(s.id);t&&(p.value.system_prompt=t.system_prompt,b.value&&(b.value.system_prompt=t.system_prompt),c("Версия восстановлена",`Активирована версия #${t.version_number}`))}catch(t){x("Не удалось активировать",t.message||"")}},ve=async()=>{if(!(!d.value||!j.value)&&confirm(`Текущий промпт будет заменён на версию #${j.value.version_number}. Продолжить?`))try{const s=await d.value.activateVersion(j.value.id);s&&(p.value.system_prompt=s.system_prompt,b.value&&(b.value.system_prompt=s.system_prompt),j.value={...j.value,is_active:!0},c("Версия восстановлена",`Активирована версия #${s.version_number}`))}catch(s){x("Не удалось активировать",s.message||"")}};if(typeof window<"u"){const s=t=>{t.key==="Escape"&&y.value&&(y.value=!1)};be(()=>window.addEventListener("keydown",s)),he(()=>{window.removeEventListener("keydown",s),y.value=!1})}return Q(b,s=>{s&&(f.ensureToolsLoaded(),f.ensureSqnsStatusLoaded(),A.value.includes("history")&&f.ensurePromptHistoryLoaded())},{immediate:!0}),(s,t)=>{var S,E;return n(),i("div",{class:_(["flex flex-col lg:flex-row gap-4 transition-all duration-300",o(y)?"fixed inset-0 z-[100] bg-slate-50 p-4 lg:p-6":"h-[calc(100vh-280px)] min-h-[600px]"])},[e("div",Pt,[e("div",At,[e("div",Dt,[e("button",Mt,[w(o(Oe),{class:"h-3.5 w-3.5"}),t[10]||(t[10]=L(" Улучшить с AI ",-1))]),e("button",Ot,[w(o(Ve),{class:"h-3.5 w-3.5"}),t[11]||(t[11]=L(" Шаблоны ",-1))])]),e("div",jt,[e("button",{type:"button",onClick:t[0]||(t[0]=r=>o(f).resetPrompt()),class:"inline-flex items-center justify-center gap-2 px-3 py-1.5 text-muted-foreground hover:text-foreground hover:bg-accent rounded-md text-xs font-medium transition-colors",title:"Сбросить"},[w(o(Z),{class:"h-3.5 w-3.5"}),t[12]||(t[12]=e("span",{class:"hidden sm:inline"},"Сбросить",-1))]),e("button",{type:"button",onClick:t[1]||(t[1]=r=>D.value=!D.value),class:"inline-flex items-center justify-center p-1.5 text-muted-foreground hover:text-foreground hover:bg-accent rounded-md transition-colors",title:D.value?"Показать панель":"Скрыть панель"},[D.value?(n(),$(o(Ee),{key:0,class:"h-3.5 w-3.5"})):(n(),$(o(ze),{key:1,class:"h-3.5 w-3.5"}))],8,Bt),e("button",{type:"button",onClick:t[2]||(t[2]=r=>y.value=!o(y)),class:"inline-flex items-center justify-center p-1.5 text-muted-foreground hover:text-foreground hover:bg-accent rounded-md transition-colors",title:o(y)?"Свернуть":"Развернуть"},[o(y)?(n(),$(o(qe),{key:0,class:"h-3.5 w-3.5"})):(n(),$(o(De),{key:1,class:"h-3.5 w-3.5"}))],8,Rt)])]),e("div",Vt,[t[16]||(t[16]=e("span",{class:"text-[10px] font-bold text-muted-foreground uppercase tracking-widest"},"Редактор подсказок",-1)),e("div",qt,[o(f).isAutoSaving?(n(),i("span",zt,[w(o(q),{class:"h-3 w-3 animate-spin"}),t[13]||(t[13]=L(" Сохранение... ",-1))])):l.value?(n(),i("span",Et,[...t[14]||(t[14]=[e("div",{class:"h-1.5 w-1.5 bg-amber-400 rounded-full animate-pulse"},null,-1),L(" Несохранено ",-1)])])):o(f).lastAutoSavedAt?(n(),i("span",Ht,[w(o(X),{class:"h-3 w-3"}),t[15]||(t[15]=L(" Сохранено ",-1))])):C("",!0),e("span",Ft,"~"+g(ae.value)+" токенов",1)])]),e("div",Nt,[e("button",{onClick:t[3]||(t[3]=r=>h.value=!h.value),class:"w-full flex items-center justify-between px-4 py-2 bg-muted/20 hover:bg-muted/30 transition-colors"},[e("span",It,[w(o(Me),{class:"w-3 h-3"}),t[17]||(t[17]=L(" Быстрые теги ",-1))]),w(o(N),{class:_(["w-3.5 h-3.5 text-muted-foreground transition-transform duration-200",{"rotate-180":h.value}])},null,8,["class"])]),e("div",{class:_(["grid transition-all duration-300 ease-in-out",h.value?"grid-rows-[1fr] opacity-100":"grid-rows-[0fr] opacity-0"])},[e("div",{class:_(k.value?"overflow-visible":"overflow-hidden")},[e("div",Ut,[(n(),i(O,null,V(re,r=>e("div",{key:r.id,class:"flex items-start gap-2"},[e("span",{class:_(["shrink-0 mt-0.5 text-[9px] font-semibold uppercase tracking-wider w-[70px] text-right",{"text-blue-500":r.color==="blue","text-violet-500":r.color==="violet","text-emerald-500":r.color==="emerald","text-muted-foreground":r.color==="neutral"}])},g(r.label),3),e("div",Yt,[(n(!0),i(O,null,V(r.tags,M=>(n(),i("div",{key:M.label,class:"relative group/tag"},[e("button",{onClick:W=>de(M),class:_(["inline-flex items-center gap-1 px-2 py-0.5 rounded border text-[10px] font-medium transition-colors",{"border-blue-200 bg-blue-50 text-blue-700 hover:bg-blue-100 dark:border-blue-800 dark:bg-blue-950 dark:text-blue-300 dark:hover:bg-blue-900":r.color==="blue","border-violet-200 bg-violet-50 text-violet-700 hover:bg-violet-100 dark:border-violet-800 dark:bg-violet-950 dark:text-violet-300 dark:hover:bg-violet-900":r.color==="violet","border-emerald-200 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 dark:border-emerald-800 dark:bg-emerald-950 dark:text-emerald-300 dark:hover:bg-emerald-900":r.color==="emerald","border-border bg-background text-muted-foreground hover:bg-accent hover:text-accent-foreground":r.color==="neutral"}])},[r.color==="blue"?(n(),$(o(Re),{key:0,class:"w-2.5 h-2.5"})):r.color==="violet"||r.color==="emerald"?(n(),$(o(Be),{key:1,class:"w-2.5 h-2.5"})):(n(),$(o(je),{key:2,class:"w-2.5 h-2.5"})),L(" "+g(M.label),1)],10,Gt),M.hint?(n(),i("div",Wt,[L(g(M.hint)+" ",1),t[18]||(t[18]=e("div",{class:"absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-white drop-shadow-sm"},null,-1))])):C("",!0)]))),128))])])),64))])],2)],2)]),e("div",Jt,[we(e("textarea",{"onUpdate:modelValue":t[4]||(t[4]=r=>o(p).system_prompt=r),disabled:!o(v),onFocus:u,onBlur:m,class:"w-full h-full p-6 text-sm text-foreground leading-relaxed resize-none focus:outline-none focus:ring-0 border-0 bg-transparent font-mono placeholder:text-muted-foreground",placeholder:"Ты — дружелюбный и профессиональный ассистент клиники...",spellcheck:"false"},null,40,Kt),[[_e,o(p).system_prompt]])]),o(y)&&o(v)?(n(),i("div",Qt,[e("span",Xt,g((S=o(b))==null?void 0:S.name),1),e("div",Zt,[e("button",{onClick:t[5]||(t[5]=r=>y.value=!1),class:"px-4 py-1.5 text-xs text-muted-foreground hover:text-foreground transition-colors"}," Свернуть "),e("button",{onClick:t[6]||(t[6]=r=>o(f).saveAgent()),disabled:o(f).isSaving,class:"px-5 py-1.5 bg-indigo-600 text-white rounded-md text-xs font-medium hover:bg-indigo-700 disabled:opacity-50 transition-colors flex items-center gap-1.5"},[o(f).isSaving?(n(),$(o(q),{key:0,class:"h-3 w-3 animate-spin"})):(n(),$(o(X),{key:1,class:"h-3 w-3"})),t[19]||(t[19]=L(" Сохранить ",-1))],8,es)])])):C("",!0)]),e("div",{class:_(["grid transition-all duration-300 ease-out shrink-0 overflow-hidden",D.value?"grid-cols-[0fr] opacity-0":"grid-cols-[1fr] opacity-100"])},[e("div",ts,[e("div",ss,[e("div",os,[e("div",ns,[e("button",{onClick:t[7]||(t[7]=r=>G("variables")),class:"w-full flex items-center justify-between p-4 bg-muted/30 hover:bg-muted/50 transition-colors"},[t[20]||(t[20]=e("h3",{class:"text-xs font-semibold text-muted-foreground uppercase tracking-wider"},"Переменные",-1)),w(o(N),{class:_(["w-4 h-4 text-muted-foreground transition-transform duration-200",{"rotate-180":A.value.includes("variables")}])},null,8,["class"])]),e("div",{class:_(["grid transition-all duration-300 ease-in-out",A.value.includes("variables")?"grid-rows-[1fr] opacity-100":"grid-rows-[0fr] opacity-0"])},[e("div",rs,[e("div",is,[e("div",as,[(n(),i(O,null,V(ie,r=>e("button",{key:r.name,onClick:M=>Y(r.name),class:"w-full flex items-center justify-between px-2 py-1.5 rounded hover:bg-background group transition-colors text-left"},[e("code",ds,g(r.name),1),e("span",cs,g(r.description),1)],8,ls)),64))])])])],2)]),o(T).length?(n(),i("div",us,[e("button",{onClick:t[8]||(t[8]=r=>G("functions")),class:"w-full flex items-center justify-between p-4 bg-muted/30 hover:bg-muted/50 transition-colors"},[t[21]||(t[21]=e("h3",{class:"text-xs font-semibold text-muted-foreground uppercase tracking-wider"},"Функции",-1)),w(o(N),{class:_(["w-4 h-4 text-muted-foreground transition-transform duration-200",{"rotate-180":A.value.includes("functions")}])},null,8,["class"])]),e("div",{class:_(["grid transition-all duration-300 ease-in-out",A.value.includes("functions")?"grid-rows-[1fr] opacity-100":"grid-rows-[0fr] opacity-0"])},[e("div",ms,[e("div",ps,[e("div",vs,[(n(!0),i(O,null,V(o(T),r=>(n(),i("button",{key:r.name,onClick:M=>le(r.name,r.description),class:"w-full flex items-center justify-between px-2 py-1.5 rounded hover:bg-background group transition-colors text-left"},[e("code",xs,g(r.name)+"()",1),t[22]||(t[22]=e("span",{class:"text-[10px] text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity"},"+ вставить",-1))],8,fs))),128))])])])],2)])):C("",!0),w(o(ot),{"is-open":A.value.includes("history"),versions:te.value,"is-loading":se.value,"is-loading-more":oe.value,"is-activating":J.value,"has-more":ne.value,onToggle:ce,onPreview:me,onActivate:pe,onLoadMore:ue},null,8,["is-open","versions","is-loading","is-loading-more","is-activating","has-more"]),w(o(Tt),{open:F.value,"onUpdate:open":t[9]||(t[9]=r=>F.value=r),version:j.value,"active-prompt":((E=o(b))==null?void 0:E.system_prompt)??"","is-loading":U.value,"is-activating":J.value,"can-activate":o(v),onActivate:ve},null,8,["open","version","active-prompt","is-loading","is-activating","can-activate"])])])])],2)],2)}}}),Os=I({__name:"prompt",setup(a){return(f,p)=>(n(),$(fe,{title:"Системный промпт","hide-actions":!0},{default:H(()=>[w(gs)]),_:1}))}});export{Os as default};
