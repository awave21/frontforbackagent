import{a9 as x,aa as A,G as O,D as $,P as c,r as d}from"./entry.d9x2jNom.js";const b=a=>{try{const t=a.split(".");if(t.length!==3)return!0;const o=t[1].replace(/-/g,"+").replace(/_/g,"/"),l=atob(o),i=JSON.parse(l);if(!i.exp)return!0;const g=i.exp*1e3;return Date.now()>=g-3e4}catch{return!0}};let p=null;const j=()=>{var t;const{public:{apiBase:a}}=x();if(!p)try{p=((t=A().$router)==null?void 0:t.push)||(()=>window.location.href="/")}catch{p=()=>window.location.href="/"}return $fetch.create({baseURL:a,onRequest({options:s}){{const o=localStorage.getItem("auth_token");if(o){if(b(o)){localStorage.removeItem("auth_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant");return}const l=s.headers||{};s.headers={...l,Authorization:`Bearer ${o}`}}}},onResponseError({response:s}){var o;if(s.status===401&&(console.warn("Authentication token expired or invalid, redirecting to login"),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),p?p("/",{replace:!0}):window.location.href="/"),s.status===429){const l=((o=s.headers)==null?void 0:o.get("retry-after"))||"60";console.warn(`Rate limit exceeded. Retry after ${l} seconds`)}}})},f=a=>a.data&&typeof a.data=="object"?{error:a.data.error||"unknown_error",message:a.data.message||a.message||"Произошла ошибка",details:a.data.details,retry_after:a.data.retry_after}:{error:"unknown_error",message:a.message||"Произошла ошибка"},_=a=>{try{const t=a.split(".");if(t.length!==3)return null;const o=t[1].replace(/-/g,"+").replace(/_/g,"/"),l=atob(o);return JSON.parse(l)}catch(t){return console.error("Failed to decode JWT token:",t),null}},k=a=>{const t=_(a);if(!t||!t.exp)return!0;const s=t.exp*1e3;return Date.now()>=s-3e4},y=a=>!(!a||a.split(".").length!==3||k(a)),J=()=>{const a=j(),t=d(null),s=d(null),o=d(null),l=d(!1),i=d(null),g=async n=>{try{l.value=!0,i.value=null;const e=await a("/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:n});t.value=e.token;const r={...e.user,scopes:Array.isArray(e.user.scopes)?e.user.scopes:[]};return s.value=r,o.value=e.tenant,localStorage.setItem("auth_token",e.token),localStorage.setItem("auth_user",JSON.stringify(r)),localStorage.setItem("auth_tenant",JSON.stringify(e.tenant)),e}catch(e){const r=f(e);let u=r.message;if(r.details){const h=Object.entries(r.details).map(([m,v])=>`${m}: ${v.join(", ")}`).join("; ");u=`${u}. ${h}`}throw i.value=u,e.apiError=r,e}finally{l.value=!1}},S=async n=>{try{l.value=!0,i.value=null;const e=await a("/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:n});t.value=e.token;const r={...e.user,scopes:Array.isArray(e.user.scopes)?e.user.scopes:[]};return s.value=r,o.value=e.tenant,localStorage.setItem("auth_token",e.token),localStorage.setItem("auth_user",JSON.stringify(r)),localStorage.setItem("auth_tenant",JSON.stringify(e.tenant)),e}catch(e){const r=f(e);let u=r.message;if(r.details){const h=Object.entries(r.details).map(([m,v])=>`${m}: ${v.join(", ")}`).join("; ");u=`${u}. ${h}`}throw i.value=u,e.apiError=r,e}finally{l.value=!1}},I=async n=>{try{l.value=!0,i.value=null;const e=await a("/auth/token",{method:"POST",headers:{"x-api-key":n,"Content-Type":"application/json"},body:{api_key:n}});return t.value=e.token,localStorage.setItem("auth_token",e.token),e}catch(e){const r=f(e);throw i.value=r.message,e.apiError=r,e}finally{l.value=!1}},T=()=>{t.value=null,s.value=null,o.value=null,localStorage.removeItem("auth_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),window.location.href="/",i.value=null},w=async()=>{const n=localStorage.getItem("auth_token"),e=localStorage.getItem("auth_user"),r=localStorage.getItem("auth_tenant");if(n&&y(n))t.value=n;else if(n){console.warn("Token expired or invalid, clearing auth data"),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),t.value=null,s.value=null,o.value=null;return}if(e)try{const u=JSON.parse(e);Array.isArray(u.scopes)||(u.scopes=[]),s.value=u}catch(u){console.error("Failed to parse saved user data",u)}if(r)try{o.value=JSON.parse(r)}catch(u){console.error("Failed to parse saved tenant data",u)}};return O(()=>{w()}),{token:c(t),user:c(s),tenant:c(o),isLoading:c(l),error:c(i),register:g,login:S,loginWithApiKey:I,logout:T,isAuthenticated:$(()=>t.value?y(t.value)?!0:(localStorage.removeItem("auth_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_tenant"),t.value=null,s.value=null,o.value=null,!1):!1),decodeToken:n=>n?_(n):null,isTokenExpired:n=>n?k(n):!0,isTokenValid:n=>y(n)}};export{j as a,J as u};
