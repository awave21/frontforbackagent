import{b_ as Xe,L as k,k as u,bd as H,c0 as Ze,z as et,f as ce}from"./entry.C3vEAWma.js";import{u as tt}from"./useAgents.lyQ9pZ6U.js";import{u as fe,a as qe}from"./useAuth.aSDdTJTL.js";import{w as ve}from"./index.B9hQrX5B.js";const $e={qa:[{name:"question",label:"–í–æ–ø—Ä–æ—Å",type:"text",required:!0,searchable:!0},{name:"answer",label:"–û—Ç–≤–µ—Ç",type:"text",required:!0,searchable:!1}],service_catalog:[{name:"name",label:"–ù–∞–∑–≤–∞–Ω–∏–µ",type:"text",required:!0,searchable:!0},{name:"description",label:"–û–ø–∏—Å–∞–Ω–∏–µ",type:"text",required:!1,searchable:!0},{name:"price",label:"–¶–µ–Ω–∞",type:"number",required:!1,searchable:!1},{name:"is_active",label:"–ê–∫—Ç–∏–≤–Ω–∞",type:"bool",required:!1,searchable:!1}],product_catalog:[{name:"name",label:"–ù–∞–∑–≤–∞–Ω–∏–µ",type:"text",required:!0,searchable:!0},{name:"description",label:"–û–ø–∏—Å–∞–Ω–∏–µ",type:"text",required:!1,searchable:!0},{name:"price",label:"–¶–µ–Ω–∞",type:"number",required:!1,searchable:!1},{name:"in_stock",label:"–í –Ω–∞–ª–∏—á–∏–∏",type:"bool",required:!1,searchable:!1}],company_info:[{name:"topic",label:"–¢–µ–º–∞",type:"text",required:!0,searchable:!0},{name:"info",label:"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",type:"text",required:!0,searchable:!0}],custom:[{name:"field1",label:"–ü–æ–ª–µ 1",type:"text",required:!0,searchable:!0},{name:"field2",label:"–ü–æ–ª–µ 2",type:"text",required:!1,searchable:!1}]},at=i=>{const v=fe(),{token:h}=qe(),d=u([]),y=u(null),f=u([]),b=u(!1),$=u(!1),C=u(null),j=k(()=>d.value.map(o=>o.tool_name)),O=o=>$e[o]||$e.custom,z=async()=>{var o;b.value=!0,C.value=null;try{console.log(`üìÇ Fetching directories for agent ${i}...`);const n=await v(`/agents/${i}/directories`,{headers:{Authorization:`Bearer ${h.value}`}});d.value=n||[],console.log(`‚úÖ Loaded ${d.value.length} directories`)}catch(n){const l=(n==null?void 0:n.status)||(n==null?void 0:n.statusCode)||((o=n==null?void 0:n.response)==null?void 0:o.status);l===404?(console.warn("‚ö†Ô∏è  Directories API not implemented on backend (404)"),C.value="API —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ",d.value=[]):l===500||l===502||l===503?(console.error("‚ùå Server error loading directories:",l),C.value="–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤",d.value=[]):(C.value=(n==null?void 0:n.message)||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏",console.error("Failed to fetch directories:",n))}finally{b.value=!1}},_=async o=>{var n,l,r;try{const s={...o,columns:o.columns||O(o.template),response_mode:o.response_mode||"function_result",search_type:o.search_type||"fuzzy"};console.log("üìù Creating directory:",s.name),console.log("üì§ Request payload:",JSON.stringify(s,null,2));const m=await v(`/agents/${i}/directories`,{method:"POST",headers:{Authorization:`Bearer ${h.value}`,"Content-Type":"application/json"},body:s});if(!m||!m.id)throw console.error("‚ùå Server returned empty or invalid response"),new Error("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç");return console.log("‚úÖ Directory created:",m.id),d.value.push(m),m}catch(s){const m=(s==null?void 0:s.status)||(s==null?void 0:s.statusCode)||((n=s==null?void 0:s.response)==null?void 0:n.status),w=((l=s==null?void 0:s.data)==null?void 0:l.detail)||((r=s==null?void 0:s.data)==null?void 0:r.message)||(s==null?void 0:s.message);throw console.error("‚ùå Failed to create directory:",{status:m,message:w,err:s}),m===404?new Error("API —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (404)"):m===422?new Error(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ${w||"–Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"}`):m===409?new Error("–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"):m>=500?new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${m}): ${w||"–ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ"}`):new Error(w||"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫")}},p=async(o,n)=>{var l;try{const r=await v(`/agents/${i}/directories/${o}`,{method:"PUT",headers:{Authorization:`Bearer ${h.value}`,"Content-Type":"application/json"},body:n}),s=d.value.findIndex(m=>m.id===o);return s!==-1&&(d.value[s]=r),((l=y.value)==null?void 0:l.id)===o&&(y.value=r),r}catch(r){throw new Error((r==null?void 0:r.message)||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫")}},F=async o=>{var n;try{await v(`/agents/${i}/directories/${o}`,{method:"DELETE",headers:{Authorization:`Bearer ${h.value}`}}),d.value=d.value.filter(l=>l.id!==o),((n=y.value)==null?void 0:n.id)===o&&(y.value=null)}catch(l){throw new Error((l==null?void 0:l.message)||"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫")}},x=async(o,n)=>{try{await v(`/agents/${i}/directories/${o}/toggle`,{method:"PATCH",headers:{Authorization:`Bearer ${h.value}`,"Content-Type":"application/json"},body:{is_enabled:n}});const l=d.value.findIndex(r=>r.id===o);l!==-1&&(d.value[l].is_enabled=n)}catch(l){throw new Error((l==null?void 0:l.message)||"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞")}},a=async(o,n)=>{$.value=!0;try{const l=new URLSearchParams;l.append("limit","100"),n&&l.append("search",n);const r=await v(`/agents/${i}/directories/${o}/items?${l}`,{headers:{Authorization:`Bearer ${h.value}`}});f.value=r.items}catch(l){console.error("Failed to fetch items:",l),f.value=[]}finally{$.value=!1}};return{directories:d,currentDirectory:y,items:f,isLoading:b,isLoadingItems:$,error:C,existingToolNames:j,fetchDirectories:z,createDirectory:_,updateDirectory:p,deleteDirectory:F,toggleDirectory:x,fetchItems:a,createItem:async(o,n)=>{var l;try{const r=await v(`/agents/${i}/directories/${o}/items`,{method:"POST",headers:{Authorization:`Bearer ${h.value}`,"Content-Type":"application/json"},body:{data:n}});f.value.push(r);const s=d.value.findIndex(m=>m.id===o);return s!==-1&&d.value[s].items_count++,((l=y.value)==null?void 0:l.id)===o&&y.value.items_count++,r}catch(r){throw new Error((r==null?void 0:r.message)||"–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å")}},updateItem:async(o,n,l)=>{try{const r=await v(`/agents/${i}/directories/${o}/items/${n}`,{method:"PUT",headers:{Authorization:`Bearer ${h.value}`,"Content-Type":"application/json"},body:{data:l}}),s=f.value.findIndex(m=>m.id===n);return s!==-1&&(f.value[s]=r),r}catch(r){throw new Error((r==null?void 0:r.message)||"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å")}},deleteItem:async(o,n)=>{var l;try{await v(`/agents/${i}/directories/${o}/items/${n}`,{method:"DELETE",headers:{Authorization:`Bearer ${h.value}`}}),f.value=f.value.filter(s=>s.id!==n);const r=d.value.findIndex(s=>s.id===o);r!==-1&&d.value[r].items_count--,((l=y.value)==null?void 0:l.id)===o&&y.value.items_count--}catch(r){throw new Error((r==null?void 0:r.message)||"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å")}},deleteItems:async(o,n)=>{var l;try{await v(`/agents/${i}/directories/${o}/items`,{method:"DELETE",headers:{Authorization:`Bearer ${h.value}`,"Content-Type":"application/json"},body:{ids:n}}),f.value=f.value.filter(s=>!n.includes(s.id));const r=d.value.findIndex(s=>s.id===o);r!==-1&&(d.value[r].items_count-=n.length),((l=y.value)==null?void 0:l.id)===o&&(y.value.items_count-=n.length)}catch(r){throw new Error((r==null?void 0:r.message)||"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏")}},importCsv:async(o,n,l,r)=>{try{const s=new FormData;s.append("file",n),s.append("mapping",JSON.stringify(l)),s.append("has_header",String(r.hasHeader)),s.append("replace_all",String(r.replaceAll));const m=await v(`/agents/${i}/directories/${o}/import`,{method:"POST",headers:{Authorization:`Bearer ${h.value}`},body:s});return await a(o),await z(),m}catch(s){throw new Error((s==null?void 0:s.message)||"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª")}},exportCsv:async o=>{try{const{public:{apiBase:n}}=Xe(),l=typeof window<"u"?localStorage.getItem("auth_token"):null;if(!l)throw new Error("–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");const r=await fetch(`${n}/agents/${i}/directories/${o}/export?format=csv`,{method:"GET",headers:{Authorization:`Bearer ${l}`,Accept:"text/csv"}});if(!r.ok)throw r.status===401?new Error("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞."):new Error(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${r.status}`);const s=await r.blob(),m=URL.createObjectURL(s),w=d.value.find(I=>I.id===o),P=`${(w==null?void 0:w.slug)||(w==null?void 0:w.name)||"export"}.csv`,q=document.createElement("a");q.href=m,q.download=P,document.body.appendChild(q),q.click(),document.body.removeChild(q),URL.revokeObjectURL(m)}catch(n){throw console.error("‚ùå Export CSV error:",n),new Error((n==null?void 0:n.message)||"–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫")}},setCurrentDirectory:o=>{y.value=o,o?a(o.id):f.value=[]},getTemplateColumns:O}},st=i=>{const v=fe(),h=u([]),d=u(null),y=u(!1),f=u(!1),b=u(!1),$=u(null),C=async()=>{const _=i();if(_)try{y.value=!0,$.value=null;const p=await v(`/agents/${_}/system-prompt/history`,{query:{limit:30}});h.value=p.items,d.value=p.next_cursor}catch(p){if((p==null?void 0:p.statusCode)===404||(p==null?void 0:p.status)===404){h.value=[],d.value=null;return}throw $.value=p.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–º–ø—Ç–∞",p}finally{y.value=!1}},j=async()=>{const _=i();if(!(!_||d.value===null))try{f.value=!0;const p=await v(`/agents/${_}/system-prompt/history`,{query:{limit:30,cursor:d.value}});h.value.push(...p.items),d.value=p.next_cursor}catch(p){throw $.value=p.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë",p}finally{f.value=!1}},O=async _=>{const p=i();return p?await v(`/agents/${p}/system-prompt/history/${_}`):null},z=async _=>{const p=i();if(!p)return null;try{b.value=!0;const F=await v(`/agents/${p}/system-prompt/history/${_}/activate`,{method:"POST"});for(const x of h.value)x.is_active=x.id===_;return F}finally{b.value=!1}};return{versions:H(h),nextCursor:H(d),isLoading:H(y),isLoadingMore:H(f),isActivating:H(b),error:H($),fetchHistory:C,fetchMore:j,fetchVersionDetail:O,activateVersion:z}},Ae="agent-chat-sessions",me=typeof window<"u",ot=()=>{if(!me)return{};try{const i=window.localStorage.getItem(Ae);return i?JSON.parse(i):{}}catch(i){return console.error("Failed to parse stored agent sessions:",i),{}}},nt=i=>{if(me)try{window.localStorage.setItem(Ae,JSON.stringify(i))}catch(v){console.error("Failed to persist agent sessions:",v)}},rt=()=>{const i=u(me?ot():{}),v=f=>{i.value=f,nt(f)};return{getSessionId:f=>i.value[f]??null,setSessionId:(f,b)=>{v({...i.value,[f]:b})},clearSessionId:f=>{if(!i.value[f])return;const{[f]:b,...$}=i.value;v($)}}},Ee=()=>({name:"",system_prompt:"",model:"",status:"draft",llm_params:{temperature:.7,max_tokens:1e3}}),de=i=>{var v,h;return{name:i.name,system_prompt:i.system_prompt,model:i.model,status:i.status,llm_params:{temperature:((v=i.llm_params)==null?void 0:v.temperature)??.7,max_tokens:((h=i.llm_params)==null?void 0:h.max_tokens)??1e3}}},vt=Ze("agentEditor",()=>{const{token:i}=qe(),v=fe(),{success:h,error:d}=et(),{getAgent:y,updateAgent:f,deleteAgent:b,fetchSqnsStatus:$,enableSqns:C,disableSqns:j,fetchSqnsResources:O,fetchSqnsServices:z}=tt(),{getSessionId:_,setSessionId:p,clearSessionId:F}=rt(),x=u(null),a=u(null),g=u(Ee()),E=u(!1),N=u(!1),J=u(!1),M=u(!1),U=u(null),se=u(!1),o=u(!1),n=u(null),l=u(!1),r=u([]),s=u([]),m=u(!1),w=u(!1),P=u(null),q=u(!1),I=u(!1),G=u(null),W=u(!1),A=u(null),D=u(!1),T=u(null),X=u([]),Z=u([]),B=u(null),Q=u(!1),R=u(!1),S=u([]),V=u(""),K=u(!1),L=u(null),ee=u(!1),pe="agent-chat-messages",Te=()=>{a.value=null,g.value=Ee(),E.value=!1,N.value=!1,J.value=!1,M.value=!1,U.value=null,se.value=!1,o.value=!1,n.value=null,l.value=!1,r.value=[],s.value=[],m.value=!1,w.value=!1,P.value=null,q.value=!1,I.value=!1,W.value=!1,G.value=null,D.value=!1,A.value=null,T.value=null,X.value=[],Z.value=[],B.value=null,Q.value=!1,R.value=!1,S.value=[],V.value="",K.value=!1,L.value=null,ee.value=!1},he=e=>{x.value!==e&&(x.value=e,Te(),G.value=at(e),A.value=st(()=>e))},Le=async e=>{if(e&&(x.value!==e&&he(e),!(E.value||N.value)))try{N.value=!0,U.value=null;const t=await y(e);a.value=t,g.value=de(t),E.value=!0}catch(t){U.value=t.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≥–µ–Ω—Ç–∞"}finally{N.value=!1}},Ce=async()=>{if(!a.value)return!1;try{J.value=!0;const e=await f(a.value.id,g.value);return a.value=e,g.value=de(e),h("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã","–ê–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω"),D.value&&A.value&&A.value.fetchHistory(),!0}catch(e){return d("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è",e.message||"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"),!1}finally{J.value=!1}},ye=async()=>{if(!a.value||!E.value||g.value.system_prompt===a.value.system_prompt)return!1;try{o.value=!0;const e=await f(a.value.id,{system_prompt:g.value.system_prompt});return a.value=e,n.value=new Date,D.value&&A.value&&A.value.fetchHistory(),!0}catch(e){return console.error("Auto-save failed:",e),!1}finally{o.value=!1}},Y=async e=>{if(!a.value||!E.value)return!1;try{o.value=!0;const t=await f(a.value.id,e);return a.value=t,Object.assign(g.value,e),n.value=new Date,e.system_prompt&&D.value&&A.value&&A.value.fetchHistory(),!0}catch(t){return console.error("Auto-save failed:",t),!1}finally{o.value=!1}},xe=async()=>{if(!a.value)return!1;try{return M.value=!0,await b(a.value.id),!0}catch(e){return d("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è",e.message||"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∞–≥–µ–Ω—Ç–∞"),!1}finally{M.value=!1}},ke=()=>{a.value&&(g.value=de(a.value))},De=()=>{var e;g.value.system_prompt=((e=a.value)==null?void 0:e.system_prompt)||""},oe=async()=>{if(a.value)try{m.value=!0;const[e,t]=await Promise.all([v("/tools",{headers:{Authorization:`Bearer ${i.value}`}}),v(`/agents/${a.value.id}/tools`,{headers:{Authorization:`Bearer ${i.value}`}})]);r.value=e,s.value=t,w.value=!0}catch(e){console.error("Failed to fetch tools:",e)}finally{m.value=!1}},Fe=async()=>{w.value||m.value||await oe()},Be=async e=>{if(!a.value)return;const t=s.value.some(c=>c.tool_id===e.id);try{t?await v(`/agents/${a.value.id}/tools/${e.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${i.value}`}}):await v(`/agents/${a.value.id}/tools/${e.id}`,{method:"POST",headers:{Authorization:`Bearer ${i.value}`,"Content-Type":"application/json"},body:{permission_scope:"read",timeout_ms:15e3}}),await oe()}catch(c){console.error("Failed to toggle tool:",c)}},ge=async()=>{if(a.value){q.value=!0;try{const t=(await v(`/agents/${a.value.id}/channels/active`,{method:"GET",headers:{Authorization:`Bearer ${i.value}`}})).find(c=>c.type==="telegram");P.value=t?{id:t.id,bot_token:t.telegram_bot_token,webhook_enabled:t.telegram_webhook_enabled,webhook_endpoint:t.telegram_webhook_endpoint}:null,I.value=!0}catch(e){console.error("Failed to fetch channels:",e),P.value=null}finally{q.value=!1}}},Oe=async()=>{I.value||q.value||await ge()},ze=async()=>{!G.value||W.value||(await G.value.fetchDirectories(),W.value=!0)},te=async()=>{if(a.value)try{B.value=null;const e=await $(a.value.id);T.value=e,Q.value=!0}catch(e){if((e==null?void 0:e.statusCode)===404){Q.value=!0;return}B.value=e.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—É—Å SQNS"}},Ne=async()=>{Q.value||await te()},Pe=async()=>{var e;if(!(R.value||!a.value||!((e=T.value)!=null&&e.sqnsEnabled)))try{const[t,c]=await Promise.all([O(a.value.id),z(a.value.id)]);X.value=t,Z.value=c,R.value=!0}catch(t){if((t==null?void 0:t.statusCode)===400||(t==null?void 0:t.statusCode)===404)return;B.value=t.message||"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ SQNS"}},Ie=async e=>{if(!a.value)return!1;try{return await C(a.value.id,{host:"crmexchange.1denta.ru",email:e.email,password:e.password,defaultResourceId:e.defaultResourceId}),R.value=!1,await te(),!0}catch(t){return B.value=t.message||"–û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è SQNS",!1}},Re=async()=>{if(!a.value)return!1;try{return await j(a.value.id),R.value=!1,X.value=[],Z.value=[],await te(),!0}catch(e){return B.value=e.message||"–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è SQNS",!1}},He=async()=>{if(!(!A.value||D.value))try{await A.value.fetchHistory(),D.value=!0}catch{D.value=!1}},je=()=>{if(typeof window>"u"||!a.value)return;const e=localStorage.getItem(`${pe}-${a.value.id}`);if(e)try{S.value=JSON.parse(e)}catch(t){console.error("Failed to parse stored messages:",t),S.value=[]}},we=()=>{typeof window>"u"||!a.value||localStorage.setItem(`${pe}-${a.value.id}`,JSON.stringify(S.value))},Je=()=>{ee.value||!a.value||(je(),L.value=_(a.value.id),ee.value=!0)},Me=async()=>{if(!V.value.trim()||K.value||!a.value)return!1;const e=V.value.trim();V.value="",S.value.push({role:"user",content:e});try{K.value=!0;const t={agent_id:a.value.id,input_message:e};L.value&&(t.session_id=L.value);const c=await v("/runs",{method:"POST",headers:{"Content-Type":"application/json"},body:t});if(c){c.session_id&&a.value&&(p(a.value.id,c.session_id),L.value=c.session_id);const re=c.prompt_tokens!==null&&c.prompt_tokens!==void 0||c.completion_tokens!==null&&c.completion_tokens!==void 0||c.total_tokens!==null&&c.total_tokens!==void 0?{prompt:c.prompt_tokens??null,completion:c.completion_tokens??null,total:c.total_tokens??null}:void 0,le=c.tools_called&&c.tools_called.length>0?c.tools_called:void 0;if(c.status==="succeeded"&&c.output_message){let ue=c.output_message;const ie=ue.match(/AgentRunResult\(output=['"]([\s\S]*)['"]\)/);ie&&ie[1]&&(ue=ie[1]),S.value.push({role:"agent",content:ue,tokens:re,tools_called:le})}else c.status==="failed"&&c.error_message?(S.value.push({role:"agent",content:`–û—à–∏–±–∫–∞: ${c.error_message}`,tokens:re,tools_called:le}),d("–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞",c.error_message)):S.value.push({role:"agent",content:"–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞.",tokens:re,tools_called:le})}else S.value.push({role:"agent",content:"–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞.",tokens:void 0,tools_called:void 0})}catch(t){console.error("Chat error:",t),t.statusCode===400&&L.value&&a.value&&(F(a.value.id),L.value=null),S.value.push({role:"agent",content:"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–≤—è–∑–∏ —Å –∞–≥–µ–Ω—Ç–æ–º.",tokens:void 0,tools_called:void 0})}finally{K.value=!1}return!0},Ue=async()=>{if(a.value){if(L.value)try{await v(`/runs/session/${L.value}`,{method:"DELETE",headers:{Authorization:`Bearer ${i.value}`}})}catch(e){console.error("Failed to clear session on backend:",e)}S.value=[],we(),F(a.value.id),L.value=null}},_e=e=>{const t=r.value.find(c=>c.id===e);return(t==null?void 0:t.name)||"–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç"},Se=e=>{const t=r.value.find(c=>c.id===e);return(t==null?void 0:t.description)||""},ne=k(()=>{var c;const e=((c=T.value)==null?void 0:c.sqnsTools)??[],t={sqns_list_resources:"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏",sqns_list_services:"–£—Å–ª—É–≥–∏",sqns_find_client:"–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞",sqns_list_slots:"–ü–æ–∏—Å–∫ —Å–ª–æ—Ç–æ–≤"};return e.map(ae=>({...ae,displayName:t[ae.name]||ae.name}))}),be=k(()=>{var e;return((e=T.value)==null?void 0:e.sqnsEnabled)??!1}),Ge=k(()=>{var e,t;return(e=T.value)!=null&&e.sqnsEnabled?((t=T.value)==null?void 0:t.sqnsStatus)==="error"?"–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞":"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞":"SQNS –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω"}),Qe=k(()=>{var e;return((e=T.value)==null?void 0:e.sqnsHost)??"–Ω–µ —É–∫–∞–∑–∞–Ω"}),Ve=k(()=>{var e;return((e=T.value)==null?void 0:e.sqnsError)??""}),Ke=k(()=>{var c;const e=(c=T.value)==null?void 0:c.sqnsLastSyncAt;if(!e)return"–Ω–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π";const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString("ru-RU",{dateStyle:"medium",timeStyle:"short"})}),Ye=k(()=>{const e=[];return be.value&&ne.value.length&&e.push(...ne.value.map(t=>({name:t.name,description:t.description}))),s.value.length&&e.push(...s.value.map(t=>({name:_e(t.tool_id),description:Se(t.tool_id)}))),e}),We=k(()=>{const e=S.value.length;return e>0?`–∫–æ–Ω—Ç–µ–∫—Å—Ç: ${e} —Å–æ–æ–±—â–µ–Ω–∏–π`:""});return typeof window<"u"&&(ce(S,()=>{we()},{deep:!0}),ve(()=>g.value.system_prompt,async(e,t)=>{!a.value||!E.value||e!==t&&e!==a.value.system_prompt&&l.value&&await ye()},{debounce:5e3}),ce(()=>g.value.model,async(e,t)=>{!a.value||!E.value||e!==t&&e!==a.value.model&&await Y({model:e})}),ve(()=>g.value.name,async(e,t)=>{!a.value||!E.value||e!==t&&e!==a.value.name&&await Y({name:e})},{debounce:2e3}),ce(()=>g.value.status,async(e,t)=>{!a.value||!E.value||e!==t&&e!==a.value.status&&await Y({status:e})}),ve(()=>g.value.llm_params,async(e,t)=>{!a.value||!E.value||JSON.stringify(e)!==JSON.stringify(t)&&JSON.stringify(e)!==JSON.stringify(a.value.llm_params)&&await Y({llm_params:e})},{debounce:1e3,deep:!0})),{agentId:x,agent:a,form:g,isLoaded:E,isLoading:N,isSaving:J,isDeleting:M,error:U,isPromptFullscreen:se,isAutoSaving:o,lastAutoSavedAt:n,isPromptFocused:l,availableTools:r,boundTools:s,isLoadingTools:m,toolsLoaded:w,telegramChannel:P,isLoadingChannels:q,channelsLoaded:I,directoriesComposable:G,directoriesLoaded:W,promptHistory:A,promptHistoryLoaded:D,sqnsStatus:T,sqnsResources:X,sqnsServices:Z,sqnsError:B,sqnsStatusLoaded:Q,sqnsHintsLoaded:R,messages:S,userInput:V,isTyping:K,currentSessionId:L,chatLoaded:ee,sqnsToolsList:ne,isSqnsEnabled:be,sqnsStatusLabel:Ge,sqnsHostLabel:Qe,sqnsErrorMessage:Ve,formattedSqnsSyncAt:Ke,promptSidebarTools:Ye,chatContextLabel:We,setAgentId:he,ensureAgentLoaded:Le,saveAgent:Ce,autoSavePrompt:ye,autoSaveField:Y,removeAgent:xe,resetForm:ke,resetPrompt:De,fetchToolsData:oe,ensureToolsLoaded:Fe,toggleTool:Be,fetchChannels:ge,ensureChannelsLoaded:Oe,ensureDirectoriesLoaded:ze,loadSqnsStatusForAgent:te,ensureSqnsStatusLoaded:Ne,ensureSqnsHints:Pe,enableSqnsIntegration:Ie,disableSqnsIntegration:Re,ensurePromptHistoryLoaded:He,ensureChatLoaded:Je,sendMessage:Me,clearChat:Ue,getToolName:_e,getToolDescription:Se}});export{vt as u};
