import{M as Q,m as W,c1 as Y,n as M,b as p,q as N,w as q,T as re,o as a,c as n,s as I,a as e,u as r,X as G,v as H,x as de,O as ue,t as u,p as b,d as C,k as d,z as Z,B as ce,f as pe,F as X,C as J,A as me,L as ve}from"./entry.CBkKRCnV.js";import{u as xe}from"./useLayoutState.B8IzXTUd.js";import{u as fe}from"./useAuth.CHSuA4zA.js";import{u as ge}from"./usePermissions.DJmIznYF.js";import{u as ee,g as S}from"./useApiFetch.B9YviUBz.js";import{L}from"./loader-2.CrTaI3Us.js";import{A as K}from"./alert-circle.DcUsP5Lj.js";import{U as be}from"./users.bdEIwFds.js";import{P as ye}from"./plus.CAbVbV7B.js";import{C as he}from"./copy.cIoq39HJ.js";import{T as we}from"./trash-2.BLHjeIGf.js";import"./authSessionManager.BK0upO_P.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=Q("ClockIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=Q("MailIcon",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]),Ce={key:0,class:"p-6"},$e={class:"flex items-center justify-between mb-6"},Te={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-3"},Ue={class:"text-sm text-red-800"},Le={class:"flex gap-3 justify-end pt-4"},Me=["disabled"],je={key:1,class:"p-6"},De={class:"flex items-center justify-between mb-6"},Ee={class:"space-y-4"},Se={class:"flex gap-2"},Ie=["value"],Ae=["disabled"],Re=W({__name:"InviteUserModal",props:{isOpen:{type:Boolean}},emits:["close","invited"],setup(A,{emit:R}){const j=R,$=ee(),v=Z(),{public:{siteUrl:_}}=Y(),g=d({email:"",role:"manager"}),y=d(!1),h=d(null),m=d(null),w=d(!1),x=()=>_&&!_.includes("localhost")&&!_.includes("127.0.0.1")?_:typeof window<"u"?window.location.origin:_||"",D=i=>{if(!i)return i;const o=x();try{const c=o?new URL(i,o):new URL(i);if(o){const k=new URL(o);c.host&&k.host&&c.host!==k.host&&(c.protocol=k.protocol,c.host=k.host)}return c.toString()}catch{return i}},B=async()=>{var i;y.value=!0,h.value=null;try{const o=await $("/invitations",{method:"POST",headers:{"Content-Type":"application/json"},body:{email:g.value.email,role:g.value.role}});m.value=D(o.invite_link),v.success("Приглашение создано","Ссылка для приглашения готова к использованию")}catch(o){const k=((o==null?void 0:o.status)||(o==null?void 0:o.statusCode)||((i=o==null?void 0:o.response)==null?void 0:i.status))===409?"Приглашение для этого email уже существует. Удалите старое или используйте другой email.":S(o,"Не удалось создать приглашение");h.value=k,v.error("Ошибка",k)}finally{y.value=!1}},U=async()=>{if(m.value)try{await navigator.clipboard.writeText(m.value),w.value=!0,v.success("Скопировано","Ссылка скопирована в буфер обмена"),setTimeout(()=>{w.value=!1},2e3)}catch{v.error("Ошибка","Не удалось скопировать ссылку")}},T=()=>{g.value={email:"",role:"manager"},h.value=null,m.value=null,w.value=!1,j("close")};return(i,o)=>(a(),M(re,{to:"body"},[p(N,{"enter-active-class":"transition-opacity duration-300","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition-opacity duration-200","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:q(()=>[A.isOpen?(a(),n("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",onClick:o[5]||(o[5]=I(c=>i.$emit("close"),["self"]))},[p(N,{"enter-active-class":"transition-all duration-300","enter-from-class":"opacity-0 scale-95","enter-to-class":"opacity-100 scale-100","leave-active-class":"transition-all duration-200","leave-from-class":"opacity-100 scale-100","leave-to-class":"opacity-0 scale-95"},{default:q(()=>[A.isOpen?(a(),n("div",{key:0,class:"bg-white rounded-xl shadow-xl max-w-md w-full mx-4",onClick:o[4]||(o[4]=I(()=>{},["stop"]))},[m.value?(a(),n("div",je,[e("div",De,[o[10]||(o[10]=e("h2",{class:"text-xl font-bold text-slate-900"}," Приглашение создано ",-1)),e("button",{onClick:T,class:"p-2 text-slate-400 hover:text-slate-600 transition-colors"},[p(r(G),{class:"h-5 w-5"})])]),e("div",Ee,[e("div",null,[o[11]||(o[11]=e("label",{class:"block text-sm font-medium text-slate-700 mb-2"}," Ссылка для приглашения ",-1)),e("div",Se,[e("input",{value:m.value,readonly:"",class:"flex-1 px-3 py-2 text-slate-900 border border-slate-300 rounded-lg bg-slate-50 text-sm"},null,8,Ie),e("button",{onClick:U,disabled:w.value,class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors whitespace-nowrap"},u(w.value?"Скопировано":"Копировать"),9,Ae)])]),o[12]||(o[12]=e("div",{class:"bg-blue-50 border border-blue-200 rounded-lg p-3"},[e("p",{class:"text-sm text-blue-800"},[e("strong",null,"Важно:"),C(" Email не отправляется автоматически. Скопируйте ссылку и отправьте её пользователю вручную. ")])],-1)),e("div",{class:"flex justify-end pt-4"},[e("button",{onClick:T,class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"}," Готово ")])])])):(a(),n("div",Ce,[e("div",$e,[o[6]||(o[6]=e("h2",{class:"text-xl font-bold text-slate-900"}," Пригласить пользователя ",-1)),e("button",{onClick:o[0]||(o[0]=c=>i.$emit("close")),class:"p-2 text-slate-400 hover:text-slate-600 transition-colors"},[p(r(G),{class:"h-5 w-5"})])]),e("form",{onSubmit:I(B,["prevent"]),class:"space-y-4"},[e("div",null,[o[7]||(o[7]=e("label",{class:"block text-sm font-medium text-slate-700 mb-2"}," Email ",-1)),H(e("input",{"onUpdate:modelValue":o[1]||(o[1]=c=>g.value.email=c),type:"email",required:"",class:"w-full px-3 py-2 text-slate-900 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",placeholder:"user@example.com"},null,512),[[de,g.value.email]])]),e("div",null,[o[9]||(o[9]=e("label",{class:"block text-sm font-medium text-slate-700 mb-2"}," Роль ",-1)),H(e("select",{"onUpdate:modelValue":o[2]||(o[2]=c=>g.value.role=c),required:"",class:"w-full px-3 py-2 text-slate-900 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"},[...o[8]||(o[8]=[e("option",{value:"admin"},"Администратор",-1),e("option",{value:"manager"},"Менеджер",-1)])],512),[[ue,g.value.role]])]),h.value?(a(),n("div",Te,[e("p",Ue,u(h.value),1)])):b("",!0),e("div",Le,[e("button",{type:"button",onClick:o[3]||(o[3]=c=>i.$emit("close")),class:"px-4 py-2 text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors"}," Отмена "),e("button",{type:"submit",disabled:y.value,class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2"},[y.value?(a(),M(r(L),{key:0,class:"h-4 w-4 animate-spin"})):b("",!0),C(" "+u(y.value?"Создание...":"Создать приглашение"),1)],8,Me)])],32)]))])):b("",!0)]),_:1})])):b("",!0)]),_:1})]))}}),Be={class:"w-full px-5 py-5 flex flex-col gap-5"},Fe={key:0,class:"bg-white rounded-xl border border-border p-8 text-center"},Ve={class:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"},Oe={key:1},Pe={key:0,class:"bg-white rounded-xl border border-border p-12 text-center"},ze={key:1,class:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6"},Ne={class:"flex items-center"},qe={class:"text-sm text-red-700 mt-1"},Ge={key:2,class:"bg-white rounded-xl border border-border overflow-hidden"},He={class:"overflow-x-auto"},Xe={class:"w-full"},Je={class:"bg-white divide-y divide-slate-200"},Ke={class:"px-6 py-4 whitespace-nowrap"},Qe={class:"flex items-center"},We={class:"w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shrink-0"},Ye={class:"text-primary-foreground font-bold text-sm"},Ze={class:"ml-4"},et={class:"text-sm font-medium text-foreground"},tt={class:"text-sm text-slate-500"},st={class:"px-6 py-4 whitespace-nowrap"},ot={class:"flex items-center gap-2"},lt={key:0,class:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800"},at=["value","onChange","disabled"],nt={class:"px-6 py-4 whitespace-nowrap text-sm text-slate-500"},it={class:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium"},rt=["onClick","disabled"],dt={key:1},ut={key:3,class:"bg-white rounded-xl border border-border p-12 text-center"},ct={class:"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4"},pt={key:4,class:"mt-8"},mt={class:"text-lg font-semibold text-foreground mb-4 flex items-center gap-2"},vt={class:"text-sm font-normal text-slate-500"},xt={class:"bg-white rounded-xl border border-border overflow-hidden"},ft={class:"divide-y divide-slate-200"},gt={class:"flex flex-col sm:flex-row sm:items-center justify-between gap-3"},bt={class:"flex-1 min-w-0"},yt={class:"flex items-center gap-2 mb-1"},ht={class:"font-medium text-foreground truncate"},wt={class:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-slate-500"},_t={class:"flex items-center gap-1"},kt={class:"flex items-center gap-2 shrink-0"},Ct=["onClick","disabled"],$t=["onClick","disabled"],Tt={key:0,class:"mt-2"},Ut={class:"flex items-center gap-2"},Lt=["value"],Mt={key:5,class:"mt-8"},jt={class:"flex items-center gap-2 text-slate-500"},Dt={class:"bg-white rounded-xl shadow-xl max-w-md w-full mx-4"},Et={class:"p-6"},St={class:"text-muted-foreground mb-6"},It={class:"flex gap-3 justify-end"},At=["disabled"],Jt=W({__name:"team",setup(A){const{pageTitle:R}=xe(),j=d(!1),$=d([]),v=d([]),_=d(!1),g=d(!1),y=d(null),h=d(new Set),m=d(new Set),w=d(new Set),x=d(null),D=d(null),{user:B}=fe(),{canManageMembers:U}=ge(),T=ee(),i=Z(),{public:{siteUrl:o}}=Y(),c=ve(()=>{var l;return((l=B.value)==null?void 0:l.id)??null}),k=l=>{if(!l)return l;const t=o&&!o.includes("localhost")?o:typeof window<"u"?window.location.origin:"";try{const s=t?new URL(l,t):new URL(l);if(t){const f=new URL(t);s.host!==f.host&&(s.protocol=f.protocol,s.host=f.host)}return s.toString()}catch{return l}},E=l=>new Date(l)<new Date,F=l=>{if(!l)return"Никогда";try{return new Date(l).toLocaleDateString("ru-RU",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return"Неизвестно"}},V=async()=>{if(U.value){_.value=!0,y.value=null;try{const l=await T("/users",{method:"GET"});$.value=l||[]}catch(l){const t=S(l,"Не удалось загрузить список участников");y.value=t,i.error("Ошибка",t)}finally{_.value=!1}}},O=async()=>{if(U.value){g.value=!0;try{const l=await T("/invitations",{method:"GET"});v.value=(l||[]).map(t=>({...t,invite_link:k(t.invite_link)}))}catch(l){console.warn("Failed to fetch invitations:",l),v.value=[]}finally{g.value=!1}}},te=async l=>{try{await navigator.clipboard.writeText(l.invite_link),D.value=l.id,i.success("Скопировано","Ссылка скопирована в буфер обмена"),setTimeout(()=>{D.value=null},2e3)}catch{i.error("Ошибка","Не удалось скопировать ссылку")}},se=async l=>{w.value.add(l);try{await T(`/invitations/${l}`,{method:"DELETE"}),v.value=v.value.filter(t=>t.id!==l),i.success("Приглашение удалено","Приглашение успешно отменено")}catch(t){i.error("Ошибка",S(t,"Не удалось удалить приглашение"))}finally{w.value.delete(l)}},oe=async(l,t)=>{if(t!=="admin"&&t!=="manager"){i.error("Ошибка","Некорректная роль");return}h.value.add(l);try{await T(`/users/${l}/role`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:{role:t}});const s=$.value.find(f=>f.id===l);s&&(s.role=t),i.success("Роль обновлена",`Роль участника успешно изменена на "${t==="admin"?"Администратор":"Менеджер"}"`)}catch(s){i.error("Ошибка",S(s,"Не удалось обновить роль"))}finally{h.value.delete(l)}},le=l=>{x.value=l},ae=async l=>{m.value.add(l);try{await T(`/users/${l}`,{method:"DELETE"}),$.value=$.value.filter(t=>t.id!==l),x.value=null,i.success("Участник удален","Участник успешно удален из организации")}catch(t){i.error("Ошибка",S(t,"Не удалось удалить участника"))}finally{m.value.delete(l)}},ne=()=>{j.value=!1,V(),O()},ie=l=>({admin:"Администратор",manager:"Менеджер",owner:"Владелец"})[l]||l,P=d(!1),z=()=>{U.value&&!P.value&&(P.value=!0,V(),O())};return ce(()=>{R.value="Участники организации",z()}),pe(U,l=>{l&&z()}),(l,t)=>(a(),n("div",Be,[r(U)?(a(),n("div",Oe,[_.value?(a(),n("div",Pe,[p(r(L),{class:"h-8 w-8 text-indigo-600 animate-spin mx-auto mb-4"}),t[7]||(t[7]=e("p",{class:"text-muted-foreground"},"Загрузка участников...",-1))])):y.value?(a(),n("div",ze,[e("div",Ne,[p(r(K),{class:"h-5 w-5 text-red-400 mr-3"}),e("div",null,[t[8]||(t[8]=e("h3",{class:"text-sm font-medium text-red-800"},"Ошибка загрузки",-1)),e("p",qe,u(y.value),1)])])])):$.value.length>0?(a(),n("div",Ge,[e("div",He,[e("table",Xe,[t[10]||(t[10]=e("thead",{class:"bg-muted border-b border-border"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"}," Пользователь "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"}," Роль "),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"}," Дата входа "),e("th",{class:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider"}," Действия ")])],-1)),e("tbody",Je,[(a(!0),n(X,null,J($.value,s=>(a(),n("tr",{key:s.id,class:"hover:bg-muted"},[e("td",Ke,[e("div",Qe,[e("div",We,[e("span",Ye,u(s.full_name?s.full_name.split(" ").map(f=>f.charAt(0)).join("").toUpperCase():s.email.charAt(0).toUpperCase()),1)]),e("div",Ze,[e("div",et,u(s.full_name||"Без имени"),1),e("div",tt,u(s.email),1)])])]),e("td",st,[e("div",ot,[s.role==="owner"?(a(),n("span",lt," Владелец ")):(a(),n("select",{key:1,value:s.role,onChange:f=>oe(s.id,f.target.value),disabled:h.value.has(s.id),class:"text-sm border border-slate-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"},[...t[9]||(t[9]=[e("option",{value:"admin"},"Администратор",-1),e("option",{value:"manager"},"Менеджер",-1)])],40,at)),h.value.has(s.id)?(a(),M(r(L),{key:2,class:"h-4 w-4 text-indigo-600 animate-spin"})):b("",!0)])]),e("td",nt,u(F(s.last_login_at)),1),e("td",it,[s.role!=="owner"&&s.id!==c.value?(a(),n("button",{key:0,onClick:f=>le(s),disabled:m.value.has(s.id),class:"text-red-600 hover:text-red-900 disabled:opacity-50 disabled:cursor-not-allowed"},[m.value.has(s.id)?(a(),M(r(L),{key:0,class:"h-4 w-4 animate-spin inline"})):(a(),n("span",dt,"Удалить"))],8,rt)):b("",!0)])]))),128))])])])])):(a(),n("div",ut,[e("div",ct,[p(r(be),{class:"h-8 w-8 text-slate-400"})]),t[12]||(t[12]=e("h3",{class:"text-lg font-semibold text-foreground mb-2"}," Нет участников ",-1)),t[13]||(t[13]=e("p",{class:"text-muted-foreground text-sm mb-4"}," Пригласите первого участника в организацию ",-1)),e("button",{onClick:t[0]||(t[0]=s=>j.value=!0),class:"inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"},[p(r(ye),{class:"h-4 w-4"}),t[11]||(t[11]=e("span",null,"Пригласить",-1))])])),v.value.length>0?(a(),n("div",pt,[e("h2",mt,[p(r(ke),{class:"h-5 w-5 text-slate-500"}),t[14]||(t[14]=C(" Ожидающие приглашения ",-1)),e("span",vt,"("+u(v.value.length)+")",1)]),e("div",xt,[e("div",ft,[(a(!0),n(X,null,J(v.value,s=>(a(),n("div",{key:s.id,class:"p-4 hover:bg-muted transition-colors"},[e("div",gt,[e("div",bt,[e("div",yt,[e("span",ht,u(s.email),1),e("span",{class:me(["inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium",E(s.expires_at)?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"])},u(E(s.expires_at)?"Истекло":"Ожидает"),3)]),e("div",wt,[e("span",null,"Роль: "+u(ie(s.role)),1),e("span",_t,[p(r(_e),{class:"h-3.5 w-3.5"}),C(" "+u(E(s.expires_at)?"Истекло":"До")+": "+u(F(s.expires_at)),1)])])]),e("div",kt,[E(s.expires_at)?b("",!0):(a(),n("button",{key:0,onClick:f=>te(s),disabled:D.value===s.id,class:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm text-indigo-600 bg-indigo-50 rounded-lg hover:bg-indigo-100 disabled:opacity-50 transition-colors"},[p(r(he),{class:"h-4 w-4"}),C(" "+u(D.value===s.id?"Скопировано":"Копировать"),1)],8,Ct)),e("button",{onClick:f=>se(s.id),disabled:w.value.has(s.id),class:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm text-red-600 bg-red-50 rounded-lg hover:bg-red-100 disabled:opacity-50 transition-colors"},[w.value.has(s.id)?(a(),M(r(L),{key:0,class:"h-4 w-4 animate-spin"})):(a(),M(r(we),{key:1,class:"h-4 w-4"})),t[15]||(t[15]=C(" Удалить ",-1))],8,$t)])]),E(s.expires_at)?b("",!0):(a(),n("div",Tt,[e("div",Ut,[e("input",{value:s.invite_link,readonly:"",class:"flex-1 px-3 py-1.5 text-xs text-muted-foreground bg-muted border border-border rounded-lg truncate"},null,8,Lt)])]))]))),128))])])])):g.value?(a(),n("div",Mt,[e("div",jt,[p(r(L),{class:"h-4 w-4 animate-spin"}),t[16]||(t[16]=e("span",{class:"text-sm"},"Загрузка приглашений...",-1))])])):b("",!0)])):(a(),n("div",Fe,[e("div",Ve,[p(r(K),{class:"h-8 w-8 text-red-600"})]),t[5]||(t[5]=e("h3",{class:"text-lg font-semibold text-foreground mb-2"}," Недостаточно прав ",-1)),t[6]||(t[6]=e("p",{class:"text-muted-foreground text-sm"}," У вас нет доступа к управлению участниками организации ",-1))])),p(Re,{"is-open":j.value,onClose:t[1]||(t[1]=s=>j.value=!1),onInvited:ne},null,8,["is-open"]),x.value?(a(),n("div",{key:2,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",onClick:t[4]||(t[4]=I(s=>x.value=null,["self"]))},[e("div",Dt,[e("div",Et,[t[20]||(t[20]=e("h2",{class:"text-xl font-bold text-foreground mb-4"}," Подтверждение удаления ",-1)),e("p",St,[t[17]||(t[17]=C(" Вы уверены, что хотите удалить участника ",-1)),e("strong",null,u(x.value.full_name||x.value.email),1),t[18]||(t[18]=C("? Это действие нельзя отменить. ",-1))]),e("div",It,[e("button",{onClick:t[2]||(t[2]=s=>x.value=null),class:"px-4 py-2 text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors"}," Отмена "),e("button",{onClick:t[3]||(t[3]=s=>ae(x.value.id)),disabled:m.value.has(x.value.id),class:"px-4 py-2 bg-red-600 text-primary-foreground rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2"},[m.value.has(x.value.id)?(a(),M(r(L),{key:0,class:"h-4 w-4 animate-spin"})):b("",!0),t[19]||(t[19]=C(" Удалить ",-1))],8,At)])])])])):b("",!0)]))}});export{Jt as default};
