import{bY as de,f as Q,k as O,bd as be,bc as nt,b3 as He,u as N,L as B,m as oe,o as y,c as R,s as Ee,a as i,A as V,n as K,t as G,p as q,d as pe,b as U,T as De,w as ae,aX as Je,q as ce,v as je,x as Ne,E as at,H as ye,bg as ot,_ as Ae,a2 as Ve,F as ue,C as Oe,J as lt,B as Ge,D as it,X as rt,N as ct,c0 as ut}from"./entry.CVvpXMAV.js";import{u as dt}from"./useAgents.BVvSzsfX.js";import{u as Ke,a as gt}from"./useAuth.Bu6P1IiJ.js";import{n as Ce,i as ft,a as mt,t as vt,b as Xe,c as pt}from"./index.Dnmbk6A8.js";import{M as Se}from"./message-square.0RgVcxgB.js";import{M as yt}from"./more-vertical.BvZM7RxK.js";import{P as xt}from"./pencil.Btu4QvJO.js";import{T as ht}from"./trash-2.Dzc9Rnwm.js";import{C as bt}from"./chevron-down.DWuYxfsG.js";import{C as Ye}from"./check.nYYGxIUw.js";import{S as _t}from"./search.DHahtJER.js";import{L as $e}from"./loader-2.CJ85gz1d.js";import{A as kt}from"./chevron-right.tKVFfOuR.js";import{M as St}from"./index.BMSQkwth.js";import{A as Qe}from"./alert-circle.DxAvbiuF.js";import{P as $t}from"./plus.Collj5cL.js";import{U as Mt}from"./user-check.C7subQIO.js";import{S as Dt}from"./send.ccOK7jhK.js";import{M as Ct,_ as Pe}from"./DashboardSidebar.vue.CIlx5ziS.js";import{_ as At}from"./AuthModal.vue.B2CHdnIo.js";import"./nuxt-link.BLS_a--H.js";import"./index.DopZtmKD.js";import"./link.DE3y2oKi.js";import"./database.CGsskZ8s.js";import"./cpu.Du2Q-9ux.js";import"./settings.DWy3YrYR.js";import"./eye.CUTpVi36.js";/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wt=de("ArrowDownIcon",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rt=de("ImageIcon",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=de("MessageCircleIcon",[["path",{d:"m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z",key:"v2veuj"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=de("MicIcon",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tt=de("PauseCircleIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"10",x2:"10",y1:"15",y2:"9",key:"c1nkhi"}],["line",{x1:"14",x2:"14",y1:"15",y2:"9",key:"h65svq"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Et=de("PauseIcon",[["rect",{width:"4",height:"16",x:"6",y:"4",key:"iffhe4"}],["rect",{width:"4",height:"16",x:"14",y:"4",key:"sjin7j"}]]);/**
 * @license lucide-vue-next v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ot=de("PlayIcon",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);function ke(e){var s;const c=Xe(e);return(s=c==null?void 0:c.$el)!=null?s:c}const Ze=mt?window:void 0;function Re(...e){let s,c,g,k;if(typeof e[0]=="string"||Array.isArray(e[0])?([c,g,k]=e,s=Ze):[s,c,g,k]=e,!s)return Ce;Array.isArray(c)||(c=[c]),Array.isArray(g)||(g=[g]);const I=[],S=()=>{I.forEach(p=>p()),I.length=0},T=(p,_,x,d)=>(p.addEventListener(_,x,d),()=>p.removeEventListener(_,x,d)),w=Q(()=>[ke(s),Xe(k)],([p,_])=>{if(S(),!p)return;const x=pt(_)?{..._}:_;I.push(...c.flatMap(d=>g.map(a=>T(p,d,a,x))))},{immediate:!0,flush:"post"}),m=()=>{w(),S()};return vt(m),m}let ze=!1;function et(e,s,c={}){const{window:g=Ze,ignore:k=[],capture:I=!0,detectIframe:S=!1}=c;if(!g)return Ce;ft&&!ze&&(ze=!0,Array.from(g.document.body.children).forEach(x=>x.addEventListener("click",Ce)),g.document.documentElement.addEventListener("click",Ce));let T=!0;const w=x=>k.some(d=>{if(typeof d=="string")return Array.from(g.document.querySelectorAll(d)).some(a=>a===x.target||x.composedPath().includes(a));{const a=ke(d);return a&&(x.target===a||x.composedPath().includes(a))}}),p=[Re(g,"click",x=>{const d=ke(e);if(!(!d||d===x.target||x.composedPath().includes(d))){if(x.detail===0&&(T=!w(x)),!T){T=!0;return}s(x)}},{passive:!0,capture:I}),Re(g,"pointerdown",x=>{const d=ke(e);T=!w(x)&&!!(d&&!x.composedPath().includes(d))},{passive:!0}),S&&Re(g,"blur",x=>{setTimeout(()=>{var d;const a=ke(e);((d=g.document.activeElement)==null?void 0:d.tagName)==="IFRAME"&&!(a!=null&&a.contains(g.document.activeElement))&&s(x)},0)})].filter(Boolean);return()=>p.forEach(x=>x())}const Fe=new Set(["active","paused"]),Me=e=>{const s=e.status&&Fe.has(e.status)?e.status:e.agent_status??"active";return{...e,agent_status:s,status:Fe.has(e.status)?"NORMAL":e.status||"NORMAL"}},j=O([]),_e=O(!1),ne=O(null),Ie=O(null),xe=()=>{const e=Ke();return{dialogs:j,isLoading:_e,error:ne,currentAgentId:Ie,fetchDialogs:async(a,l)=>{var $,v;if(!a){console.warn("[useDialogs] fetchDialogs called without agentId");return}_e.value=!0,ne.value=null,Ie.value=a;try{const r=new URLSearchParams;(l==null?void 0:l.archived)!==void 0&&r.set("archived",String(l.archived));const D=r.toString(),M=`agents/${a}/dialogs${D?`?${D}`:""}`,n=await e(M);let t=[];Array.isArray(n)?t=n:n&&typeof n=="object"&&"dialogs"in n?t=n.dialogs||[]:n&&typeof n=="object"&&"items"in n&&(t=n.items||[]),j.value=t.map(Me)}catch(r){console.error("[useDialogs] Error fetching dialogs:",r),console.error("[useDialogs] Error details:",{status:(r==null?void 0:r.statusCode)||(r==null?void 0:r.status),data:r==null?void 0:r.data,message:r==null?void 0:r.message});const D=(($=r==null?void 0:r.data)==null?void 0:$.detail)??((v=r==null?void 0:r.data)==null?void 0:v.message)??(r==null?void 0:r.message)??"Не удалось загрузить диалоги";ne.value=typeof D=="string"?D:JSON.stringify(D),j.value=[]}finally{_e.value=!1}},createDialog:async(a,l)=>{var $,v;if(!a)return null;_e.value=!0,ne.value=null;try{const r=await e(`agents/${a}/dialogs`,{method:"POST",headers:{"Content-Type":"application/json"},body:l||{}}),D=Me(r);return j.value=[D,...j.value],D}catch(r){const D=(($=r==null?void 0:r.data)==null?void 0:$.detail)??((v=r==null?void 0:r.data)==null?void 0:v.message)??(r==null?void 0:r.message)??"Не удалось создать диалог";return ne.value=typeof D=="string"?D:JSON.stringify(D),null}finally{_e.value=!1}},updateDialog:async(a,l,$)=>{var v,r;if(!a||!l)return null;try{const D=await e(`agents/${a}/dialogs/${encodeURIComponent(l)}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:$}),M=Me(D),n=j.value.findIndex(t=>t.id===l);return n!==-1&&(j.value[n]=M),M}catch(D){const M=((v=D==null?void 0:D.data)==null?void 0:v.detail)??((r=D==null?void 0:D.data)==null?void 0:r.message)??(D==null?void 0:D.message)??"Не удалось обновить диалог";return ne.value=typeof M=="string"?M:JSON.stringify(M),null}},deleteDialog:async(a,l)=>{var $,v;if(!a||!l)return!1;try{return await e(`agents/${a}/dialogs/${encodeURIComponent(l)}`,{method:"DELETE"}),j.value=j.value.filter(r=>r.id!==l),!0}catch(r){const D=(($=r==null?void 0:r.data)==null?void 0:$.detail)??((v=r==null?void 0:r.data)==null?void 0:v.message)??(r==null?void 0:r.message)??"Не удалось удалить диалог";return ne.value=typeof D=="string"?D:JSON.stringify(D),!1}},toggleDialogAgentStatus:async(a,l)=>{var D,M;if(!a||!l)return null;const $=j.value.findIndex(n=>n.id===l),v=$!==-1?j.value[$].agent_status??"active":"active",r=v==="active"?"paused":"active";$!==-1&&(j.value[$]={...j.value[$],agent_status:r});try{return await e(`agents/${a}/dialogs/${encodeURIComponent(l)}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:{status:r}}),r}catch(n){$!==-1&&(j.value[$]={...j.value[$],agent_status:v});const t=((D=n==null?void 0:n.data)==null?void 0:D.detail)??((M=n==null?void 0:n.data)==null?void 0:M.message)??(n==null?void 0:n.message)??"Не удалось изменить статус агента";return ne.value=typeof t=="string"?t:JSON.stringify(t),console.error("[useDialogs] toggleDialogAgentStatus error:",n),null}},upsertDialog:a=>{const l=a.id||a.session_id;if(!l)return;const $=j.value.findIndex(f=>f.id===l),v=$!==-1?j.value[$]:null,r=a.user_info||(v==null?void 0:v.user_info);let D=null;r&&(r.first_name||r.last_name?D=[r.first_name,r.last_name].filter(Boolean).join(" "):r.username&&(D=`@${r.username}`));const M=a.platform||(v==null?void 0:v.platform)||(l.startsWith("telegram:")?"telegram":void 0),n=M==="telegram"||l.startsWith("telegram:")?`Telegram #${l.replace("telegram:","")}`:"Диалог",t=D||(v==null?void 0:v.title)||n,o=Me({...v||{},id:l,title:t,last_message_preview:a.last_message_preview||a.content||(v==null?void 0:v.last_message_preview)||"",last_message_at:a.last_message_at||a.created_at||(v==null?void 0:v.last_message_at)||new Date().toISOString(),unread_count:a.is_new?((v==null?void 0:v.unread_count)??0)+1:(v==null?void 0:v.unread_count)??0,status:a.status||(v==null?void 0:v.status)||"NORMAL",agent_status:a.agent_status||(v==null?void 0:v.agent_status),created_at:a.created_at||(v==null?void 0:v.created_at)||new Date().toISOString(),updated_at:new Date().toISOString(),platform:M,user_info:r||(v==null?void 0:v.user_info)});$!==-1?j.value=[o,...j.value.filter((f,u)=>u!==$)]:j.value=[o,...j.value]},updateDialogStatus:(a,l)=>{const $=j.value.findIndex(v=>v.id===a);$!==-1&&(j.value[$]={...j.value[$],status:l})},updateLastMessage:(a,l,$)=>{const v=j.value.findIndex(r=>r.id===a);if(v!==-1){j.value[v]={...j.value[v],last_message_preview:l,last_message_at:$};const r=j.value.splice(v,1)[0];j.value.unshift(r)}},incrementUnread:a=>{const l=j.value.findIndex($=>$.id===a);l!==-1&&(j.value[l]={...j.value[l],unread_count:j.value[l].unread_count+1})},markAsRead:a=>{const l=j.value.findIndex($=>$.id===a);l!==-1&&(j.value[l]={...j.value[l],unread_count:0})},getDialogById:a=>j.value.find(l=>l.id===a),resolveDialogId:a=>{if(!a)return null;const l=String(a),$=j.value.find(r=>r.id===l);if($)return $.id;const v=j.value.find(r=>r.id.endsWith(`:${l}`));return(v==null?void 0:v.id)??l},clearDialogs:()=>{j.value=[],Ie.value=null,ne.value=null}}},F=nt({}),J=(e,s)=>{F[e]=[...s]},Le=O(!1),re=O(!1),me=O(!1),ve=O(null),te=O(null),Te=O(new Map),jt=(e,s)=>{const c=s.isUser??s.is_user,g=s.isAgent??s.is_agent;if(typeof c=="boolean")return c?"user":"agent";if(typeof g=="boolean")return g?"agent":"user";if(typeof e=="string"){const k=e.toLowerCase();if(["user","human","client","customer","visitor","requester"].includes(k))return"user";if(["manager","operator","admin","support"].includes(k))return"manager";if(["agent","assistant","bot","ai","system"].includes(k))return"agent"}return"agent"},Nt=e=>{if(typeof e=="string"){const s=e.toLowerCase();if(s.includes("image")||s.includes("photo")||s.includes("img"))return"image";if(s.includes("voice")||s.includes("audio")||s.includes("wav")||s.includes("mp3"))return"voice"}return"text"},Wt=e=>{if(typeof e!="string")return"sent";const s=e.toLowerCase();return s==="sending"?"sending":s==="failed"?"failed":s==="streaming"?"streaming":s==="done"?"done":"sent"},Bt=new Set(["tool","function","tool_result","function_result","tool_call","function_call","tool_use"]),Ut=new Set(["tool_result","tool_call","function_call","function_result","tool_use"]),Pt=e=>{const s=e.trim();if(s.length<20||!(s.startsWith("{")&&s.endsWith("}")||s.startsWith("[")&&s.endsWith("]")))return!1;try{const g=JSON.parse(s);if(typeof g=="object"&&g!==null)return!0}catch{if(/^\{\s*'[^']+'\s*:/.test(s))return!0}return!1},qe=(e,s)=>{var a;const c=(e==null?void 0:e.role)??(e==null?void 0:e.sender)??(e==null?void 0:e.author)??(e==null?void 0:e.from)??(e==null?void 0:e.direction);if(typeof c=="string"&&Bt.has(c.toLowerCase()))return null;const g=(e==null?void 0:e.type)??(e==null?void 0:e.message_type)??(e==null?void 0:e.content_type)??(e==null?void 0:e.kind);if(typeof g=="string"&&Ut.has(g.toLowerCase()))return null;const k=(e==null?void 0:e.content)??(e==null?void 0:e.text)??(e==null?void 0:e.message)??(e==null?void 0:e.body)??(e==null?void 0:e.payload)??((a=e==null?void 0:e.data)==null?void 0:a.content)??"";if(typeof k=="object"&&k!==null)return null;const I=typeof k=="string"?k:String(k);if(Pt(I))return null;const S=(e==null?void 0:e.dialog_id)??(e==null?void 0:e.dialogId)??(e==null?void 0:e.session_id)??(e==null?void 0:e.sessionId)??s,T=(e==null?void 0:e.id)??(e==null?void 0:e.message_id)??(e==null?void 0:e.messageId)??(e==null?void 0:e.uuid)??(e==null?void 0:e._id)??`${S}-${(e==null?void 0:e.created_at)??(e==null?void 0:e.createdAt)??Date.now()}`,w=jt(c,{isUser:e==null?void 0:e.isUser,is_user:e==null?void 0:e.is_user,isAgent:e==null?void 0:e.isAgent,is_agent:e==null?void 0:e.is_agent}),m=Nt((e==null?void 0:e.type)??(e==null?void 0:e.message_type)??(e==null?void 0:e.content_type)??(e==null?void 0:e.kind)??(e==null?void 0:e.media_type)),p=(e==null?void 0:e.created_at)??(e==null?void 0:e.createdAt)??(e==null?void 0:e.timestamp)??(e==null?void 0:e.time)??(e==null?void 0:e.created)??new Date().toISOString(),_=Wt(e==null?void 0:e.status),x=(e==null?void 0:e.duration_seconds)??(e==null?void 0:e.durationSeconds)??(e==null?void 0:e.duration),d=typeof x=="number"?x:Number.isFinite(Number(x))?Number(x):void 0;return{id:String(T),dialog_id:String(S),role:w,type:m,content:I,status:_,duration_seconds:d,created_at:String(p)}},tt=()=>{const e=Ke(),{updateDialogStatus:s,updateLastMessage:c,resolveDialogId:g}=xe(),k=n=>F[n]||[],I=async(n,t,o)=>{var u,h;if(!n||!t){console.warn("[useMessages] Missing agentId or dialogId:",{agentId:n,dialogId:t});return}Le.value=!0,te.value=null;let f=!1;try{const C=new URLSearchParams;o!=null&&o.before&&C.set("before",o.before),o!=null&&o.limit&&C.set("limit",String(o.limit));const L=C.toString(),E=encodeURIComponent(t),P=`agents/${n}/dialogs/${E}/messages${L?`?${L}`:""}`,b=await e(P,{method:"GET"});let W=[];Array.isArray(b)?(W=b,f=!1):b&&typeof b=="object"&&"messages"in b?(W=b.messages||[],f=b.has_more||!1):b&&typeof b=="object"&&"items"in b?(W=b.items||[],f=b.has_more||!1):b&&typeof b=="object"&&"data"in b?(W=b.data||[],f=b.has_more||!1):console.error("[useMessages] Unexpected response format:",b);const A=W.map(H=>qe(H,t)).filter(H=>H!==null),z=F[t]||[];o!=null&&o.before?J(t,[...A,...z]):J(t,A),Te.value.set(t,f)}catch(C){const L=((u=C==null?void 0:C.data)==null?void 0:u.detail)??((h=C==null?void 0:C.data)==null?void 0:h.message)??(C==null?void 0:C.message)??"Не удалось загрузить сообщения";te.value=typeof L=="string"?L:JSON.stringify(L)}finally{Le.value=!1}},S=async(n,t,o,f="text",u=!0)=>{var E,P;if(!n||!t||!o.trim())return null;re.value=!0,te.value=null;const h=`temp-${Date.now()}`,C={id:h,dialog_id:t,role:"user",type:f,content:o.trim(),status:"sending",created_at:new Date().toISOString()},L=F[t]||[];J(t,[...L,C]);try{const b={content:o.trim(),type:f},W=encodeURIComponent(t),A=await e(`agents/${n}/dialogs/${W}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:b}),z=F[t]||[],H=z.findIndex(X=>X.id===h);if(H!==-1){const X=[...z];X[H]={...X[H],status:"sent"},J(t,X)}if(c(t,o.trim().slice(0,100),A.created_at||new Date().toISOString()),u){const X=(A==null?void 0:A.id)||(A==null?void 0:A.message_id);X&&await l(n,t,X)}return A}catch(b){const W=F[t]||[],A=W.findIndex(H=>H.id===h);if(A!==-1){const H=[...W];H[A]={...H[A],status:"failed",error_message:(b==null?void 0:b.message)||"Ошибка отправки"},J(t,H)}const z=((E=b==null?void 0:b.data)==null?void 0:E.detail)??((P=b==null?void 0:b.data)==null?void 0:P.message)??(b==null?void 0:b.message)??"Не удалось отправить сообщение";return te.value=typeof z=="string"?z:JSON.stringify(z),null}finally{re.value=!1}},T=async(n,t,o,f=!0)=>{const u=F[t]||[],h=u.find(C=>C.id===o);!h||h.status!=="failed"||(J(t,u.filter(C=>C.id!==o)),await S(n,t,h.content,h.type,f))},w=async(n,t,o)=>{var C,L;if(!n||!t||!o.trim())return null;re.value=!0,te.value=null;const f=`temp-mgr-${Date.now()}`,u={id:f,dialog_id:t,role:"manager",type:"text",content:o.trim(),status:"sending",created_at:new Date().toISOString()},h=F[t]||[];J(t,[...h,u]);try{const E={content:o.trim()},P=encodeURIComponent(t);await e(`agents/${n}/dialogs/${P}/manager-message`,{method:"POST",headers:{"Content-Type":"application/json"},body:E});const b=F[t]||[],W=b.findIndex(A=>A.id===f);if(W!==-1){const A=[...b];A[W]={...A[W],status:"sent"},J(t,A)}return c(t,o.trim().slice(0,100),new Date().toISOString()),{...u,status:"sent"}}catch(E){const P=F[t]||[],b=P.findIndex(A=>A.id===f);if(b!==-1){const A=[...P];A[b]={...A[b],status:"failed",error_message:(E==null?void 0:E.message)||"Ошибка отправки"},J(t,A)}const W=((C=E==null?void 0:E.data)==null?void 0:C.detail)??((L=E==null?void 0:E.data)==null?void 0:L.message)??(E==null?void 0:E.message)??"Не удалось отправить сообщение менеджера";return te.value=typeof W=="string"?W:JSON.stringify(W),null}finally{re.value=!1}},m=(n,t,o="text")=>{const f=`temp-${Date.now()}`,u={id:f,dialog_id:n,role:"user",type:o,content:t.trim(),status:"sending",created_at:new Date().toISOString()},h=F[n]||[];return J(n,[...h,u]),re.value=!0,f},p=(n,t,o)=>{const f=F[n]||[],u=f.findIndex(h=>h.id===t);if(u!==-1){const h=[...f];h[u]={...h[u],status:"sent"},J(n,h)}re.value=!1},_=(n,t,o)=>{const f=F[n]||[],u=f.findIndex(h=>h.id===t);if(u!==-1){const h=[...f];h[u]={...h[u],status:"failed",error_message:o||"Ошибка отправки"},J(n,h)}re.value=!1,te.value=o||"Ошибка отправки"},x=(n,t)=>{me.value=!0;const o=`agent-${n}`;ve.value=o;const f={id:o,dialog_id:t,role:"agent",type:"text",content:"",status:"streaming",created_at:new Date().toISOString()},u=F[t]||[];J(t,[...u,f])},d=(n,t,o)=>{const f=`agent-${n}`,u=F[t]||[],h=u.findIndex(C=>C.id===f);if(h!==-1){const C=[...u];C[h]={...C[h],content:o,status:"done"},J(t,C)}me.value=!1,ve.value=null},a=(n,t,o)=>{const f=`agent-${n}`,u=F[t]||[],h=u.findIndex(C=>C.id===f);if(h!==-1){const C=[...u];C[h]={...C[h],content:`Ошибка: ${o}`,status:"failed",error_message:o},J(t,C)}me.value=!1,ve.value=null,te.value=o},l=async(n,t,o)=>{var C,L,E,P,b;me.value=!0,s(t,"IN_PROGRESS");const f=`agent-${Date.now()}`;ve.value=f;const u={id:f,dialog_id:t,role:"agent",type:"text",content:"",status:"streaming",created_at:new Date().toISOString()},h=F[t]||[];J(t,[...h,u]);try{const W=typeof window<"u"?localStorage.getItem("auth_token"):null,A=encodeURIComponent(t),z=await fetch(`/api/v1/agents/${n}/dialogs/${A}/messages/stream`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream",...W?{Authorization:`Bearer ${W}`}:{}},body:JSON.stringify({user_message_id:o})});if(!z.ok)throw new Error(`Stream error: ${z.status}`);const H=(C=z.body)==null?void 0:C.getReader();if(!H)throw new Error("No reader available");const X=new TextDecoder;let ee="";for(;;){const{done:Z,value:fe}=await H.read();if(Z)break;ee+=X.decode(fe,{stream:!0});const We=ee.split(`
`);ee=We.pop()||"";for(const Be of We)if(Be.startsWith("data: ")){const Ue=Be.slice(6);if(Ue==="[DONE]")continue;try{const se=JSON.parse(Ue);if(se.type==="delta"&&((L=se.data)!=null&&L.content)){const he=F[t]||[],ie=he.findIndex(Y=>Y.id===f);if(ie!==-1){const Y=[...he];Y[ie]={...Y[ie],content:Y[ie].content+se.data.content},J(t,Y)}}else if(se.type==="done"){const he=F[t]||[],ie=he.findIndex(Y=>Y.id===f);if(ie!==-1){const Y=[...he];Y[ie]={...Y[ie],id:((E=se.data)==null?void 0:E.message_id)||f,status:"done"},J(t,Y)}}else if(se.type==="error")throw new Error(((P=se.data)==null?void 0:P.error)||"Stream error")}catch(se){console.warn("Failed to parse SSE event:",se)}}}const ge=F[t]||[],le=ge.findIndex(Z=>Z.id===f||Z.status==="streaming");if(le!==-1&&ge[le].status==="streaming"){const Z=[...ge];Z[le]={...Z[le],status:"done"},J(t,Z)}const we=((b=ge[le])==null?void 0:b.content)||"";we&&c(t,we.slice(0,100),new Date().toISOString()),s(t,"NORMAL")}catch(W){console.error("Stream error:",W);const A=F[t]||[],z=A.findIndex(H=>H.id===f);if(z!==-1){const H=A.filter((X,ee)=>ee!==z);J(t,H)}s(t,"ERROR"),te.value=(W==null?void 0:W.message)||"Ошибка получения ответа агента"}finally{me.value=!1,ve.value=null}},$=(n,t)=>{const o=g(n)??n,f=F[o]||[];J(o,[...f,{...t,dialog_id:o}])},v=(n,t,o)=>{const f=g(n)??n,u=F[f]||[],h=u.findIndex(C=>C.id===t);if(h!==-1){const C=[...u];C[h]={...C[h],...o},J(f,C)}},r=n=>{const t=g(n)??n;delete F[t],Te.value.delete(t)},D=n=>Te.value.get(n)??!0,M=n=>{const t=(n==null?void 0:n.dialog_id)??(n==null?void 0:n.session_id),o=g(t);if(!o)return;const f=F[o]||[],u=qe({...n,dialog_id:o},o);if(!u||f.some(L=>L.id===u.id))return;const h=Date.now();f.some(L=>L.role===u.role&&L.content.trim()===u.content.trim()&&L.status!=="failed"&&h-new Date(L.created_at).getTime()<15e3)||(J(o,[...f,u]),c(o,u.content.slice(0,100),u.created_at))};return{isLoading:be(Le),isSending:be(re),isStreaming:be(me),streamingMessageId:be(ve),error:be(te),messagesMap:F,getMessages:k,dialogHasMore:D,fetchMessages:I,sendMessage:S,sendManagerMessage:w,retryMessage:T,addMessage:$,addIncomingMessage:M,updateMessage:v,clearMessages:r,createOptimisticMessage:m,markMessageSent:p,markMessageFailed:_,handleRunStart:x,handleRunResult:d,handleRunError:a,startAgentStream:l}},zt={maxAttempts:5,baseDelay:1e3,maxDelay:16e3},Ft=(e,s)=>{const c=xe(),g=tt(),{resolveDialogId:k}=c,I={...zt,...s==null?void 0:s.reconnectConfig},S=O("disconnected"),T=O(0),w=O(null),m=O(null),p=O(null);let _=null,x=null,d=null;const a=L=>{if(typeof window>"u")return null;const E=localStorage.getItem("auth_token");if(!E)return console.error("[WebSocket] No auth token found"),null;const P=window.location.protocol==="https:"?"wss:":"ws:",b=window.location.host;return`${P}//${b}/api/v1/agents/${L}/ws?token=${E}`},l=L=>{if(!_||_.readyState!==WebSocket.OPEN)return console.warn("[WebSocket] Cannot send - connection not open"),!1;try{return _.send(JSON.stringify(L)),!0}catch(E){return console.error("[WebSocket] Send error:",E),!1}},$=L=>{try{const P=JSON.parse(L.data);switch(P.type){case"message_created":{const b=P.data,W=b.dialog_id??b.session_id,A=k(W)??(W?String(W):null);if(!A){console.warn("[WebSocket] message_created without dialog_id/session_id");break}const z=typeof b.role=="string"?b.role.toLowerCase():"";if(["tool","function","tool_result","function_result","tool_call","function_call","tool_use"].includes(z)||typeof b.content=="object"&&b.content!==null)break;const X=A===p.value,ee=b.user_info,ge=(ee==null?void 0:ee.platform)||(A.startsWith("telegram:")?"telegram":void 0),le=typeof b.content=="string"?b.content:"";c.upsertDialog({id:A,session_id:A,last_message_preview:le,last_message_at:b.created_at,is_new:!X,platform:ge,user_info:ee});const Z=g.getMessages(A).find(fe=>fe.status==="sending"&&(fe.role==="user"||fe.role==="manager")&&fe.content.trim()===le.trim());Z?g.markMessageSent(A,Z.id,b.id):g.addIncomingMessage({...b,dialog_id:A}),X&&c.markAsRead(A);break}case"dialog_updated":{c.upsertDialog(P.data);break}case"run_start":{const{run_id:b,dialog_id:W}=P.data,A=k(W)??W;w.value=b,m.value=A,g.handleRunStart(b,A),c.updateDialogStatus(A,"IN_PROGRESS");break}case"run_result":{const{run_id:b,output:W,dialog_id:A}=P.data,z=k(A)??A,H=z===p.value;g.handleRunResult(b,z,W),c.upsertDialog({id:z,last_message_preview:W.slice(0,100),last_message_at:new Date().toISOString(),is_new:!H}),c.updateDialogStatus(z,"NORMAL"),H&&c.markAsRead(z),w.value===b&&(w.value=null,m.value=null);break}case"run_error":{const{run_id:b,error:W,dialog_id:A}=P.data,z=k(A)??A;g.handleRunError(b,z,W),c.updateDialogStatus(z,"ERROR"),w.value===b&&(w.value=null,m.value=null);break}case"ping":{l({type:"pong"}),v();break}case"error":{console.error("[WebSocket] Server error:",P.data.message);break}case"status":case"dialog_joined":case"dialog_left":break;default:console.warn("[WebSocket] Unknown message type:",P.type)}}catch(E){console.error("[WebSocket] Error parsing message:",E)}},v=()=>{d&&clearTimeout(d),d=setTimeout(()=>{console.warn("[WebSocket] No ping received in 60s, reconnecting..."),n()},6e4)},r=()=>{if(T.value>=I.maxAttempts){console.error("[WebSocket] Max reconnect attempts reached"),S.value="error";return}const L=Math.min(I.baseDelay*Math.pow(2,T.value),I.maxDelay);x=setTimeout(()=>{T.value++,D()},L)},D=()=>{const L=N(e);if(!L||typeof window>"u"){console.warn("[WebSocket] Cannot connect - no agent ID or not in browser");return}M(!1);const E=a(L);if(E){S.value="connecting";try{_=new WebSocket(E),_.onopen=()=>{S.value="connected",T.value=0,v()},_.onclose=P=>{S.value="disconnected",d&&(clearTimeout(d),d=null),P.code!==1e3&&P.code!==1008?r():P.code===1008&&(console.error("[WebSocket] Unauthorized - invalid token"),S.value="error")},_.onerror=P=>{console.error("[WebSocket] Error:",P),S.value="error"},_.onmessage=$}catch(P){console.error("[WebSocket] Connection error:",P),S.value="error",r()}}},M=(L=!0)=>{L&&x&&(clearTimeout(x),x=null),d&&(clearTimeout(d),d=null),_&&(_.close(1e3,"Client closed"),_=null),p.value=null,L&&(S.value="disconnected",T.value=0)},n=()=>{M(!1),T.value=0,D()},t=(L,E)=>l({type:"send_message",dialog_id:L,content:E}),o=L=>{const E=l({type:"join_dialog",dialog_id:L});return E&&(p.value=L),E},f=L=>{const E=l({type:"leave_dialog",dialog_id:L});return E&&p.value===L&&(p.value=null),E},u=()=>l({type:"get_status"});Q(()=>N(e),(L,E)=>{L!==E&&(L?D():M())},{immediate:(s==null?void 0:s.autoConnect)!==!1}),He(()=>{M()});const h=B(()=>S.value==="connected"),C=B(()=>S.value==="connecting");return{connectionState:S,isConnected:h,isConnecting:C,reconnectAttempts:T,connect:D,disconnect:M,reconnect:n,sendMessage:t,joinDialog:o,leaveDialog:f,getStatus:u}},qt={class:"flex-1 min-w-0"},Ht={class:"flex items-center gap-2"},Jt={key:0,class:"px-1.5 py-0.5 text-[10px] font-medium rounded bg-blue-100 text-blue-700"},Vt={key:0,class:"text-xs text-blue-500 truncate"},Gt={class:"text-xs text-slate-500 truncate mt-0.5"},Kt={class:"flex flex-col items-end gap-1 flex-shrink-0"},Xt={class:"text-xs text-slate-400"},Yt={key:0,class:"px-1.5 py-0.5 text-[10px] font-medium rounded bg-green-100 text-green-700 flex items-center gap-0.5"},Qt={key:1,class:"px-1.5 py-0.5 text-[10px] font-medium rounded bg-amber-100 text-amber-700 flex items-center gap-0.5"},Zt={key:0,class:"fixed inset-0 z-[110] flex items-center justify-center p-4"},es={class:"relative bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full"},ts={class:"flex gap-3 mt-4"},ss=["disabled"],ns={key:0,class:"fixed inset-0 z-[110] flex items-center justify-center p-4"},as={class:"relative bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full"},os={class:"flex gap-3"},ls=oe({__name:"DialogItem",props:{dialog:{},isSelected:{type:Boolean}},emits:["click","rename","delete"],setup(e,{emit:s}){const c=e,g=s,k=O(!1),I=O(null),S=O({x:0,y:0}),T=O(!1),w=O(""),m=O(null),p=O(!1);et(I,()=>{k.value=!1});const _=B(()=>{var t;return c.dialog.platform==="telegram"||((t=c.dialog.id)==null?void 0:t.startsWith("telegram:"))}),x=B(()=>{var t;return((t=c.dialog.user_info)==null?void 0:t.username)||null}),d=B(()=>{const t=c.dialog.user_info;return t!=null&&t.first_name||t!=null&&t.last_name?[t.first_name,t.last_name].filter(Boolean).join(" "):t!=null&&t.username?`@${t.username}`:_.value&&c.dialog.id?`Telegram #${c.dialog.id.replace("telegram:","")}`:"Диалог"}),a=B(()=>{if(!c.dialog.last_message_at)return"";const t=new Date(c.dialog.last_message_at),f=new Date().getTime()-t.getTime(),u=Math.floor(f/(1e3*60*60*24));return u===0?t.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}):u===1?"Вчера":u<7?t.toLocaleDateString("ru-RU",{weekday:"short"}):t.toLocaleDateString("ru-RU",{day:"numeric",month:"short"})}),l=B(()=>(c.dialog.agent_status??"active")==="active"),$=B(()=>{const t=c.dialog.status;return t==="IN_PROGRESS"&&!l.value?c.dialog.unread_count>0?"UNREAD":null:t==="IN_PROGRESS"?"IN_PROGRESS":t==="ERROR"?"ERROR":c.dialog.unread_count>0?"UNREAD":t==="NEW"?"NEW":null}),v=t=>{t.preventDefault(),S.value={x:t.clientX,y:t.clientY},k.value=!0},r=()=>{k.value=!1,w.value=c.dialog.title||"",T.value=!0,ye(()=>{var t,o;(t=m.value)==null||t.focus(),(o=m.value)==null||o.select()})},D=()=>{w.value.trim()&&(g("rename",c.dialog.id,w.value.trim()),T.value=!1)},M=()=>{k.value=!1,p.value=!0},n=()=>{g("delete",c.dialog.id),p.value=!1};return(t,o)=>{const f=ot("StatusIndicator");return y(),R("div",{class:"relative group",onContextmenu:Ee(v,["prevent"])},[i("button",{onClick:o[0]||(o[0]=u=>t.$emit("click")),class:V(["w-full px-4 py-3 flex items-start gap-3 text-left transition-colors",[e.isSelected?"bg-indigo-50":"hover:bg-slate-50"]])},[i("div",{class:V(["w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0",[_.value?e.isSelected?"bg-blue-100":"bg-blue-50":e.isSelected?"bg-indigo-100":"bg-slate-100"]])},[_.value?(y(),R("svg",{key:0,class:V(["w-5 h-5",[e.isSelected?"text-blue-600":"text-blue-500"]]),viewBox:"0 0 24 24",fill:"currentColor"},[...o[6]||(o[6]=[i("path",{d:"M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"},null,-1)])],2)):(y(),K(N(Se),{key:1,class:V(["w-5 h-5",[e.isSelected?"text-indigo-600":"text-slate-500"]])},null,8,["class"]))],2),i("div",qt,[i("div",Ht,[i("h3",{class:V(["text-sm font-semibold truncate",[e.isSelected?"text-indigo-900":"text-slate-900"]])},G(d.value),3),_.value?(y(),R("span",Jt," TG ")):q("",!0),$.value?(y(),K(f,{key:1,status:$.value,count:e.dialog.unread_count},null,8,["status","count"])):q("",!0)]),x.value?(y(),R("p",Vt," @"+G(x.value),1)):q("",!0),i("p",Gt,G(e.dialog.last_message_preview||"Нет сообщений"),1)]),i("div",Kt,[i("span",Xt,G(a.value),1),l.value?(y(),R("span",Yt,[...o[7]||(o[7]=[i("span",{class:"w-1.5 h-1.5 bg-green-500 rounded-full"},null,-1),pe(" Агент ",-1)])])):(y(),R("span",Qt,[U(N(Tt),{class:"w-3 h-3"}),o[8]||(o[8]=pe(" Пауза ",-1))]))])],2),i("button",{onClick:Ee(v,["stop"]),class:"absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-lg opacity-0 group-hover:opacity-100 hover:bg-slate-200 transition-opacity lg:block hidden"},[U(N(yt),{class:"w-4 h-4 text-slate-500"})]),(y(),K(De,{to:"body"},[U(ce,{"enter-active-class":"transition duration-100 ease-out","enter-from-class":"opacity-0 scale-95","enter-to-class":"opacity-100 scale-100","leave-active-class":"transition duration-75 ease-in","leave-from-class":"opacity-100 scale-100","leave-to-class":"opacity-0 scale-95"},{default:ae(()=>[k.value?(y(),R("div",{key:0,ref_key:"contextMenuRef",ref:I,class:"fixed bg-white rounded-xl shadow-lg border border-slate-200 py-1 z-[100] min-w-[160px]",style:Je({top:`${S.value.y}px`,left:`${S.value.x}px`})},[i("button",{onClick:r,class:"w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2"},[U(N(xt),{class:"w-4 h-4"}),o[9]||(o[9]=pe(" Переименовать ",-1))]),i("button",{onClick:M,class:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"},[U(N(ht),{class:"w-4 h-4"}),o[10]||(o[10]=pe(" Удалить ",-1))])],4)):q("",!0)]),_:1})])),(y(),K(De,{to:"body"},[U(ce,{name:"modal-fade"},{default:ae(()=>[T.value?(y(),R("div",Zt,[i("div",{class:"absolute inset-0 bg-black/50",onClick:o[1]||(o[1]=u=>T.value=!1)}),i("div",es,[o[11]||(o[11]=i("h3",{class:"text-lg font-bold text-slate-900 mb-4"},"Переименовать диалог",-1)),je(i("input",{"onUpdate:modelValue":o[2]||(o[2]=u=>w.value=u),type:"text",placeholder:"Название диалога",class:"w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent",onKeyup:at(D,["enter"]),ref_key:"renameInputRef",ref:m},null,544),[[Ne,w.value]]),i("div",ts,[i("button",{onClick:o[3]||(o[3]=u=>T.value=!1),class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors"}," Отмена "),i("button",{onClick:D,disabled:!w.value.trim(),class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors"}," Сохранить ",8,ss)])])])):q("",!0)]),_:1})])),(y(),K(De,{to:"body"},[U(ce,{name:"modal-fade"},{default:ae(()=>[p.value?(y(),R("div",ns,[i("div",{class:"absolute inset-0 bg-black/50",onClick:o[4]||(o[4]=u=>p.value=!1)}),i("div",as,[o[12]||(o[12]=i("h3",{class:"text-lg font-bold text-slate-900 mb-2"},"Удалить диалог?",-1)),o[13]||(o[13]=i("p",{class:"text-sm text-slate-500 mb-6"}," Это действие нельзя отменить. Все сообщения будут удалены. ",-1)),i("div",os,[i("button",{onClick:o[5]||(o[5]=u=>p.value=!1),class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors"}," Отмена "),i("button",{onClick:n,class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-bold text-white bg-red-600 hover:bg-red-700 transition-colors"}," Удалить ")])])])):q("",!0)]),_:1})]))],32)}}}),is=Ae(ls,[["__scopeId","data-v-1509f877"]]),rs={class:"h-full flex flex-col"},cs={class:"p-4 border-b border-slate-200"},us={class:"w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"},ds={class:"text-white font-bold text-sm"},gs={class:"flex-1 text-left min-w-0"},fs={class:"text-sm font-semibold text-slate-900 truncate"},ms={class:"text-xs text-slate-500"},vs={key:0,class:"absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-lg border border-slate-200 z-50 max-h-64 overflow-y-auto"},ps={class:"p-2"},ys=["onClick"],xs={class:"w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"},hs={class:"text-white font-bold text-xs"},bs={class:"text-sm font-medium truncate"},_s={key:0,class:"px-3 py-4 text-center text-sm text-slate-500"},ks={class:"px-4 py-3"},Ss={class:"relative"},$s={class:"flex-1 overflow-y-auto"},Ms={key:0,class:"flex items-center justify-center py-8"},Ds={key:1,class:"px-4 py-8 text-center"},Cs={class:"text-sm text-slate-500"},As=oe({__name:"DialogsSidebar",props:{agents:{},selectedAgentId:{},selectedDialogId:{},isLoading:{type:Boolean}},emits:["select-agent","select-dialog","create-dialog"],setup(e,{emit:s}){const c=e,g=s,{dialogs:k,isLoading:I,updateDialog:S,deleteDialog:T}=xe(),w=O(null),m=O(!1),p=O("");et(w,()=>{m.value=!1});const _=B(()=>c.agents.find(M=>M.id===c.selectedAgentId)),x=B(()=>{var M;return((M=_.value)==null?void 0:M.name)||"Выберите агента"}),d=B(()=>{var M;return $(((M=_.value)==null?void 0:M.name)||"")}),a=B(()=>{const M=c.agents.length;return M===1?"агент":M>=2&&M<=4?"агента":"агентов"}),l=B(()=>{if(!p.value.trim())return k.value;const M=p.value.toLowerCase();return k.value.filter(n=>{const t=n.title||"Диалог",o=n.last_message_preview||"";return t.toLowerCase().includes(M)||o.toLowerCase().includes(M)})}),$=M=>M?M.split(" ").map(n=>n.charAt(0)).join("").toUpperCase().slice(0,2):"?",v=M=>{m.value=!1,g("select-agent",M)},r=async(M,n)=>{c.selectedAgentId&&await S(c.selectedAgentId,M,{title:n})},D=async M=>{c.selectedAgentId&&await T(c.selectedAgentId,M)};return Q(()=>c.selectedAgentId,()=>{p.value=""}),(M,n)=>(y(),R("div",rs,[i("div",cs,[i("div",{class:"relative",ref_key:"dropdownRef",ref:w},[i("button",{onClick:n[0]||(n[0]=t=>m.value=!m.value),class:"w-full flex items-center gap-3 px-3 py-2.5 bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors"},[i("div",us,[i("span",ds,G(d.value),1)]),i("div",gs,[i("p",fs,G(x.value),1),i("p",ms,G(e.agents.length)+" "+G(a.value),1)]),U(N(bt),{class:V(["w-5 h-5 text-slate-400 transition-transform",{"rotate-180":m.value}])},null,8,["class"])]),U(ce,{"enter-active-class":"transition duration-150 ease-out","enter-from-class":"opacity-0 scale-95","enter-to-class":"opacity-100 scale-100","leave-active-class":"transition duration-100 ease-in","leave-from-class":"opacity-100 scale-100","leave-to-class":"opacity-0 scale-95"},{default:ae(()=>[m.value?(y(),R("div",vs,[i("div",ps,[(y(!0),R(ue,null,Oe(e.agents,t=>(y(),R("button",{key:t.id,onClick:o=>v(t.id),class:V(["w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors",[t.id===e.selectedAgentId?"bg-indigo-50 text-indigo-900":"hover:bg-slate-50 text-slate-700"]])},[i("div",xs,[i("span",hs,G($(t.name)),1)]),i("span",bs,G(t.name),1),t.id===e.selectedAgentId?(y(),K(N(Ye),{key:0,class:"w-4 h-4 text-indigo-600 ml-auto flex-shrink-0"})):q("",!0)],10,ys))),128)),e.agents.length===0?(y(),R("div",_s," Нет доступных агентов ")):q("",!0)])])):q("",!0)]),_:1})],512)]),i("div",ks,[i("div",Ss,[U(N(_t),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),je(i("input",{"onUpdate:modelValue":n[1]||(n[1]=t=>p.value=t),type:"text",placeholder:"Поиск диалогов...",class:"w-full pl-9 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"},null,512),[[Ne,p.value]])])]),i("div",$s,[e.isLoading||N(I)?(y(),R("div",Ms,[U(N($e),{class:"w-6 h-6 text-indigo-600 animate-spin"})])):l.value.length===0?(y(),R("div",Ds,[U(N(Se),{class:"w-12 h-12 text-slate-300 mx-auto mb-3"}),i("p",Cs,G(p.value?"Диалоги не найдены":"Нет диалогов"),1),!p.value&&e.selectedAgentId?(y(),R("button",{key:0,onClick:n[2]||(n[2]=t=>M.$emit("create-dialog")),class:"mt-3 text-sm text-indigo-600 hover:text-indigo-700 font-medium"}," Создать первый диалог ")):q("",!0)])):(y(),K(Ve,{key:2,tag:"div",class:"divide-y divide-slate-100",name:"dialog-list"},{default:ae(()=>[(y(!0),R(ue,null,Oe(l.value,t=>(y(),K(is,{key:t.id,dialog:t,"is-selected":t.id===e.selectedDialogId,onClick:o=>M.$emit("select-dialog",t.id),onRename:r,onDelete:D},null,8,["dialog","is-selected","onClick"]))),128))]),_:1}))])]))}}),ws=Ae(As,[["__scopeId","data-v-26ed367c"]]),Rs={class:"bg-white border-b border-slate-200 px-4 py-3 flex items-center gap-3 flex-shrink-0"},Is={key:0,class:"w-5 h-5 text-blue-600",viewBox:"0 0 24 24",fill:"currentColor"},Ls={key:1,class:"text-white font-bold text-sm"},Ts={class:"flex-1 min-w-0"},Es={class:"text-sm font-semibold text-slate-900 truncate"},Os={key:0,class:"text-xs text-blue-600 truncate"},js={class:"flex items-center gap-1.5 mt-0.5"},Ns={class:"text-xs text-slate-500"},Ws={class:"text-xs text-slate-500"},Bs={class:"flex items-center gap-2"},Us=["aria-checked","title"],Ps=oe({__name:"ChatHeader",props:{agent:{},dialog:{},isStreaming:{type:Boolean}},emits:["back"],setup(e){const s=e,{toggleDialogAgentStatus:c}=xe(),g=B(()=>{var m;return(((m=s.dialog)==null?void 0:m.agent_status)??"active")==="active"}),k=B(()=>{var m,p,_;return((m=s.dialog)==null?void 0:m.platform)==="telegram"||((_=(p=s.dialog)==null?void 0:p.id)==null?void 0:_.startsWith("telegram:"))}),I=B(()=>{var m,p;return((p=(m=s.dialog)==null?void 0:m.user_info)==null?void 0:p.username)||""}),S=B(()=>{var p,_;const m=(p=s.dialog)==null?void 0:p.user_info;return m!=null&&m.first_name||m!=null&&m.last_name?[m.first_name,m.last_name].filter(Boolean).join(" "):m!=null&&m.username?`@${m.username}`:k.value&&((_=s.dialog)!=null&&_.id)?`Telegram #${s.dialog.id.replace("telegram:","")}`:"Диалог"}),T=B(()=>{var p,_;const m=(p=s.dialog)==null?void 0:p.user_info;if(m!=null&&m.first_name){const x=m.first_name.charAt(0),d=((_=m.last_name)==null?void 0:_.charAt(0))||"";return(x+d).toUpperCase()}return m!=null&&m.username?m.username.charAt(0).toUpperCase():"?"}),w=()=>{var m;(m=s.dialog)!=null&&m.id&&c(s.agent.id,s.dialog.id)};return(m,p)=>(y(),R("div",Rs,[i("button",{onClick:p[0]||(p[0]=_=>m.$emit("back")),class:"lg:hidden p-2 -ml-2 rounded-lg text-slate-600 hover:bg-slate-100 transition-colors"},[U(N(kt),{class:"w-5 h-5"})]),i("div",{class:V(["w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0",[k.value?"bg-blue-100":"bg-gradient-to-br from-indigo-500 to-purple-600"]])},[k.value?(y(),R("svg",Is,[...p[1]||(p[1]=[i("path",{d:"M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"},null,-1)])])):(y(),R("span",Ls,G(T.value),1))],2),i("div",Ts,[i("h2",Es,G(S.value),1),k.value&&I.value?(y(),R("p",Os," @"+G(I.value),1)):q("",!0),i("div",js,[e.isStreaming&&g.value?(y(),R(ue,{key:0},[U(N($e),{class:"w-3 h-3 text-indigo-600 animate-spin"}),p[2]||(p[2]=i("span",{class:"text-xs text-indigo-600 font-medium"},"В работе...",-1))],64)):g.value?(y(),R(ue,{key:2},[p[4]||(p[4]=i("span",{class:"w-2 h-2 bg-green-500 rounded-full"},null,-1)),i("span",Ws,G(e.agent.name),1)],64)):(y(),R(ue,{key:1},[p[3]||(p[3]=i("span",{class:"w-2 h-2 bg-slate-400 rounded-full"},null,-1)),i("span",Ns,G(e.agent.name)+" · Выкл.",1)],64))])]),i("div",Bs,[i("button",{onClick:w,class:V(["relative w-11 h-6 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2",[g.value?"bg-indigo-600":"bg-slate-300"]]),role:"switch","aria-checked":g.value,title:g.value?"Выключить агента":"Включить агента"},[i("span",{class:V(["absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform",[g.value?"translate-x-5":"translate-x-0"]])},null,2)],10,Us)])]))}}),zs=["innerHTML"],Fs=["src"],qs={key:2,class:"flex items-center gap-3 min-w-[200px]"},Hs={class:"flex-1"},Js={key:3,class:"flex items-center gap-1 mt-1"},Vs={class:"text-[10px] text-slate-400"},Gs={key:2,class:"flex items-center gap-1"},Ks=oe({__name:"MessageBubble",props:{message:{}},emits:["retry","image-click"],setup(e){const s=e,c=new St({html:!1,linkify:!0,breaks:!0}),g=O(!1),k=O(0),I=O(null),S=B(()=>s.message.role==="agent"),T=B(()=>s.message.role==="manager"),w=B(()=>S.value||T.value),m=B(()=>T.value?"bg-emerald-600 text-white rounded-br-sm":S.value?"bg-indigo-600 text-white rounded-br-sm":"bg-white border border-slate-200 text-slate-900 rounded-bl-sm shadow-sm"),p=B(()=>s.message.type!=="text"?"":c.render(s.message.content)),_=B(()=>new Date(s.message.created_at).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})),x=B(()=>{const a=s.message.duration_seconds||0,l=Math.floor(a/60),$=a%60;return`${l}:${$.toString().padStart(2,"0")}`}),d=()=>{I.value||(I.value=new Audio(s.message.content),I.value.addEventListener("timeupdate",()=>{I.value&&(k.value=I.value.currentTime/I.value.duration*100)}),I.value.addEventListener("ended",()=>{g.value=!1,k.value=0})),g.value?I.value.pause():I.value.play(),g.value=!g.value};return(a,l)=>(y(),R("div",{class:V(["flex",[w.value?"justify-end":"justify-start"]])},[i("div",{class:V(["max-w-[85%] sm:max-w-[70%] lg:max-w-[60%]",[w.value?"order-1":"order-2"]])},[i("div",{class:V(["text-[11px] font-medium mb-1 px-1",[T.value?"text-right text-emerald-600":S.value?"text-right text-indigo-600":"text-left text-slate-500"]])},G(T.value?"Менеджер":S.value?"Агент":"Пользователь"),3),i("div",{class:V(["rounded-2xl px-4 py-2.5 relative",m.value])},[e.message.type==="text"?(y(),R("div",{key:0,class:V(["text-sm whitespace-pre-wrap break-words prose prose-sm max-w-none",[w.value?"prose-invert":""]]),innerHTML:p.value},null,10,zs)):e.message.type==="image"?(y(),R("img",{key:1,src:e.message.content,alt:"Image",class:"rounded-lg max-w-full cursor-pointer hover:opacity-90 transition-opacity",onClick:l[0]||(l[0]=$=>a.$emit("image-click",e.message.content))},null,8,Fs)):e.message.type==="voice"?(y(),R("div",qs,[i("button",{onClick:d,class:V(["w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 transition-colors",[w.value?"bg-white/20 hover:bg-white/30 text-white":"bg-slate-200 hover:bg-slate-300 text-slate-700"]])},[g.value?(y(),K(N(Et),{key:0,class:"w-5 h-5"})):(y(),K(N(Ot),{key:1,class:"w-5 h-5 ml-0.5"}))],2),i("div",Hs,[i("div",{class:V(["h-1 rounded-full overflow-hidden",[w.value?"bg-white/30":"bg-slate-300"]])},[i("div",{class:V(["h-full transition-all",[w.value?"bg-white":"bg-slate-600"]]),style:Je({width:`${k.value}%`})},null,6)],2),i("span",{class:V(["text-xs mt-1 block",[w.value?"text-white/70":"text-slate-500"]])},G(x.value),3)])])):q("",!0),e.message.status==="streaming"?(y(),R("div",Js,[...l[2]||(l[2]=[i("span",{class:"w-1.5 h-1.5 bg-current rounded-full animate-pulse opacity-60"},null,-1)])])):q("",!0)],2),i("div",{class:V(["flex items-center gap-2 mt-1 px-1",[w.value?"justify-end":"justify-start"]])},[i("span",Vs,G(_.value),1),w.value?(y(),R(ue,{key:0},[e.message.status==="sending"?(y(),K(N($e),{key:0,class:"w-3 h-3 text-slate-400 animate-spin"})):e.message.status==="sent"?(y(),K(N(Ye),{key:1,class:"w-3 h-3 text-slate-400"})):e.message.status==="failed"?(y(),R("div",Gs,[U(N(Qe),{class:"w-3 h-3 text-red-500"}),i("button",{onClick:l[1]||(l[1]=$=>a.$emit("retry")),class:"text-[10px] text-red-500 hover:text-red-600 font-medium"}," Повторить ")])):q("",!0)],64)):q("",!0)],2)],2)],2))}}),Xs=Ae(Ks,[["__scopeId","data-v-e3e7ac89"]]),Ys={class:"flex-1 flex items-center justify-center p-8"},Qs={class:"text-center max-w-sm"},Zs={class:"w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6"},en={class:"text-lg font-semibold text-slate-900 mb-2"},tn={class:"text-sm text-slate-500 mb-6"},st=oe({__name:"DialogsEmptyState",props:{type:{default:"no-dialog"},errorMessage:{}},emits:["create","retry"],setup(e){const s=e,c=B(()=>{switch(s.type){case"no-agent":return{icon:Se,title:"Выберите агента",description:"Выберите агента из списка слева, чтобы начать диалог.",showAction:!1,actionLabel:""};case"no-dialog":return{icon:It,title:"Выберите диалог",description:"Выберите существующий диалог или создайте новый, чтобы начать общение с агентом.",showAction:!0,actionLabel:"Новый диалог"};case"no-messages":return{icon:Se,title:"Начните диалог",description:"Напишите сообщение, чтобы начать общение с агентом.",showAction:!1,actionLabel:""};case"error":return{icon:Qe,title:"Ошибка загрузки",description:s.errorMessage||"Не удалось загрузить данные. Попробуйте обновить страницу.",showAction:!0,actionLabel:"Повторить"};default:return{icon:Se,title:"Нет данных",description:"Данные отсутствуют.",showAction:!1,actionLabel:""}}}),g=B(()=>c.value.icon),k=B(()=>c.value.title),I=B(()=>c.value.description),S=B(()=>c.value.showAction),T=B(()=>c.value.actionLabel);return(w,m)=>(y(),R("div",Ys,[i("div",Qs,[i("div",Zs,[(y(),K(lt(g.value),{class:"w-10 h-10 text-slate-400"}))]),i("h3",en,G(k.value),1),i("p",tn,G(I.value),1),S.value?(y(),R("button",{key:0,onClick:m[0]||(m[0]=p=>w.$emit("create")),class:"inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-semibold transition-colors"},[U(N($t),{class:"w-4 h-4"}),pe(" "+G(T.value),1)])):q("",!0)])]))}}),sn={key:0,class:"flex justify-center py-3"},nn={key:1,class:"flex justify-center py-3"},an={key:2,class:"h-full flex items-center justify-center"},on={key:4,class:"flex items-center gap-2 py-2 px-3 text-slate-500"},ln=["src"],rn=oe({__name:"MessagesFeed",props:{dialogId:{},messages:{},isLoading:{type:Boolean},isStreaming:{type:Boolean},hasMore:{type:Boolean}},emits:["load-more","retry"],setup(e){const s=e,c=O(null),g=O(!1),k=O(!0),I=O(null),S=O(!1),T=()=>{if(!c.value)return;const{scrollTop:d,scrollHeight:a,clientHeight:l}=c.value,$=a-d-l;k.value=$<100,k.value&&(g.value=!1)},w=(d=!0)=>{c.value&&(c.value.scrollTo({top:c.value.scrollHeight,behavior:d?"smooth":"auto"}),g.value=!1)},m=()=>{w(!0)};Q(()=>s.messages.length,(d,a)=>{if(d>a){!S.value&&a>0&&(S.value=!0);const l=s.messages[s.messages.length-1];k.value||(l==null?void 0:l.role)==="user"||(l==null?void 0:l.role)==="manager"?ye(()=>w(!1)):(l==null?void 0:l.role)==="agent"&&(g.value=!0)}}),Q(()=>s.dialogId,()=>{S.value=!1}),Q(()=>s.isStreaming,d=>{d&&k.value&&ye(()=>w(!1))});const p=d=>{I.value=d,document.body.style.overflow="hidden"},_=()=>{I.value=null,document.body.style.overflow=""},x=d=>{d.key==="Escape"&&I.value&&_()};return Ge(()=>{window.addEventListener("keydown",x),ye(()=>w(!1))}),He(()=>{window.removeEventListener("keydown",x),document.body.style.overflow=""}),(d,a)=>(y(),R("div",{ref_key:"scrollContainerRef",ref:c,class:"flex-1 overflow-y-auto px-4 py-4",onScroll:T},[e.hasMore&&!e.isLoading?(y(),R("div",sn,[i("button",{onClick:a[0]||(a[0]=l=>d.$emit("load-more")),class:"text-sm text-indigo-600 hover:text-indigo-700 font-medium"}," Загрузить ранние сообщения ")])):q("",!0),e.isLoading&&e.messages.length>0?(y(),R("div",nn,[U(N($e),{class:"w-5 h-5 text-indigo-600 animate-spin"})])):q("",!0),!e.isLoading&&e.messages.length===0?(y(),R("div",an,[U(st,{type:"no-messages"})])):(y(),K(Ve,{key:3,tag:"div",class:"space-y-4",name:S.value?"msg":"",css:S.value},{default:ae(()=>[(y(!0),R(ue,null,Oe(e.messages,l=>(y(),K(Xs,{key:l.id,message:l,onRetry:$=>d.$emit("retry",l.id),onImageClick:p},null,8,["message","onRetry"]))),128))]),_:1},8,["name","css"])),e.isStreaming?(y(),R("div",on,[...a[2]||(a[2]=[it('<div class="flex gap-1" data-v-50b57f6b><span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay:0ms;" data-v-50b57f6b></span><span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay:150ms;" data-v-50b57f6b></span><span class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay:300ms;" data-v-50b57f6b></span></div><span class="text-xs" data-v-50b57f6b>Агент печатает...</span>',2)])])):q("",!0),U(ce,{"enter-active-class":"transition duration-200 ease-out","enter-from-class":"opacity-0 translate-y-4","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition duration-150 ease-in","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-4"},{default:ae(()=>[g.value?(y(),R("button",{key:0,onClick:m,class:"fixed bottom-24 left-1/2 -translate-x-1/2 lg:left-auto lg:translate-x-0 lg:right-8 px-4 py-2 bg-indigo-600 text-white rounded-full text-sm font-medium shadow-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 z-10"},[U(N(wt),{class:"w-4 h-4"}),a[3]||(a[3]=pe(" Новые сообщения ",-1))])):q("",!0)]),_:1}),(y(),K(De,{to:"body"},[U(ce,{name:"lightbox-fade"},{default:ae(()=>[I.value?(y(),R("div",{key:0,class:"fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4",onClick:_},[i("button",{onClick:_,class:"absolute top-4 right-4 p-2 text-white/80 hover:text-white transition-colors"},[U(N(rt),{class:"w-6 h-6"})]),i("img",{src:I.value,class:"max-w-full max-h-full object-contain",onClick:a[1]||(a[1]=Ee(()=>{},["stop"]))},null,8,ln)])):q("",!0)]),_:1})]))],544))}}),cn=Ae(rn,[["__scopeId","data-v-50b57f6b"]]),un={class:"bg-white border-t border-slate-200 px-4 py-3 flex-shrink-0"},dn={key:0,class:"mb-3 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg flex items-center gap-2"},gn={class:"flex items-end gap-2"},fn=["disabled"],mn={class:"flex-1 relative"},vn=["disabled"],pn={disabled:!0,class:"p-2.5 rounded-xl text-slate-400 cursor-not-allowed transition-colors flex-shrink-0",title:"Голосовое сообщение (скоро)"},yn=["disabled"],xn={key:1,class:"mt-1 text-right"},hn=oe({__name:"MessageComposer",props:{isSending:{type:Boolean},isStreaming:{type:Boolean},agentEnabled:{type:Boolean}},emits:["send","attach-image"],setup(e,{emit:s}){const c=e,g=s,k=O(null),I=O(null),S=O(""),T=B(()=>S.value.trim().length>0&&S.value.length<=4e3&&!c.isSending&&!c.isStreaming),w=()=>{T.value&&(g("send",S.value.trim()),S.value="",ye(()=>{var d;p(),(d=k.value)==null||d.focus()}))},m=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),w())},p=()=>{k.value&&(k.value.style.height="auto",k.value.style.height=`${Math.min(k.value.scrollHeight,150)}px`)},_=()=>{var d;(d=I.value)==null||d.click()},x=d=>{var $;const a=d.target,l=($=a.files)==null?void 0:$[0];l&&g("attach-image",l),a.value=""};return Q(S,d=>{d||ye(p)}),(d,a)=>(y(),R("div",un,[e.agentEnabled?q("",!0):(y(),R("div",dn,[U(N(Mt),{class:"w-4 h-4 text-emerald-600 flex-shrink-0"}),a[1]||(a[1]=i("span",{class:"text-xs text-emerald-700"}," Режим менеджера. Сообщения будут отправлены от вашего имени. ",-1))])),i("div",gn,[i("button",{onClick:_,disabled:e.isSending||e.isStreaming,class:"p-2.5 rounded-xl text-slate-500 hover:text-slate-700 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex-shrink-0",title:"Прикрепить изображение"},[U(N(Rt),{class:"w-5 h-5"})],8,fn),i("input",{ref_key:"fileInputRef",ref:I,type:"file",accept:"image/*",class:"hidden",onChange:x},null,544),i("div",mn,[je(i("textarea",{ref_key:"textareaRef",ref:k,"onUpdate:modelValue":a[0]||(a[0]=l=>S.value=l),onKeydown:m,onInput:p,disabled:e.isSending||e.isStreaming,placeholder:"Напишите сообщение...",rows:"1",class:"w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm resize-none placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed transition-all",style:{maxHeight:"150px"}},null,40,vn),[[Ne,S.value]])]),i("button",pn,[U(N(Lt),{class:"w-5 h-5"})]),i("button",{onClick:w,disabled:!T.value,class:"p-2.5 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors flex-shrink-0",title:"Отправить"},[e.isSending?(y(),K(N($e),{key:0,class:"w-5 h-5 animate-spin"})):(y(),K(N(Dt),{key:1,class:"w-5 h-5"}))],8,yn)]),S.value.length>500?(y(),R("div",xn,[i("span",{class:V(["text-xs",S.value.length>4e3?"text-red-500":"text-slate-400"])},G(S.value.length)+" / 4000 ",3)])):q("",!0)]))}}),bn={class:"flex-1 flex flex-col h-full overflow-hidden"},_n=oe({__name:"ChatArea",props:{dialogId:{},agent:{},wsSendMessage:{type:Function},isWsConnected:{type:Boolean}},emits:["back"],setup(e){const s=e,{messagesMap:c,fetchMessages:g,sendMessage:k,sendManagerMessage:I,retryMessage:S,createOptimisticMessage:T,markMessageFailed:w,isLoading:m,isSending:p,isStreaming:_,dialogHasMore:x}=tt(),{markAsRead:d,getDialogById:a}=xe(),l=B(()=>c[s.dialogId]??[]),$=B(()=>a(s.dialogId)),v=B(()=>x(s.dialogId)),r=B(()=>{var f;return(((f=$.value)==null?void 0:f.agent_status)??"active")==="active"}),D=async()=>{await g(s.agent.id,s.dialogId,{limit:50}),d(s.dialogId)},M=async()=>{const f=l.value[0];f&&await g(s.agent.id,s.dialogId,{before:f.id,limit:30})},n=async f=>{if(!r.value){await I(s.agent.id,s.dialogId,f);return}if(s.isWsConnected&&s.wsSendMessage){const u=T(s.dialogId,f,"text");s.wsSendMessage(s.dialogId,f)||w(s.dialogId,u,"WebSocket отключен")}else await k(s.agent.id,s.dialogId,f,"text",r.value)},t=async f=>{},o=async f=>{await S(s.agent.id,s.dialogId,f,r.value)};return Q(()=>s.dialogId,()=>D(),{immediate:!0}),(f,u)=>(y(),R("div",bn,[U(Ps,{agent:e.agent,dialog:$.value,"is-streaming":N(_),onBack:u[0]||(u[0]=h=>f.$emit("back"))},null,8,["agent","dialog","is-streaming"]),U(cn,{"dialog-id":e.dialogId,messages:l.value,"is-loading":N(m),"is-streaming":N(_),"has-more":v.value,onLoadMore:M,onRetry:o},null,8,["dialog-id","messages","is-loading","is-streaming","has-more"]),U(hn,{"is-sending":N(p),"is-streaming":N(_),"agent-enabled":r.value,onSend:n,onAttachImage:t},null,8,["is-sending","is-streaming","agent-enabled"])]))}}),kn={class:"min-h-screen bg-slate-50"},Sn={key:0,class:"lg:hidden bg-white border-b border-slate-200 px-4 py-3"},$n={class:"flex items-center justify-between"},Mn={class:"flex"},Dn={key:0,class:"lg:hidden fixed inset-0 z-50 w-full"},Cn={class:"flex-1 flex h-[calc(100vh-57px)] lg:h-screen overflow-hidden"},ta=oe({__name:"dialogs",setup(e){const{isAuthenticated:s}=gt(),c=O(!1),g=O(!1),k=ct(),I=ut(),{agents:S,isLoading:T,fetchAgents:w}=dt(),{fetchDialogs:m,createDialog:p}=xe(),_=O(k.query.agentId||null),x=O(k.query.dialogId||null),d=O(!x.value),a=O(null),{isConnected:l,sendMessage:$,joinDialog:v,leaveDialog:r}=Ft(B(()=>_.value)),D=B(()=>{if(_.value)return S.value.find(u=>u.id===_.value)}),M=async u=>{_.value=u,x.value=null,I.push({query:{...k.query,agentId:u,dialogId:void 0}}),await m(u)},n=u=>{x.value=u,d.value=!1,I.push({query:{...k.query,dialogId:u}})};Q(()=>k.query.agentId,u=>{_.value=typeof u=="string"?u:null}),Q(()=>k.query.dialogId,u=>{x.value=typeof u=="string"?u:null,x.value&&(d.value=!1)}),Q([l,x],([u,h])=>{if(!u){a.value=null;return}a.value&&a.value!==h&&(r(a.value),a.value=null),h&&a.value!==h&&(v(h)?a.value=h:console.warn("[Page] Failed to join dialog (WebSocket not ready):",h))},{immediate:!0});const t=async()=>{if(!_.value){S.value.length>0&&await M(S.value[0].id);return}const u=await p(_.value);u&&n(u.id)},o=()=>{c.value=!1,f()},f=async()=>{await w(),_.value?await m(_.value):S.value.length>0&&await M(S.value[0].id)};return Q(s,u=>{u&&f()}),Ge(()=>{s.value?f():c.value=!0}),(u,h)=>(y(),R("div",kn,[d.value||!x.value?(y(),R("div",Sn,[i("div",$n,[h[5]||(h[5]=i("div",{class:"flex items-center gap-2"},[i("div",{class:"w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center"},[i("span",{class:"text-white font-bold text-xs"},"М")]),i("span",{class:"text-slate-900 font-bold"},"Диалоги")],-1)),i("button",{onClick:h[0]||(h[0]=C=>g.value=!g.value),class:"p-2 rounded-lg text-slate-600 hover:bg-slate-100"},[U(N(Ct),{class:"h-5 w-5"})])])])):q("",!0),i("div",Mn,[U(Pe,{class:"hidden lg:block"}),g.value?(y(),R("div",{key:0,class:"lg:hidden fixed inset-0 z-40 bg-black bg-opacity-50",onClick:h[1]||(h[1]=C=>g.value=!1)})):q("",!0),U(ce,{"enter-active-class":"transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1)","enter-from-class":"-translate-x-full opacity-0 scale-95","enter-to-class":"translate-x-0 opacity-100 scale-100","leave-active-class":"transition-all duration-400 ease-in","leave-from-class":"translate-x-0 opacity-100 scale-100","leave-to-class":"-translate-x-full opacity-0 scale-95"},{default:ae(()=>[g.value?(y(),R("div",Dn,[U(Pe,{onClose:h[2]||(h[2]=C=>g.value=!1)})])):q("",!0)]),_:1}),i("main",Cn,[i("div",{class:V(["w-full lg:w-80 xl:w-96 flex-shrink-0 border-r border-slate-200 bg-white",!d.value&&x.value?"hidden lg:flex lg:flex-col":"flex flex-col"])},[U(ws,{agents:N(S),"selected-agent-id":_.value,"selected-dialog-id":x.value,"is-loading":N(T),onSelectAgent:M,onSelectDialog:n,onCreateDialog:t},null,8,["agents","selected-agent-id","selected-dialog-id","is-loading"])],2),i("div",{class:V(["flex-1 flex flex-col bg-slate-50",d.value&&x.value?"hidden lg:flex":"flex"])},[x.value&&D.value?(y(),K(_n,{key:x.value,"dialog-id":x.value,agent:D.value,"ws-send-message":N($),"is-ws-connected":N(l),onBack:h[3]||(h[3]=C=>d.value=!0)},null,8,["dialog-id","agent","ws-send-message","is-ws-connected"])):(y(),K(st,{key:1,type:"no-dialog",onCreate:t}))],2)])]),U(At,{"is-open":c.value,onClose:h[4]||(h[4]=C=>c.value=!1),onAuthenticated:o},null,8,["is-open"])]))}});export{ta as default};
