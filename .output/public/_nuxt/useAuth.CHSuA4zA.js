import{u as M,g as P}from"./useApiFetch.B9YviUBz.js";import{e as L,r as x,s as E,i as D,g as $,c as U}from"./authSessionManager.BK0upO_P.js";import{B as I,L as J,bg as f,k as p}from"./entry.CBkKRCnV.js";const k=s=>{var v,y;const n=(s==null?void 0:s.status)||(s==null?void 0:s.statusCode)||((v=s==null?void 0:s.response)==null?void 0:v.status)||0,a=(s==null?void 0:s.data)||((y=s==null?void 0:s.response)==null?void 0:y._data),u=(a==null?void 0:a.error)||"",i=a==null?void 0:a.details,r=a==null?void 0:a.retry_after,l=u||(n===403?"forbidden":"")||(n===502?"bad_gateway":"")||(n===503?"service_unavailable":"")||(n===504?"gateway_timeout":"")||(!s.response&&!s.data&&s.message&&(s.message.includes("fetch")||s.message.includes("network")||s.message.includes("Failed to fetch"))?"network_error":"")||"unknown_error",m=P(s,"Произошла ошибка. Попробуйте позже.");return{error:l,message:m,details:i,retry_after:r}},R=s=>{try{const n=s.split(".");if(n.length!==3)return null;const u=n[1].replace(/-/g,"+").replace(/_/g,"/"),i=atob(u);return JSON.parse(i)}catch(n){return console.error("Failed to decode JWT token:",n),null}},C=s=>D(s),T=s=>!(!s||s.split(".").length!==3||C(s)),W=p(null),z=p(null),V=p(null),B=p(null),G=p(!1),K=p(null);let b=!1,d=null;const Q=()=>{const s=M(),n=W,a=z,u=V,i=B,r=G,l=K,m=async t=>{try{r.value=!0,l.value=null;const e=await s("/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:t});if(n.value=e.token,a.value=null,e.user){const o={...e.user,scopes:Array.isArray(e.user.scopes)?e.user.scopes:[]};u.value=o}return e.tenant&&(i.value=e.tenant),E(e.token),console.log("Register response structure:",{has_token:!!e.token,has_user:!!e.user,has_tenant:!!e.tenant}),e.token&&await g(),e}catch(e){const o=k(e);let c=o.message;if(o.details){const _=Object.entries(o.details).map(([w,A])=>`${w}: ${A.join(", ")}`).join("; ");c=`${c}. ${_}`}throw l.value=c,e.apiError=o,e}finally{r.value=!1}},v=async t=>{try{r.value=!0,l.value=null;const e=await s("/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:t});if(n.value=e.token,a.value=null,e.user){const o={...e.user,scopes:Array.isArray(e.user.scopes)?e.user.scopes:[]};u.value=o}return e.tenant&&(i.value=e.tenant),E(e.token),console.log("Login response structure:",{has_token:!!e.token,has_user:!!e.user,has_tenant:!!e.tenant}),e.token&&await g(),e}catch(e){const o=k(e);let c=o.message;if(o.details){const _=Object.entries(o.details).map(([w,A])=>`${w}: ${A.join(", ")}`).join("; ");c=`${c}. ${_}`}throw l.value=c,e.apiError=o,e}finally{r.value=!1}},y=async t=>{try{r.value=!0,l.value=null;const e=await s("/auth/token",{method:"POST",headers:{"x-api-key":t,"Content-Type":"application/json"},body:{api_key:t}});return n.value=e.token,a.value=null,E(e.token),console.log("API Key token response structure:",{has_token:!!e.token,full_response:e}),e}catch(e){const o=k(e);throw l.value=o.message,e.apiError=o,e}finally{r.value=!1}},g=async()=>{{const t=await L();if(!t.token)return t.shouldLogout&&h(!1),null;n.value=t.token,a.value=null}if(!n.value||!T(n.value))return null;try{const t=await s("/auth/me",{method:"GET"});if(t.user){const e={...t.user,scopes:Array.isArray(t.user.scopes)?t.user.scopes:[]};u.value=e}return t.tenant&&(i.value=t.tenant),t}catch(t){const e=k(t);return console.error("Failed to fetch current user:",e),null}},S=()=>{n.value=$(),a.value=null},h=t=>{n.value=null,a.value=null,u.value=null,i.value=null,b=!1,d=null,U(),t&&(window.location.href="/")},j=async()=>{r.value=!0,l.value=null;try{const t=await x();return t.success?(S(),!0):(t.shouldLogout&&h(!1),!1)}finally{r.value=!1}},F=async()=>{try{await s("/auth/logout",{method:"POST"})}catch{}finally{h(!0),l.value=null}},O=async()=>{if(!b){if(d){await d;return}d=(async()=>{S();const t=await L();if(t.token)n.value=t.token,a.value=null;else if(t.shouldLogout){h(!1);return}n.value&&T(n.value)&&await g(),b=!0})(),await d,d=null}};return I(()=>{O()}),{token:f(n),refreshToken:f(a),user:f(u),tenant:f(i),isLoading:f(r),error:f(l),register:m,login:v,loginWithApiKey:y,refreshAccessToken:j,logout:F,fetchCurrentUser:g,isAuthenticated:J(()=>{{const t=$();t!==n.value&&(n.value=t)}return n.value?(T(n.value)||j().catch(()=>{h(!1)}),!0):!1}),decodeToken:t=>t?R(t):null,isTokenExpired:t=>t?C(t):!0,isTokenValid:t=>T(t)}};export{Q as u};
