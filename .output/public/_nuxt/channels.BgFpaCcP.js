import{_ as G}from"./AgentPageShell.vue.OnHAWrZH.js";import{m as B,f as P,o as l,c as d,F as H,n as h,T as D,b as f,w as $,p as c,q as E,s as z,a as e,u as o,X as J,v as O,x as W,d as L,t as A,k as v,_ as K,y as R,z as U,A as I}from"./entry.CVvpXMAV.js";import{u as X}from"./useAgentEditorStore.DYCdO3fc.js";import{u as Z}from"./usePermissions.LMwBn15y.js";import{u as Q,a as Y}from"./useAuth.Bu6P1IiJ.js";import{L as j}from"./loader-2.CJ85gz1d.js";import{C as ee}from"./check.nYYGxIUw.js";import{T as te}from"./trash-2.Dzc9Rnwm.js";import{S as se}from"./send.ccOK7jhK.js";import{M as N}from"./message-square.0RgVcxgB.js";import"./AuthModal.vue.B2CHdnIo.js";import"./eye.CUTpVi36.js";import"./alert-circle.DxAvbiuF.js";import"./useAgents.BVvSzsfX.js";import"./index.Dnmbk6A8.js";const le={class:"flex items-center justify-between shrink-0 px-6 py-4 border-b border-slate-200"},oe={class:"flex-1 overflow-y-auto px-6 py-6 space-y-8"},ae=["disabled"],ne={key:0,class:"text-sm text-red-600"},de={key:1,class:"text-sm text-green-600 font-medium"},re={class:"pt-6 border-t border-slate-200"},ie=["disabled"],ue={key:0,class:"mt-2 text-sm text-red-600"},pe={key:0,class:"fixed inset-0 z-[70] flex items-center justify-center p-4","aria-modal":"true",role:"alertdialog"},me={class:"relative bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full border border-slate-200"},ce={class:"flex gap-3"},fe=["disabled"],be=B({__name:"ChannelEditSheet",props:{open:{type:Boolean},agentId:{},currentToken:{}},emits:["update:open","saved","deleted"],setup(k,{emit:y}){const i=k,r=y,T=Q(),{token:_}=Y(),b=v(""),u=v(!1),x=v(null),w=v(!1),m=v(!1),s=v(null),g=v(!1),C=/^\d{9,12}:[A-Za-z0-9_-]{30,50}$/,V=p=>C.test(p.trim());P(()=>[i.open,i.currentToken],([p,t])=>{p&&(b.value=t??"",x.value=null,w.value=!1,s.value=null)},{immediate:!0});const F=async()=>{var t,a;const p=b.value.trim();if(!(!i.agentId||!p)){if(!V(p)){x.value="Неверный формат токена. Пример: 7123456789:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw";return}u.value=!0,x.value=null,w.value=!1;try{await T(`/agents/${i.agentId}/channels`,{method:"POST",headers:{Authorization:`Bearer ${_.value}`,"Content-Type":"application/json"},body:{type:"Telegram_Bot",telegram_bot_token:p,whatsapp_phone:null}}),w.value=!0,r("saved")}catch(n){const S=((t=n==null?void 0:n.data)==null?void 0:t.detail)??((a=n==null?void 0:n.data)==null?void 0:a.message)??(n==null?void 0:n.message)??"Не удалось сохранить";x.value=typeof S=="string"?S:JSON.stringify(S)}finally{u.value=!1}}},M=()=>{g.value=!0,s.value=null},q=async()=>{var p,t;if(i.agentId){m.value=!0,s.value=null;try{await T(`/agents/${i.agentId}/channels/telegram`,{method:"DELETE",headers:{Authorization:`Bearer ${_.value}`}}),g.value=!1,r("deleted"),r("update:open",!1)}catch(a){const n=((p=a==null?void 0:a.data)==null?void 0:p.detail)??((t=a==null?void 0:a.data)==null?void 0:t.message)??(a==null?void 0:a.message)??"Не удалось удалить";s.value=typeof n=="string"?n:JSON.stringify(n)}finally{m.value=!1}}};return(p,t)=>(l(),d(H,null,[(l(),h(D,{to:"body"},[f(E,{name:"overlay-fade"},{default:$(()=>[k.open?(l(),d("div",{key:0,class:"fixed inset-0 z-[60] bg-black/40","aria-hidden":"true",onClick:t[0]||(t[0]=a=>r("update:open",!1))})):c("",!0)]),_:1}),f(E,{name:"panel-slide"},{default:$(()=>[k.open?(l(),d("div",{key:0,class:"fixed right-0 top-0 bottom-0 z-[61] w-full max-w-md sm:max-w-lg bg-white shadow-xl border-l border-slate-200 flex flex-col max-h-full overflow-hidden","aria-modal":"true",role:"dialog",onClick:t[3]||(t[3]=z(()=>{},["stop"]))},[e("div",le,[t[6]||(t[6]=e("div",null,[e("h2",{class:"text-lg font-bold text-slate-900"},"Настройки Telegram"),e("p",{class:"text-sm text-slate-500 mt-0.5"},"Изменить токен или отключить канал")],-1)),e("button",{type:"button","aria-label":"Закрыть",class:"p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors",onClick:t[1]||(t[1]=a=>r("update:open",!1))},[f(o(J),{class:"h-5 w-5"})])]),e("div",oe,[e("section",null,[t[8]||(t[8]=e("h3",{class:"text-sm font-bold text-slate-900 mb-2"},"Токен бота",-1)),t[9]||(t[9]=e("p",{class:"text-xs text-slate-500 mb-3"}," Введите новый токен от @BotFather, чтобы обновить подключение. ",-1)),e("form",{onSubmit:z(F,["prevent"]),class:"space-y-3"},[O(e("input",{"onUpdate:modelValue":t[2]||(t[2]=a=>b.value=a),type:"text",autocomplete:"off",placeholder:"7123456789:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw",class:"w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[W,b.value]]),e("button",{type:"submit",disabled:!b.value.trim()||u.value,class:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-indigo-600 text-white rounded-xl text-sm font-bold hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[u.value?(l(),h(o(j),{key:0,class:"w-4 h-4 animate-spin"})):(l(),h(o(ee),{key:1,class:"w-4 h-4"})),t[7]||(t[7]=L(" Сохранить токен ",-1))],8,ae),x.value?(l(),d("p",ne,A(x.value),1)):c("",!0),w.value?(l(),d("p",de,"Токен сохранён.")):c("",!0)],32)]),e("section",re,[t[10]||(t[10]=e("h3",{class:"text-sm font-bold text-slate-900 mb-2"},"Удалить подключение",-1)),t[11]||(t[11]=e("p",{class:"text-xs text-slate-500 mb-4"}," Канал Telegram будет отключён от агента. Подключить его можно снова в любой момент. ",-1)),e("button",{type:"button",disabled:m.value,class:"w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-white border border-red-200 text-red-600 rounded-xl text-sm font-bold hover:bg-red-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",onClick:M},[m.value?(l(),h(o(j),{key:0,class:"w-4 h-4 animate-spin"})):(l(),h(o(te),{key:1,class:"w-4 h-4"})),L(" "+A(m.value?"Удаление...":"Удалить подключение"),1)],8,ie),s.value?(l(),d("p",ue,A(s.value),1)):c("",!0)])])])):c("",!0)]),_:1})])),(l(),h(D,{to:"body"},[f(E,{name:"modal-fade"},{default:$(()=>[g.value?(l(),d("div",pe,[e("div",{class:"absolute inset-0 bg-black/50",onClick:t[4]||(t[4]=a=>g.value=!1)}),e("div",me,[t[12]||(t[12]=e("h3",{class:"text-lg font-bold text-slate-900 mb-2"},"Удалить канал Telegram?",-1)),t[13]||(t[13]=e("p",{class:"text-sm text-slate-500 mb-6"}," Подключение будет отключено. Вы сможете подключить канал снова позже. ",-1)),e("div",ce,[e("button",{type:"button",class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors",onClick:t[5]||(t[5]=a=>g.value=!1)}," Отмена "),e("button",{type:"button",disabled:m.value,class:"flex-1 px-4 py-2.5 rounded-xl text-sm font-bold text-white bg-red-600 hover:bg-red-700 disabled:opacity-50 transition-colors",onClick:q}," Удалить ",8,fe)])])])):c("",!0)]),_:1})]))],64))}}),xe=K(be,[["__scopeId","data-v-1b10b77f"]]),ge={class:"bg-background rounded-md border border-border p-4 sm:p-5 space-y-5"},ve={key:0,class:"flex justify-center py-12"},he={key:1,class:"space-y-5"},ye={class:"flex items-start justify-between"},we={class:"flex gap-4"},ke={class:"w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-md flex items-center justify-center"},_e={key:0,class:"mt-3"},Ce={class:"p-4 border border-slate-100 rounded-lg bg-slate-50/50 opacity-60"},Te={class:"flex items-start justify-between"},$e={class:"flex gap-4"},Ae={class:"w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-md flex items-center justify-center"},Se={class:"p-4 border border-slate-100 rounded-lg bg-slate-50/50 opacity-60"},Ee={class:"flex items-start justify-between"},je={class:"flex gap-4"},Be={class:"w-12 h-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-md flex items-center justify-center"},De=B({__name:"AgentChannelsPanel",setup(k){const y=X(),{agent:i,telegramChannel:r,isLoadingChannels:T}=R(y),{canEditAgents:_}=Z(),{success:b}=U(),u=v(!1);P(i,m=>{m&&y.ensureChannelsLoaded()},{immediate:!0});const x=async()=>{await y.fetchChannels(),u.value=!1,b("Канал обновлён","Настройки Telegram успешно сохранены")},w=async()=>{await y.fetchChannels(),u.value=!1,b("Канал удалён","Подключение Telegram отключено")};return(m,s)=>{var g;return l(),d("div",ge,[s[9]||(s[9]=e("div",{class:"mb-6"},[e("h3",{class:"text-lg font-bold text-slate-900"},"Каналы связи"),e("p",{class:"text-sm text-slate-500 mt-1"}," Подключите мессенджеры и другие каналы для общения с вашими клиентами через агента. ")],-1)),o(T)?(l(),d("div",ve,[f(o(j),{class:"w-8 h-8 animate-spin text-indigo-600"})])):(l(),d("div",he,[e("div",{class:I(["p-4 border rounded-lg transition-all",[o(r)?"border-indigo-100 bg-indigo-50/30":"border-slate-100 bg-white hover:border-slate-200"]])},[e("div",ye,[e("div",we,[e("div",ke,[f(o(se),{class:"w-6 h-6 text-white"})]),e("div",null,[s[3]||(s[3]=e("h4",{class:"font-bold text-slate-900"},"Telegram Bot",-1)),s[4]||(s[4]=e("p",{class:"text-sm text-slate-500 mt-1"}," Подключите Telegram-бота для автоматического общения с клиентами. ",-1)),o(r)?(l(),d("div",_e,[e("span",{class:I(["px-2 py-0.5 rounded-full text-[10px] font-bold uppercase",o(r).webhook_enabled?"bg-green-100 text-green-700":"bg-yellow-100 text-yellow-700"])},A(o(r).webhook_enabled?"Активен":"Неактивен"),3)])):c("",!0)])]),o(_)&&o(r)?(l(),d("button",{key:0,onClick:s[0]||(s[0]=C=>u.value=!0),class:"px-4 py-2 rounded-md text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors"}," Настроить ")):o(_)?(l(),d("button",{key:1,onClick:s[1]||(s[1]=C=>u.value=!0),class:"px-4 py-2 rounded-md text-sm font-bold bg-slate-100 text-slate-600 hover:bg-slate-200 transition-colors"}," Подключить ")):c("",!0)])],2),e("div",Ce,[e("div",Te,[e("div",$e,[e("div",Ae,[f(o(N),{class:"w-6 h-6 text-white"})]),s[5]||(s[5]=e("div",null,[e("h4",{class:"font-bold text-slate-900"},"WhatsApp"),e("p",{class:"text-sm text-slate-500 mt-1"}," Интеграция с WhatsApp Business API для общения с клиентами. ")],-1))]),s[6]||(s[6]=e("span",{class:"px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-200 text-slate-500 uppercase"}," Скоро ",-1))])]),e("div",Se,[e("div",Ee,[e("div",je,[e("div",Be,[f(o(N),{class:"w-6 h-6 text-white"})]),s[7]||(s[7]=e("div",null,[e("h4",{class:"font-bold text-slate-900"},"Виджет на сайт"),e("p",{class:"text-sm text-slate-500 mt-1"}," Встраиваемый чат-виджет для вашего сайта. ")],-1))]),s[8]||(s[8]=e("span",{class:"px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-200 text-slate-500 uppercase"}," Скоро ",-1))])])])),o(i)?(l(),h(xe,{key:2,open:u.value,"agent-id":o(i).id,"current-token":(g=o(r))==null?void 0:g.bot_token,"onUpdate:open":s[2]||(s[2]=C=>u.value=C),onSaved:x,onDeleted:w},null,8,["open","agent-id","current-token"])):c("",!0)])}}}),Re=B({__name:"channels",setup(k){return(y,i)=>(l(),h(G,{title:"Каналы","hide-actions":!0},{default:$(()=>[f(De)]),_:1}))}});export{Re as default};
